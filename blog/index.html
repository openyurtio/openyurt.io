<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenYurt Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/opensearch.xml"><title data-react-helmet="true">Blog | OpenYurt</title><meta data-react-helmet="true" property="og:title" content="Blog | OpenYurt"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://openyurt.io/blog"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/openyurt.ico"><link data-react-helmet="true" rel="canonical" href="https://openyurt.io/blog"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/zh/blog" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/blog" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4691cb76.css">
<link rel="preload" href="/assets/js/runtime~main.043f6912.js" as="script">
<link rel="preload" href="/assets/js/main.6045179a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">â­ï¸ If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! â­ï¸</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">OpenYurt</b></a><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/">v0.5.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next</a></li><li><a class="dropdown__link" href="/docs/">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ğŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ğŸŒ</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/How-to-use-yurtctl-convert-revert">Seamless conversion between Kubernetes and OpenYurt</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/How-to-use-service-topology">Use service topology to realize topology-aware traffic routing</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/How-run-business-pod-in-edge-scenarios">How Openyurt runs the business pod in edge scenarios</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Edge-gateway-caching-capabilities">Elegant realization of edge gateway caching capabilities</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Play-with-OpenYurt-on-Raspberry-Pi">Getting Started with OpenYurt:play with OpenYurt on Raspberry Pi</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Build-side-efficient-collaborative-network">How to build Kubernetes Native Cloud side efficient collaborative network</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Expansion-capability-of-Yurthub">Viewing Expansion Ability of YurtHub from Edge Autonomy</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/YurtHub-design-detail">YurtHub Design Detail:edge autonomy of OpenYurt</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Use-of-yurtctl">Yurtctl:make the native k8s cluster achieve edge computing capabilities</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Introduce-of-OpenYurt">OpenYurt:edge computing cloud native project</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/How-to-use-yurtctl-convert-revert">Seamless conversion between Kubernetes and OpenYurt</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-12-03T00:00:00.000Z" itemprop="datePublished">December 3, 2021</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/adamzhoul" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/adamzhoul.png" alt="adamzhoul"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/adamzhoul" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">adamzhoul</span></a></div><small class="avatar__subtitle" itemprop="description">Member of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>æ‰“å¼€openYurtçš„README.mdï¼Œåœ¨ç®€å•ä»‹ç»ä¹‹åå°±æ˜¯Getting started:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> yurtctl convert --provider [minikube|kubeadm|kind] // To convert an existing Kubernetes cluster to an OpenYurt cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> yurtctl revert // To uninstall and revert back to the original cluster settings</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç®€å•ä¸€è¡Œå‘½ä»¤å°±å¯ä½“éªŒOpenYurtäº†ï¼Œæ„Ÿè§‰éå¸¸æ–¹ä¾¿ã€‚</p><p>ç¨ç­‰ï¼ä¸ºä»€ä¹ˆæ˜¯ convert/revert è€Œä¸æ˜¯ install/uninstall ?</p><p>è¿™ä¸ªå‘½ä»¤å¯¹é›†ç¾¤åšäº†ä»€ä¹ˆï¼Ÿ</p><p>çœ‹æ¥ï¼Œåœ¨æ‰§è¡Œå®ƒä¹‹å‰æœ‰å¿…è¦ææ¸…æ¥šå®ƒåˆ°åº•åšäº†ä»€ä¹ˆã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurtctl-convert-åˆ°åº•åšäº†äº›ä»€ä¹ˆ">yurtctl convert åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ<a aria-hidden="true" class="hash-link" href="#yurtctl-convert-åˆ°åº•åšäº†äº›ä»€ä¹ˆ" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="æ ¸å¿ƒæµç¨‹">æ ¸å¿ƒæµç¨‹<a aria-hidden="true" class="hash-link" href="#æ ¸å¿ƒæµç¨‹" title="Direct link to heading">â€‹</a></h3><p>è·ŸéšopenYurt<a href="https://github.com/openyurtio/openyurt/blob/5063752a9f6645270e3177e39a46df8c23145af2/pkg/yurtctl/cmd/convert/convert.go#L300" target="_blank" rel="noopener noreferrer">æºä»£ç </a>ï¼Œæ¢³ç†äº†convertçš„æ ¸å¿ƒæµç¨‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. æ£€æŸ¥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   1.1 æ£€æŸ¥æ‰€æœ‰nodeèŠ‚ç‚¹çŠ¶æ€ä¸ºready</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. ç»„ä»¶éƒ¨ç½²</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.1 ç»™nodeèŠ‚ç‚¹æ‰“ä¸Šç›¸åº”çš„labelã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.2 ä½¿ç”¨deploymentéƒ¨ç½²yurt-controller-managerã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.3 ä½¿ç”¨deploymentéƒ¨ç½²yurt-tunnel-serverã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.4 ä½¿ç”¨daemonsetéƒ¨ç½²yurt-tunnel-agentï¼Œéƒ¨ç½²åœ¨è¾¹ç¼˜èŠ‚ç‚¹ä¸Šã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.5 ä½¿ç”¨deploymentéƒ¨ç½²yurt-app-managerã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. k8sç»„ä»¶ä¿®æ”¹</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  3.1 ä¿®æ”¹kube-controller-manager.yamlï¼Œç”¨æ¥disable nodelifecycle controller</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. èŠ‚ç‚¹è½¬æ¢</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   4.1 å†™å…¥yurthub.yamlåˆ°/etc/kubernetes/manifestsï¼Œå¯åŠ¨é™æ€pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   4.2 ä¿®æ”¹kubeleté…ç½®ï¼Œä½¿å¾—kubeletè®¿é—®yurthubè€Œä¸æ˜¯ç›´è¿apiServer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§1ã€2å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œåªæ˜¯å¸¸è§„çš„æœåŠ¡éƒ¨ç½²</p><p>3ï¼Œåˆ™æ˜¯å¯¹åŸæœ‰k8sç³»ç»Ÿç»„ä»¶çš„æ“ä½œï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„</p><p>4-èŠ‚ç‚¹è½¬æ¢çœ‹ç€ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œå´å¯¹è¾¹ç¼˜è‡³å…³é‡è¦ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="disable-nodelifecycle-controller-åšäº†ä»€ä¹ˆ">disable nodelifecycle controller åšäº†ä»€ä¹ˆï¼Ÿ<a aria-hidden="true" class="hash-link" href="#disable-nodelifecycle-controller-åšäº†ä»€ä¹ˆ" title="Direct link to heading">â€‹</a></h3><p>å·¥ä½œå†…å®¹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. æŸ¥è¯¢æ§åˆ¶é¢èŠ‚ç‚¹</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. åˆ›å»ºjobï¼Œé€šè¿‡` nodeName: {{.nodeName}}` ç¡®ä¿jobçš„podè°ƒåº¦åˆ°å¯¹åº”nodeä¸Šæ‰§è¡Œ(é€šè¿‡nsenterçš„æ–¹å¼æ‰§è¡Œï¼Œä¿®æ”¹å®¿ä¸»æœºä¸Šæ–‡ä»¶)ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. sed -i &#x27;s/--controllers=/--controllers=-nodelifecycle,/g&#x27; /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æŸ¥çœ‹kube-controller-manager.yaml</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- kube-controller-manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --allocate-node-cidrs=true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --controllers=-nodelifecycle,*,bootstrapsigner,tokencleaner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§ï¼Œä¸Šé¢çš„ä¸€ç³»åˆ—æ“ä½œæœ€ç»ˆå°±æ˜¯ä¿®æ”¹äº†kube-controller-managerçš„å¯åŠ¨å‘½ä»¤ã€‚</p><p>æŸ¥çœ‹kube-controller-managerå¯åŠ¨å‚æ•°è¯´æ˜ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">--controllers ä»£è¡¨éœ€è¦å¼€å¯çš„controlleråˆ—è¡¨</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§ï¼Œsedå‘½ä»¤å°±æ˜¯å»æ‰äº†nodelifecycleè¿™ä¸ªcontrollerã€‚</p><p>é‚£ï¼Œnodelifecycle controlleræ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p><p>ç®€å•æ¥è¯´ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. ä¸æ–­ç›‘å¬ï¼Œkubeletä¸ŠæŠ¥ä¸Šæ¥çš„nodeä¿¡æ¯</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. å¦‚æœæŸä¸ªnodeçŠ¶æ€å¼‚å¸¸ï¼Œæˆ–è€…è¯´é•¿æ—¶é—´æ²¡æœ‰ä¸ŠæŠ¥ç­‰</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.1 é©±é€è¿™ä¸ªnodeèŠ‚ç‚¹æˆ–è€…å…¶ä»– ---&gt; å¯¼è‡´ä¸Šé¢çš„podè¢«é‡æ–°è°ƒåº¦</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§ï¼Œå¯¹äºå¤„äºå¼±ç½‘ç¯å¢ƒçš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±å‘½ä¸­å¼‚å¸¸çŠ¶æ€ï¼Œå¯¼è‡´nodeè¢«é©±é€ï¼Œpodè¢«é‡æ–°è°ƒåº¦ã€‚</p><p>æ‰€ä»¥è¿™é‡ŒæŠŠå®ƒå»æ‰äº†ã€‚ä½¿ç”¨yurt-controller-manageræ¥ä»£æ›¿å®ƒã€‚</p><p>å³ä½¿èŠ‚ç‚¹å¿ƒè·³ä¸¢å¤±ï¼Œå¤„äºè‡ªæ²»æ¨¡å¼çš„èŠ‚ç‚¹ä¸­çš„podä¹Ÿä¸ä¼šä»APIServerä¸­é©±é€ã€‚</p><p>æ³¨ï¼šè¿™é‡Œè‡ªæ²»æ¨¡å¼çš„èŠ‚ç‚¹ï¼ŒæŒ‡çš„å°±æ˜¯è¾¹ç¼˜èŠ‚ç‚¹ã€‚æˆ‘ä»¬é€šå¸¸ä¼šé€šè¿‡åŠ annotationçš„æ–¹å¼æŠŠèŠ‚ç‚¹æ ‡è®°ä¸ºè‡ªæ²»èŠ‚ç‚¹ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="èŠ‚ç‚¹è½¬æ¢æ˜¯æ€ä¹ˆå®ç°çš„äº‘ç«¯èŠ‚ç‚¹å’Œè¾¹ç¼˜èŠ‚ç‚¹æœ‰ä»€ä¹ˆå·®å¼‚">èŠ‚ç‚¹è½¬æ¢æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œäº‘ç«¯èŠ‚ç‚¹å’Œè¾¹ç¼˜èŠ‚ç‚¹æœ‰ä»€ä¹ˆå·®å¼‚?<a aria-hidden="true" class="hash-link" href="#èŠ‚ç‚¹è½¬æ¢æ˜¯æ€ä¹ˆå®ç°çš„äº‘ç«¯èŠ‚ç‚¹å’Œè¾¹ç¼˜èŠ‚ç‚¹æœ‰ä»€ä¹ˆå·®å¼‚" title="Direct link to heading">â€‹</a></h3><p>åŒæ ·ï¼Œæ˜¯é€šè¿‡è·‘jobçš„æ–¹å¼ï¼Œåœ¨ç›®æ ‡å®¿ä¸»æœºä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç›¸å…³æ“ä½œã€‚</p><p>ä¸è¿‡ï¼Œç›¸æ¯”äºæš´åŠ›ä½¿ç”¨nsenterï¼Œè¿™é‡Œç”¨äº†æ›´åŠ ä¼˜é›…çš„æ–¹å¼ã€‚é€šè¿‡å°†å®¿ä¸»æœºæ ¹è·¯å¾„ volumeæŒ‚è½½åˆ°å®¹å™¨é‡Œçš„æ–¹å¼ã€‚</p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="kubeletçš„ä¿®æ”¹">kubeletçš„ä¿®æ”¹<a aria-hidden="true" class="hash-link" href="#kubeletçš„ä¿®æ”¹" title="Direct link to heading">â€‹</a></h5><p>åœ¨æ–‡ä»¶/var/lib/kubelet/kubeadm-flags.env ä¸­ä¸ºKUBELET_KUBEADM_ARGSæ·»åŠ é…ç½®ï¼š</p><p><code>--kubeconfig=/var/lib/openyurt/kubelet.conf --bootstrap-kubeconfig=</code></p><p>ä½œç”¨ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. å‚æ•°ï¼š--kubeconfig ï¼Œ ç»™kubeletæŒ‡å®šäº†è®¿é—®apiServerçš„é…ç½®æ–‡ä»¶ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. å½“--kubeconfig æ–‡ä»¶å­˜åœ¨ï¼Œ--bootstrap-kubeconfigä¸ºç©ºæ—¶ï¼Œ</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   kubeletå¯åŠ¨å°±ä¸éœ€è¦é€šè¿‡bootstrap-tokenç½®æ¢æ–‡ä»¶è¯ä¹¦ç­‰è¿‡ç¨‹ï¼Œç›´æ¥è¯»å–kubeconfigæ–‡ä»¶è®¿é—®apiServerã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. ç”±äºKUBELET_KUBEADM_ARGS æ˜¯kubeletå¯åŠ¨å‚æ•°çš„æœ€åä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å¯ä»¥èµ·åˆ°è¦†ç›–å‰é¢å‚æ•°çš„ä½œç”¨ã€‚</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…¶ä¸­<code>/var/lib/openyurt/kubelet.conf</code>å†…å®¹å¦‚ä¸‹ï¼Œç›´æ¥å°†æµé‡æŒ‡å®šåˆ°yurthubï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">clusters:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- cluster:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server: http://127.0.0.1:10261</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name: default-cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">contexts:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- context:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cluster: default-cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace: default</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user: default-auth</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name: default-context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">current-context: default-context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">preferences: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_y2LR" id="yurthubçš„å¯åŠ¨ç»†èŠ‚">yurthubçš„å¯åŠ¨ç»†èŠ‚<a aria-hidden="true" class="hash-link" href="#yurthubçš„å¯åŠ¨ç»†èŠ‚" title="Direct link to heading">â€‹</a></h5><p>yurthubå®¹å™¨å¯åŠ¨å‚æ•°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- yurthub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --v=2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --server-addr=__kubernetes_service_addr__</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --node-name=$(NODE_NAME)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --join-token=__join_token__</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --working-mode=__working_mode__</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡å‚æ•°æˆ‘ä»¬å¯çœ‹å‡ºï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. server-addr æŒ‡å®šäº†äº‘ç«¯apiServeråœ°å€ã€‚æ³¨æ„è¿™é‡Œçš„åœ°å€ä¸€å®šæ˜¯å…¬ç½‘å¯è®¿é—®åœ°å€ï¼Œå¦åˆ™å¼‚æ„ç½‘ç»œä¸‹ä¼šæœ‰é—®é¢˜ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. join-token å°±æ˜¯åŠ å…¥èŠ‚ç‚¹çš„tokenï¼Œå¯ä½¿ç”¨`kubeadm token create`æ¥åˆ›å»ºã€‚k8sæä¾›æœºåˆ¶ï¼Œé€šè¿‡tokenç½®æ¢å‡ºæ­£å¸¸è®¿é—®çš„kubeconfæ–‡ä»¶ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. working-modeï¼š cloud/edgeã€‚è¿™å°±æ˜¯è¾¹ç¼˜èŠ‚ç‚¹å’Œäº‘ç«¯èŠ‚ç‚¹çš„å·®å¼‚ã€‚</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬éƒ½çŸ¥é“yurthubå¯ä»¥ç”¨æ¥åšç¼“å­˜ï¼Œæ˜¯è§£å†³è¾¹ç¼˜è‡ªæ²»çš„é‡è¦ç¯èŠ‚ã€‚é‚£ä¹ˆäº‘ç«¯ä¸ºä»€ä¹ˆä¹Ÿéœ€è¦éƒ¨ç½²ï¼Ÿä¸ºä»€ä¹ˆè¿˜è¦åŒºåˆ†edgeæˆ–è€…cloudå·¥ä½œæ¨¡å¼ï¼Ÿ</p><p>ç®€å•æŸ¥çœ‹yurthubæºä»£ç  cmd/yurthub/app/start.go:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI golang"><pre tabindex="0" class="prism-code language-golang codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">if cfg.WorkingMode == util.WorkingModeEdge {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cacheMgr, err = cachemanager.NewCacheManager(cfg.StorageWrapper, cfg.SerializerManager, cfg.RESTMapperManager, cfg.SharedFactory)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    klog.Infof(&quot;%d. disable cache manager for node %s because it is a cloud node&quot;, trace, cfg.NodeName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if cfg.WorkingMode == util.WorkingModeEdge {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    gcMgr, err := gc.NewGCManager(cfg, restConfigMgr, stopCh)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    klog.Infof(&quot;%d. disable gc manager for node %s because it is a cloud node&quot;, trace, cfg.NodeName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§ï¼Œäº‘ç«¯yurthubï¼Œå°‘åšäº† cacheã€GCçš„å·¥ä½œã€‚</p><p>æŸ¥çœ‹<a href="https://github.com/openyurtio/openyurt/issues/450" target="_blank" rel="noopener noreferrer">issue</a> å¯äº†è§£ï¼šäº‘ç«¯ä¹Ÿå¯ä»¥åˆ©ç”¨yurthubæä¾›çš„data-filteringèƒ½åŠ›æ¥æ§åˆ¶serviceçš„æµé‡</p><p>å½“ç„¶ï¼Œäº‘ç«¯ä¹Ÿä¸éœ€è¦åšcacheç­‰å·¥ä½œã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="å‘½ä»¤è¡Œå‚æ•°">å‘½ä»¤è¡Œå‚æ•°<a aria-hidden="true" class="hash-link" href="#å‘½ä»¤è¡Œå‚æ•°" title="Direct link to heading">â€‹</a></h3><p>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰å‡ ä¸ªå‚æ•°æ¯”è¾ƒé‡è¦ï¼š</p><p>--cloud-nodes ç”¨äºæ ‡è¯†å“ªäº›æ˜¯äº‘ç«¯èŠ‚ç‚¹ï¼Œå¤šä¸ªèŠ‚ç‚¹ç”¨é€—å·åˆ†éš”ï¼šnode1,node2</p><p>--deploy-yurttunnel æ ‡è®°æ˜¯å¦è¦éƒ¨ç½²yurttunnel</p><p>--kubeadm-conf-path æ ‡è®°èŠ‚ç‚¹æœºå™¨ä¸Škubeadmé…ç½®æ–‡ä»¶è·¯å¾„ã€‚é»˜è®¤ï¼š/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</p><p>æ›´å¤šå‚æ•°ï¼Œå¯ä½¿ç”¨ yurtctl convert --help æ¥æŸ¥çœ‹ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="æ€»ç»“">æ€»ç»“<a aria-hidden="true" class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h3><p>ç®€å•æ¥è¯´ï¼Œconvertæ ¸å¿ƒåšäº†å‡ ä¸ªäº‹æƒ…ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. disable k8s çš„nodelifecontrollerï¼Œç”¨è‡ªå·±çš„yurtcontrollermanageræ¥æ›¿æ¢å®ƒçš„èŒè´£ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. å®‰è£…è‡ªå·±çš„å„ç±»ç»„ä»¶ï¼Œdeploymentã€damenonset ç­‰æ¨¡å¼éƒ¨ç½²ã€‚ï¼ˆè¿™ç±»èµ„æºéƒ¨ç½²æ— éœ€ä»»ä½•æ‹…å¿ƒï¼Œå› ä¸ºæä¸åé›†ç¾¤ï¼Œä¹Ÿä¸å¤ªä¼šå‡ºç°é—®é¢˜ã€‚ï¼‰</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. è¾¹ç¼˜èŠ‚ç‚¹ï¼šå¯åŠ¨yurthubé™æ€pod;å°†kubeletæµé‡è½¬å‘åˆ°yurthubã€‚</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯è§ï¼Œconvertçš„äº‹æƒ…è¿˜æ˜¯æ¯”è¾ƒå¯æ§çš„ã€‚æ‰§è¡Œyurtctl convert ä¹Ÿä¸ç”¨å¤ªæ‹…å¿ƒã€‚</p><p>å½“ç„¶ï¼Œæœ€åçš„æ‹…å¿ƒä¹Ÿåº”è¯¥ç”± yurtctl revert æ¥å½»åº•æ¶ˆé™¤ï¼</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurtctl-revert-åˆå¹²äº†äº›ä»€ä¹ˆ">yurtctl revert åˆå¹²äº†äº›ä»€ä¹ˆï¼Ÿ<a aria-hidden="true" class="hash-link" href="#yurtctl-revert-åˆå¹²äº†äº›ä»€ä¹ˆ" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="æ ¸å¿ƒæµç¨‹-1">æ ¸å¿ƒæµç¨‹<a aria-hidden="true" class="hash-link" href="#æ ¸å¿ƒæµç¨‹-1" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. æ£€æŸ¥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  1.1 ç¡®ä¿æ‰€æœ‰nodeéƒ½å·²ç»ready</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. åˆ é™¤è‡ªèº«éƒ¨ç½²ç»„ä»¶</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.1 åˆ é™¤ yurt-controller-manager deploymentä»¥åŠç›¸å…³èµ„æº </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.2 åˆ é™¤yurt-tunnel-agentä»¥åŠç›¸å…³èµ„æº</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.2 åˆ é™¤yurt-tunnel-serverä»¥åŠç›¸å…³èµ„æº  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.3 åˆ é™¤yurt-app-managerä»¥åŠç›¸å…³èµ„æº</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. k8sç»„ä»¶ä¿®æ”¹</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  3.1 å¼€å¯nodelifecontroller, è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠä¿®æ”¹çš„å‘½ä»¤é€šè¿‡sedå‘½ä»¤æ”¹å›æ¥ã€‚</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. äº‘ç«¯ã€è¾¹ç¼˜èŠ‚ç‚¹è½¬æ¢ä¸ºåŸç”ŸèŠ‚ç‚¹</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  4.1 ä¿®æ”¹kubeleté…ç½®ï¼Œç›´è¿apiServer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  4.2 åˆ é™¤yurthubç›¸å…³é…ç½®ã€ç›®å½•</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ•´ä¸ªrevertçš„è¿‡ç¨‹å°±æ˜¯convertçš„åå‘æ“ä½œï¼Œè¿˜æ¯”è¾ƒå¥½ç†è§£ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ã€‚å¦‚æœconvertå¤±è´¥ï¼Œæ¯”å¦‚jobæ‰§è¡Œè¶…æ—¶æˆ–è€…å¤±è´¥ã€‚jobæ˜¯ä¸ä¼šè¢«åˆ é™¤çš„ã€‚</p><p>å³ä½¿yurtctl revert ä¹Ÿä¸ä¼šåˆ é™¤ã€‚ç›®çš„æ˜¯ä¸ºäº†ä¿ç•™ç°åœºæ–¹ä¾¿å®šä½é—®é¢˜ã€‚</p><p>å¦‚æœéœ€è¦é‡æ–°æ‰§è¡Œyurtctl convertï¼Œ éœ€è¦æ‰‹åŠ¨åˆ é™¤jobã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get job -n kube-system -A |grep convert</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete job -n kube-system &lt; job-name&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æ€»ç»“-1">æ€»ç»“<a aria-hidden="true" class="hash-link" href="#æ€»ç»“-1" title="Direct link to heading">â€‹</a></h2><p>yurtctl convert/revert å‘½ä»¤æ˜¯æœ€å¿«æ·ä½“éªŒopenYurtåŠŸèƒ½çš„æ–¹æ³•ä¹‹ä¸€ã€‚</p><p>åœ¨äº†è§£äº†è¿™ä¸¤ä¸ªå‘½ä»¤çš„å®ç°åŸç†ï¼Œä¹Ÿå°±å¯¹openYurtçš„æŠ€æœ¯æ–¹æ¡ˆäº†è§£å¤§åŠäº†ã€‚</p><p>æ‰§è¡Œå‘½ä»¤ä¹Ÿä¸æ‹…å¿ƒäº†ï¼Œso easyï¼</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/How-to-use-service-topology">Use service topology to realize topology-aware traffic routing</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-11-24T00:00:00.000Z" itemprop="datePublished">November 24, 2021</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/windydayc" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/windydayc.png" alt="Feng Zeng"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/windydayc" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Feng Zeng</span></a></div><small class="avatar__subtitle" itemprop="description">Zhejiang University student, Member of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>Service Topology</em> enables a service to route traffic based on the Node topology of the cluster. For example, a service can specify that traffic be preferentially routed to endpoints that are on the same Node as the client, or in the same availability NodePool. </p><p>The following picture shows the general function of the <em>service topology</em>.</p><p><img alt="service-topology" src="/assets/images/service-topology-example-4fd2ecf0d4a663ff1fb33adbcfebad43.png"></p><p>To use <em>service topology</em>, the <code>EndpointSliceProxying</code> <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/" target="_blank" rel="noopener noreferrer">feature gate</a> must be enabled, and kube-proxy needs to be configured to connect to Yurthub instead of the API server.</p><p>You can set the <code>topologyKeys</code> values of a service to direct traffic as follows. If <code>topologyKeys</code> is not specified or empty, no topology constraints will be applied.</p><table><thead><tr><th align="center"><strong>annotation Key</strong></th><th align="center"><strong>annotation Value</strong></th><th align="center"><strong>explain</strong></th></tr></thead><tbody><tr><td align="center">openyurt.io/topologyKeys</td><td align="center">kubernetes.io/hostname</td><td align="center">Only to endpoints on the same node.</td></tr><tr><td align="center">openyurt.io/topologyKeys</td><td align="center">kubernetes.io/zone<br> or <br>openyurt.io/nodepool</td><td align="center">Only to endpoints on the same nodepool.</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_y2LR" id="prerequisites">Prerequisites<a aria-hidden="true" class="hash-link" href="#prerequisites" title="Direct link to heading">â€‹</a></h2><ol><li>Kubernetes v1.18 or above, since EndpointSlice resource needs to be supported.</li><li>Yurt-app-manager is deployed in the cluster.</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-use">How to use<a aria-hidden="true" class="hash-link" href="#how-to-use" title="Direct link to heading">â€‹</a></h2><p>Ensure that kubernetes version is v1.18+.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-control-plane   Ready    master   6m21s   v1.18.19</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-worker          Ready    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">   5m42s   v1.18.19</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-worker2         Ready    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">   5m42s   v1.18.19</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Ensure that yurt-app-manager is deployed in the cluster.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI BASH"><pre tabindex="0" class="prism-code language-BASH codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get pod -n kube-system </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                                         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">coredns-66bff467f8-jxvnw                     1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">coredns-66bff467f8-lk8v5                     1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">etcd-kind-control-plane                      1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-5dpxt                                1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-ckz88                                1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-sqxs7                                1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-apiserver-kind-control-plane            1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-controller-manager-kind-control-plane   1/1     Running   0          5m38s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-ddgjt                             1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-j25kr                             1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-jt9cw                             1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-scheduler-kind-control-plane            1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-app-manager-699ffdcb78-8m9sf            1/1     Running   0          37s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-app-manager-699ffdcb78-fdqmq            1/1     Running   0          37s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-controller-manager-6c95788bf-jrqts      1/1     Running   0          6m17s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-control-plane                  1/1     Running   0          3m36s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-worker                         1/1     Running   0          4m50s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-worker2                        1/1     Running   0          4m50s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="configure-kube-proxy">Configure kube-proxy<a aria-hidden="true" class="hash-link" href="#configure-kube-proxy" title="Direct link to heading">â€‹</a></h3><p>To use <em>service topology</em>, the <code>EndpointSliceProxying</code> <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/" target="_blank" rel="noopener noreferrer">feature gate</a> must be enabled, and kube-proxy needs to be configured to connect to Yurthub instead of the API server.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit cm -n kube-system kube-proxy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  config.conf: </span><span class="token operator">|</span><span class="token plain">-</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bindAddress: </span><span class="token number">0.0</span><span class="token plain">.0.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    featureGates: </span><span class="token comment" style="color:rgb(98, 114, 164)"># 1. enable EndpointSliceProxying feature gate.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      EndpointSliceProxying: </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clientConnection:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      acceptContentTypes: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      burst: </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      contentType: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">#kubeconfig: /var/lib/kube-proxy/kubeconfig.conf # 2. comment this line.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      qps: </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clusterCIDR: </span><span class="token number">10.244</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    configSyncPeriod: 0s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Restart kube-proxy.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl delete pod --selector k8s-app</span><span class="token operator">=</span><span class="token plain">kube-proxy -n kube-system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kube-proxy-cbsmj&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kube-proxy-cqwcs&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kube-proxy-m9dgk&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="create-nodepools">Create NodePools<a aria-hidden="true" class="hash-link" href="#create-nodepools" title="Direct link to heading">â€‹</a></h3><ul><li>Create test nodepools.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply -f -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: beijing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: Cloud</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: Edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    apps.openyurt.io/example: test-hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    apps.openyurt.io/example: test-hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: Edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    apps.openyurt.io/example: test-shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    apps.openyurt.io/example: test-shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Add nodes to the nodepool.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-control-plane apps.openyurt.io/desired-nodepool</span><span class="token operator">=</span><span class="token plain">beijing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-control-plane labeled</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-worker apps.openyurt.io/desired-nodepool</span><span class="token operator">=</span><span class="token plain">hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-worker labeled</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-worker2 apps.openyurt.io/desired-nodepool</span><span class="token operator">=</span><span class="token plain">shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-worker2 labeled</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Get NodePool.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get np</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME       TYPE    READYNODES   NOTREADYNODES   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">beijing    Cloud   </span><span class="token number">1</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">               63s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hangzhou   Edge    </span><span class="token number">1</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">               63s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shanghai   Edge    </span><span class="token number">1</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">               63s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="create-uniteddeployment">Create UnitedDeployment<a aria-hidden="true" class="hash-link" href="#create-uniteddeployment" title="Direct link to heading">â€‹</a></h3><ul><li>Create test united-deployment1. To facilitate testing, we use a <code>serve_hostname</code> image. Each time port 9376 is accessed, the hostname container returns its own hostname.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply -f -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: UnitedDeployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    controller-tools.k8s.io: &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  workloadTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    deploymentTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">              app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">              - name: hostname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                image: mirrorgooglecontainers/serve_hostname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                - containerPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                  protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  topology:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    pools:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    - name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          - hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    - name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          - shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  revisionHistoryLimit: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Create test united-deployment2. Here we use <code>nginx</code> image, in order to access the <code>hostname</code> pod that created by united-deployment1 above.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply -f -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: UnitedDeployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    controller-tools.k8s.io: &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  workloadTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    deploymentTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">              app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">              - name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                image: nginx:1.19.3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                - containerPort: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">                  protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  topology:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    pools:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    - name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          - hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    - name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          - shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  revisionHistoryLimit: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Get pods that created by the unitedDeployment.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get pod -l </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app in (united-deployment1,united-deployment2)&quot;</span><span class="token plain"> -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                                                 READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-f2694   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          18m   </span><span class="token number">10.244</span><span class="token plain">.2.3   kind-worker    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          18m   </span><span class="token number">10.244</span><span class="token plain">.2.2   kind-worker    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          18m   </span><span class="token number">10.244</span><span class="token plain">.1.3   kind-worker2   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          18m   </span><span class="token number">10.244</span><span class="token plain">.1.2   kind-worker2   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-hangzhou-lpkzg-6d958b67b6-gf847   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          15m   </span><span class="token number">10.244</span><span class="token plain">.2.4   kind-worker    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-hangzhou-lpkzg-6d958b67b6-lbnwl   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          15m   </span><span class="token number">10.244</span><span class="token plain">.2.5   kind-worker    </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-shanghai-tqgd4-57f7555494-9jvjb   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          15m   </span><span class="token number">10.244</span><span class="token plain">.1.5   kind-worker2   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-shanghai-tqgd4-57f7555494-rn8n8   </span><span class="token number">1</span><span class="token plain">/1     Running   </span><span class="token number">0</span><span class="token plain">          15m   </span><span class="token number">10.244</span><span class="token plain">.1.4   kind-worker2   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">           </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="create-service-with-topologykeys">Create Service with TopologyKeys<a aria-hidden="true" class="hash-link" href="#create-service-with-topologykeys" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply -f -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: svc-ud1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    openyurt.io/topologyKeys: openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - port: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    targetPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="create-service-without-topologykeys">Create Service without TopologyKeys<a aria-hidden="true" class="hash-link" href="#create-service-without-topologykeys" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply -f -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: svc-ud1-without-topology</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - port: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    targetPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="test-service-topology">Test Service Topology<a aria-hidden="true" class="hash-link" href="#test-service-topology" title="Direct link to heading">â€‹</a></h3><p>We use the <code>nginx</code> pod in the shanghai nodepool to test <em>service topology</em>. Therefore, its traffic can only be routed to the nodes that in shanghai nodepool when it accesses a service with the <code>openyurt.io/topologyKeys: openyurt.io/nodepool</code> annotation.</p><p>For comparison, we first test the service without serviceTopology annotation. As we can see, its traffic can be routed to any nodes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> -it united-deployment2-shanghai-tqgd4-57f7555494-9jvjb </span><span class="token function" style="color:rgb(80, 250, 123)">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1-without-topology:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1-without-topology:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1-without-topology:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1-without-topology:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-f2694</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Then we test the service with serviceTopology annotation. As expected, its traffic can only be routed to the nodes in shanghai nodepool.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> -it united-deployment2-shanghai-tqgd4-57f7555494-9jvjb </span><span class="token function" style="color:rgb(80, 250, 123)">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl svc-ud1:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/How-run-business-pod-in-edge-scenarios">How Openyurt runs the business pod in edge scenarios</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-10-15T00:00:00.000Z" itemprop="datePublished">October 15, 2021</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">rambohe</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1èƒŒæ™¯ä»‹ç»">1.èƒŒæ™¯ä»‹ç»<a aria-hidden="true" class="hash-link" href="#1èƒŒæ™¯ä»‹ç»" title="Direct link to heading">â€‹</a></h3><p>OpenYurtæ˜¯ä¸šç•Œé¦–ä¸ªéä¾µå…¥çš„è¾¹ç¼˜è®¡ç®—äº‘åŸç”Ÿå¼€æºé¡¹ç›®ï¼Œé€šè¿‡è¾¹ç¼˜è‡ªæ²»ï¼Œäº‘è¾¹ååŒï¼Œè¾¹ç¼˜å•å…ƒåŒ–ï¼Œè¾¹ç¼˜æµé‡é—­ç¯ç­‰èƒ½åŠ›ä¸ºç”¨æˆ·æä¾›äº‘è¾¹ä¸€ä½“åŒ–çš„ä½¿ç”¨ä½“éªŒã€‚ä¸å°‘ç”¨æˆ·åœ¨ä½¿ç”¨OpenYurtçš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æŠŠå­˜é‡çš„ä½¿ç”¨InClusterConfigè®¿é—®kube-apiserverçš„Podé€šè¿‡OpenYurtè¿ç§»åˆ°è¾¹ç¼˜ç¯å¢ƒä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/images/InCluster1-1ef22d79567f77ccd6a6d7eeb72185ac.png"></p><p>åœ¨OpenYurté›†ç¾¤ä¸­ï¼Œæä¾›äº†ä½¿ç”¨InClusterConfigçš„ä¸šåŠ¡Podé›¶ä¿®æ”¹å°±å¯ä»¥è¿è¡Œåœ¨è¾¹ç¼˜ç¯å¢ƒçš„èƒ½åŠ›ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2é¢ä¸´æŒ‘æˆ˜">2.é¢ä¸´æŒ‘æˆ˜<a aria-hidden="true" class="hash-link" href="#2é¢ä¸´æŒ‘æˆ˜" title="Direct link to heading">â€‹</a></h3><p>ä½¿ç”¨InClusterConfigçš„ä¸šåŠ¡Podåœ¨è¾¹ç¼˜ç¯å¢ƒä¸­è¿è¡Œï¼Œéœ€è¦è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li><p>é—®é¢˜ä¸€ï¼šPodé€šè¿‡InClusterConfigåœ°å€è®¿é—®kube-apiserverï¼ŒèŠ‚ç‚¹ä¸Šé»˜è®¤ç½‘ç»œè§„åˆ™ï¼ˆiptables/ipvsï¼‰å°†ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°kube-apiserverçš„PodIPï¼ŒåŒæ—¶äº‘ç«¯ä¸è¾¹ç¼˜ä½äºä¸åŒç½‘ç»œå¹³é¢ï¼Œè¾¹ç¼˜æ˜¯æ— æ³•è®¿é—®åˆ°äº‘ç«¯çš„PodIPã€‚æ‰€ä»¥è¾¹ç¼˜ä¸šåŠ¡Podæ— æ³•é€šè¿‡InClusterConfigè®¿é—®åˆ°kube-apiserverã€‚</p><p><img alt="Incluster2" src="/assets/images/Incluster2-7f6a69f9c29152322fbc57bf978eca6e.png"></p></li><li><p>é—®é¢˜äºŒï¼šåœ¨è§£å†³é—®é¢˜ä¸€åï¼Œå¦‚æœäº‘è¾¹ç½‘ç»œæ–­å¼€æ—¶ä¸šåŠ¡Podå®¹å™¨å‡ºç°é‡å¯ç­‰çŠ¶å†µï¼Œè¾¹ç¼˜Podå°†æ— æ³•ä»kube-apiserverè·å–åˆ°ä¸šåŠ¡é…ç½®ï¼Œè¿™ä¼šå½±å“åˆ°ä¸šåŠ¡Podçš„é‡å¯è¿è¡Œã€‚</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3è§£å†³æ–¹æ¡ˆ">3.è§£å†³æ–¹æ¡ˆ<a aria-hidden="true" class="hash-link" href="#3è§£å†³æ–¹æ¡ˆ" title="Direct link to heading">â€‹</a></h3><p>ä»ä¸Šè¿°é—®é¢˜å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦æ— æ„ŸçŸ¥çš„è°ƒæ•´è¾¹ç¼˜podçš„è®¿é—®åœ°å€ï¼ŒåŒæ—¶éœ€è¦åœ¨è¾¹ç¼˜ç¯å¢ƒä¸­ç¼“å­˜ä¸šåŠ¡é…ç½®ï¼Œä¿è¯äº‘è¾¹æ–­ç½‘æ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨è¾¹ç¼˜ç¼“å­˜ä¸šåŠ¡é…ç½®ï¼Œä¿è¯äº‘è¾¹æ–­ç½‘æ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨è¾¹ç¼˜ç¼“å­˜æ¥è·å–ä¸šåŠ¡Podçš„é…ç½®ä¿¡æ¯ã€‚å…·ä½“è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼›</p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="31è¾¹ç¼˜podè®¿é—®çš„äº‘ç«¯endpointä¼˜åŒ–">3.1è¾¹ç¼˜Podè®¿é—®çš„äº‘ç«¯endpointä¼˜åŒ–<a aria-hidden="true" class="hash-link" href="#31è¾¹ç¼˜podè®¿é—®çš„äº‘ç«¯endpointä¼˜åŒ–" title="Direct link to heading">â€‹</a></h5><ul><li><p>Podé€šè¿‡InClusterConfigè®¿é—®kube-apiserverï¼Œæºç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">InClusterConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tokenFile  </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rootCAFile </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// é€šè¿‡Kuberentes serviceå¯¹åº”çš„ç¯å¢ƒå˜é‡æ¥è·å–è®¿é—®åœ°å€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> port </span><span class="token operator">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;KUBERNETES_SERVICE_HOST&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;KUBERNETES_SERVICE_PORT&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ErrNotInCluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// skip some code...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;https://&quot;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> net</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">JoinHostPort</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    TLSClientConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tlsClientConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BearerToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     </span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BearerTokenFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tokenFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><ul><li><p>å› æ­¤æƒ³æ— æ„ŸçŸ¥è°ƒæ•´è¾¹ç¼˜Podè®¿é—®çš„äº‘ç«¯endpointï¼Œåªéœ€è¦æ— ä¾µå…¥ä¿®æ”¹Podçš„KUBERNETES_SERVICE_HOSTå’ŒKUBERNETE_SERVICE_PORTä¸¤ä¸ªç¯å¢ƒå˜é‡æˆ–è€…ä¿®æ”¹kubernetes serviceåœ°å€ã€‚è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li><p>è§£å†³æ–¹æ¡ˆä¸€ï¼šå¢åŠ ä¸€ä¸ªadmission controlleråœ¨è¾¹ç¼˜Podåˆ›å»ºæ—¶æŠŠkube-apiserverçš„å…¬ç½‘åœ°å€è‡ªåŠ¨æ³¨å…¥åˆ°Podçš„ç¯å¢ƒå˜é‡KUBERNETES_SERVICE_HOSTå’ŒKUBERNETE_SERVICE_PORT</p></li><li><p>è§£å†³æ–¹æ¡ˆäºŒï¼šè¾¹ç¼˜æ•°æ®è¿‡æ»¤æ¡†æ¶ä¸­å¢åŠ ä¸€ä¸ªfillter yurthubçš„è¾¹ç¼˜æ•°æ®è¿‡æ»¤æ¡†æ¶ç±»ä¼¼äºadmission controller ,ä¸“é—¨ç”¨äºè¾¹ç¼˜åœºæ™¯ä¸‹åœ¨è¾¹ç¼˜åº”ç”¨æ— æ„ŸçŸ¥çš„çŠ¶æ€ä¸‹ï¼Œæ— ä¾µå…¥çš„ä¿®æ”¹æˆ–è€…è¿‡æ»¤äº‘ç«¯è¿”å›çš„æ•°æ®ã€‚ç›®å‰æ”¯æŒçš„è¿‡æ»¤å™¨æœ‰ï¼šMasterserviceï¼Œservicetopologyï¼Œdiscardcloudserviceç­‰</p></li><li><p>è§£å†³æ–¹æ¡ˆå¯¹æ¯”ï¼š</p><table><thead><tr><th align="center"></th><th align="center">è§£å†³æ–¹æ¡ˆä¸€</th><th align="center">è§£å†³æ–¹æ¡ˆäºŒ</th></tr></thead><tbody><tr><td align="center">å®ç°æ–¹æ¡ˆ</td><td align="center">å¢åŠ ä¸€ä¸ªadmission controller</td><td align="center">è¾¹ç¼˜æ•°æ®è¿‡æ»¤æ¡†æ¶ä¸­å¢åŠ ä¸€ä¸ªfilter</td></tr><tr><td align="center">å¤æ‚åº¦</td><td align="center">é«˜ï¼ˆéœ€è¦åŒºåˆ«Podè¿è¡Œåœ¨è¾¹ç¼˜è¿˜æ˜¯äº‘ç«¯ï¼‰</td><td align="center">ä½</td></tr><tr><td align="center">æ˜¾ç¤ºä¿®æ”¹æ•°æ®</td><td align="center">Podä¸­å¢åŠ ç¯å¢ƒå˜é‡é…ç½®</td><td align="center">æ— </td></tr></tbody></table></li></ul></li></ul><p>ç»¼åˆå®ç°å¤æ‚åº¦ï¼Œéä¾µå…¥ç­‰è®¾è®¡ç†å¿µï¼Œåœ¨OpenYurtä¸­æˆ‘ä»¬é€‰æ‹©äº†è§£å†³æ–¹æ¡ˆäºŒã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/images/InCluster3-4342c22777070b2df9e39d158a929ac3.png"></p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="32ä¸šåŠ¡podçš„è¾¹ç¼˜è‡ªæ²»">3.2ä¸šåŠ¡Podçš„è¾¹ç¼˜è‡ªæ²»<a aria-hidden="true" class="hash-link" href="#32ä¸šåŠ¡podçš„è¾¹ç¼˜è‡ªæ²»" title="Direct link to heading">â€‹</a></h5><p>åœ¨äº‘è¾¹ç½‘ç»œæ–­å¼€çŠ¶æ€ä¸‹ï¼Œä¸šåŠ¡Podé‡å¯æ—¶ï¼Œå°†æ— æ³•ä»äº‘ç«¯kube-apiserverè·å–åˆ°ä¸šåŠ¡é…ç½®ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦åœ¨è¾¹ç¼˜æœ¬åœ°ç¼“å­˜Podçš„ä¸šåŠ¡æ•°æ®ã€‚</p><p><img src="/assets/images/InCluster4-4a67ce6edd8af63676837754c51f97f3.png"></p><p>è¯´æ˜1ï¼šä¸šåŠ¡Podé€šè¿‡yurthubè®¿é—®kube-apiserverï¼Œä¹Ÿæ„å‘³ç€<!-- -->[3.1 è¾¹ç¼˜Podè®¿é—®çš„äº‘ç«¯endpointä¼˜åŒ–]<!-- -->ç« èŠ‚ä¸­æåˆ°çš„KUBERNETES_SERVICE_HOSTå’ŒKUBERNETE_SERVICE_PORTç¯å¢ƒå˜é‡è¢«ä¿®æ”¹ä¸ºyurthub https endpoint(169.254.2.1:10268)ã€‚</p><p>è¯´æ˜2ï¼šå¦‚æœä¸šåŠ¡Podçš„å¤§é‡list/watchæ“ä½œå¯¼è‡´å¤§é‡æœ¬åœ°cacheï¼Œå¯èƒ½ä¼šé€ æˆæœ¬åœ°ç£ç›˜å‹åŠ›ï¼Œå› æ­¤yurthubå¯¹ä¸šåŠ¡Podçš„ç¼“å­˜èƒ½åŠ›é»˜è®¤æ˜¯å…³é—­çš„ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡yurt-hub-cfg configmapçš„cache_agentså­—æ®µä¸­å¢åŠ User-Agentä¿¡æ¯æ¥æ‰“å¼€å¯¹åº”Podçš„æ•°æ®ç¼“å­˜ã€‚ä¾‹å¦‚ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yurt</span><span class="token operator">-</span><span class="token plain">hub</span><span class="token operator">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kube</span><span class="token operator">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # ç¼“å­˜è¾¹ç¼˜ingress</span><span class="token operator">-</span><span class="token plain">controller podè®¿é—®kube</span><span class="token operator">-</span><span class="token plain">apiserverçš„æ•°æ®</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  cache_agents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ingress-controller&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4æ€»ç»“">4.æ€»ç»“<a aria-hidden="true" class="hash-link" href="#4æ€»ç»“" title="Direct link to heading">â€‹</a></h3><ul><li><p>å¦‚æœå­˜é‡Podæ— éœ€è®¿é—®kube-apiserveræˆ–è€…InClusterConfigè®¿é—®kube-apiserverï¼Œè¿™äº›ç±»å‹Podå¯ä»¥é›¶ä¿®æ”¹è¿è¡Œåˆ°OpenYurté›†ç¾¤çš„è¾¹ç¼˜ç¯å¢ƒä¸Šã€‚é€šè¿‡å…¶ä»–æ–¹å¼è®¿é—®kube-apiserverçš„ä¸šåŠ¡Podç›®å‰æ— æ³•ä¿è¯é›¶ä¿®æ”¹è¿è¡Œåˆ°è¾¹ç¼˜ç¯å¢ƒã€‚</p></li><li><p>è¾¹ç¼˜ä¸šåŠ¡Podæ˜¯å¦æ­£å¸¸è®¿é—®kube-apiserverï¼Œé¦–å…ˆå¯ä»¥æŸ¥çœ‹ä¸šåŠ¡podçš„ç¯å¢ƒå˜é‡æ˜¯å¦æ­£å¸¸ï¼š</p><p>KUBERNETES_SERVICE_HOST=127.0.0.1æˆ–è€…169.254.2.1ï¼ŒKUBERNETES_SERVICE_PORT=10268ã€‚ç„¶åå¯ä»¥æŸ¥çœ‹yurthubç»„ä»¶çš„æ—¥å¿—æ˜¯å¦æœ‰ä¸šåŠ¡Podç›¸å…³çš„è¯·æ±‚æ—¥å¿—ã€‚å½“ç„¶ä¹Ÿå¯ä»¥æŸ¥è¯¢ä¸šåŠ¡Podçš„æ—¥å¿—æ˜¯å¦æ­£å¸¸ã€‚æœ€åå¯ä»¥ç¡®è®¤/etc/kubernetes/cacheç›®å½•æ˜¯å¦æœ‰ç›¸å…³ç»„ä»¶çš„ç¼“å­˜æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥å†ç¡®è®¤kube-system/yurt-hub-cfg configmapæ˜¯å¦å·²ç»é…ç½®ã€‚</p></li><li><p>ä½¿ç”¨InClusterConfigçš„Podé›¶ä¿®æ”¹è¿è¡Œåˆ°è¾¹ç¼˜ç¯å¢ƒçš„èƒ½åŠ›ï¼Œæ•´ä½“å®ç°ç”±yurthubç»„ä»¶æ‰¿è½½ï¼Œæ²¡æœ‰ç»™OpenYurtæ¶æ„å¢åŠ é¢å¤–çš„è´Ÿæ‹…ï¼ŒåŒæ—¶ç”¨æˆ·åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯¹è¯¥èƒ½åŠ›ä¹ŸåŸºæœ¬æ— æ„ŸçŸ¥ï¼Œå¯¹åŸç”Ÿä¸šåŠ¡Podæ— ä¾µå…¥ã€‚</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ï¼š<a aria-hidden="true" class="hash-link" href="#å‚è€ƒé“¾æ¥" title="Direct link to heading">â€‹</a></h3><p>1.<a href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod" target="_blank" rel="noopener noreferrer">Accessing the API from a Pod</a></p><p>2.<a href="https://github.com/openyurtio/openyurt/blob/master/docs/proposals/20210720-data-filtering-framework.md" target="_blank" rel="noopener noreferrer">data filtering framework on the edge</a></p><p>3.<a href="https://mp.weixin.qq.com/s/4BLfvMJJA623ZwRSgUE69A" target="_blank" rel="noopener noreferrer">æ·±åº¦è§£è¯»OpenYurtï¼šè¾¹ç¼˜è‡ªæ²»èƒ½åŠ›è®¾è®¡è§£æ</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Edge-gateway-caching-capabilities">Elegant realization of edge gateway caching capabilities</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-03-29T00:00:00.000Z" itemprop="datePublished">March 29, 2021</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">rambohe</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img alt="image" src="/assets/images/OpenYurt-de0f93f0c16ddb05b6782cbe66107b22.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="openyurtå¦‚ä½•è§£å†³è¾¹ç¼˜è‡ªæ²»é—®é¢˜">OpenYurtå¦‚ä½•è§£å†³è¾¹ç¼˜è‡ªæ²»é—®é¢˜<a aria-hidden="true" class="hash-link" href="#openyurtå¦‚ä½•è§£å†³è¾¹ç¼˜è‡ªæ²»é—®é¢˜" title="Direct link to heading">â€‹</a></h2><p>æƒ³è¦å®ç°å°† Kubernetes ç³»ç»Ÿå»¶å±•åˆ°è¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œé‚£ä¹ˆè¾¹ç¼˜èŠ‚ç‚¹å°†é€šè¿‡å…¬ç½‘å’Œäº‘ç«¯è¿æ¥ï¼Œç½‘ç»œè¿æ¥æœ‰å¾ˆå¤§ä¸å¯æ§å› ç´ ï¼Œå¯èƒ½å¸¦æ¥è¾¹ç¼˜ä¸šåŠ¡è¿è¡Œçš„ä¸ç¨³å®šå› ç´ ï¼Œè¿™æ˜¯äº‘åŸç”Ÿå’Œè¾¹ç¼˜è®¡ç®—èåˆçš„ä¸»è¦éš¾ç‚¹ä¹‹ä¸€ã€‚</p><p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä½¿è¾¹ç¼˜ä¾§å…·æœ‰è‡ªæ²»èƒ½åŠ›ï¼Œå³å½“äº‘è¾¹ç½‘ç»œæ–­å¼€æˆ–è€…è¿æ¥ä¸ç¨³å®šæ—¶ï¼Œç¡®ä¿è¾¹ç¼˜ä¸šåŠ¡å¯ä»¥æŒç»­è¿è¡Œã€‚åœ¨ OpenYurt ä¸­ï¼Œè¯¥èƒ½åŠ›ç”± yurt-controller-manager å’Œ YurtHub ç»„ä»¶æä¾›ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1yurthubæ¶æ„">1ï¼‰Yurthubæ¶æ„<a aria-hidden="true" class="hash-link" href="#1yurthubæ¶æ„" title="Direct link to heading">â€‹</a></h3><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†YurtHub ç»„ä»¶çš„èƒ½åŠ›ã€‚å…¶æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img alt="image" src="/assets/images/yurthub-40267e14a620859d35d3085eb5de2d24.png">
YurtHubæ˜¯ä¸€ä¸ªå¸¦æœ‰æ•°æ®ç¼“å­˜åŠŸèƒ½çš„â€œé€æ˜ç½‘å…³â€ï¼Œå’Œäº‘ç«¯ç½‘ç»œæ–­è¿çŠ¶æ€ä¸‹ï¼Œå¦‚æœèŠ‚ç‚¹æˆ–è€…ç»„ä»¶é‡å¯ï¼Œå„ä¸ªç»„ä»¶ï¼ˆkubelet/kube-proxy ç­‰)å°†ä» YurtHub ä¸­è·å–åˆ°ä¸šåŠ¡å®¹å™¨ç›¸å…³æ•°æ®ï¼Œæœ‰æ•ˆè§£å†³è¾¹ç¼˜è‡ªæ²»çš„é—®é¢˜ã€‚è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè½»é‡çš„å¸¦æ•°æ®ç¼“å­˜èƒ½åŠ›çš„åå‘ä»£ç†ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2ç¬¬ä¸€æƒ³æ³•">2ï¼‰ç¬¬ä¸€æƒ³æ³•<a aria-hidden="true" class="hash-link" href="#2ç¬¬ä¸€æƒ³æ³•" title="Direct link to heading">â€‹</a></h3><p>å®ç°ä¸€ä¸ªç¼“å­˜æ•°æ®çš„åå‘ä»£ç†ï¼Œç¬¬ä¸€æƒ³æ³•å°±æ˜¯ä» response.Body ä¸­è¯»å–æ•°æ®ï¼Œç„¶ååˆ†åˆ«è¿”å›ç»™è¯·æ±‚ client å’Œæœ¬åœ°çš„ Cache æ¨¡å—ã€‚ä¼ªä»£ç å¦‚ä¸‹:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">func HandleResponse(rw http.ResponseWriter, resp *http.Response) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        bodyBytes, _ := ioutil.ReadAll(resp.Body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        go func() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // cache response on local disk</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                cacher.Write(bodyBytes)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // client reads data from response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        rw.Write(bodyBytes)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æ·±å…¥æ€è€ƒåï¼Œåœ¨ Kubernetes ç³»ç»Ÿä¸­ï¼Œä¸Šè¿°å®ç°ä¼šå¼•å‘ä¸‹é¢çš„é—®é¢˜ï¼š</p><ul><li><p>é—®é¢˜ 1ï¼šæµå¼æ•°æ®éœ€è¦å¦‚ä½•å¤„ç†(å¦‚: K8s ä¸­çš„ watch è¯·æ±‚)ï¼Œæ„å‘³ ioutil.ReadAll() ä¸€æ¬¡è°ƒç”¨æ— æ³•è¿”å›æ‰€æœ‰æ•°æ®ã€‚å³å¦‚ä½•å¯ä»¥è¿”å›æµæ•°æ®åŒæ—¶åˆç¼“å­˜æµæ•°æ®ã€‚</p></li><li><p>é—®é¢˜ 2ï¼šåŒæ—¶åœ¨æœ¬åœ°ç¼“å­˜æ•°æ®å‰ï¼Œæœ‰å¯èƒ½éœ€è¦å¯¹ä¼ å…¥çš„ byte slice æ•°æ®å…ˆè¿›è¡Œæ¸…æ´—å¤„ç†ã€‚è¿™æ„å‘³ç€éœ€è¦ä¿®æ”¹ byte sliceï¼Œæˆ–è€…å…ˆå¤‡ä»½ byte slice å†å¤„ç†ã€‚è¿™æ ·ä¼šé€ æˆå†…å­˜çš„å¤§é‡æ¶ˆè€—ï¼ŒåŒæ—¶é’ˆå¯¹æµå¼æ•°æ®ï¼Œåˆ°åº•ç”³è¯·å¤šå¤§çš„ slice ä¹Ÿä¸å¥½å¤„ç†ã€‚</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3-ä¼˜é›…å®ç°æ¢è®¨">3) ä¼˜é›…å®ç°æ¢è®¨<a aria-hidden="true" class="hash-link" href="#3-ä¼˜é›…å®ç°æ¢è®¨" title="Direct link to heading">â€‹</a></h3><p>é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†é—®é¢˜é€ä¸ªæŠ½è±¡ï¼Œå¯ä»¥å‘ç°æ›´ä¼˜é›…çš„å®ç°æ–¹æ³•ã€‚</p><ul><li>é—®é¢˜ 1ï¼šå¦‚ä½•å¯¹æµæ•°æ®åŒæ—¶è¿›è¡Œè¯»å†™</li></ul><p>é’ˆå¯¹æµå¼æ•°æ®çš„è¯»å†™(ä¸€è¾¹è¿”å›ä¸€è¾¹ç¼“å­˜)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶å®éœ€è¦çš„ä¸è¿‡æ˜¯æŠŠ response.Body(io.Reader) è½¬æ¢æˆä¸€ä¸ª io.Reader å’Œä¸€ä¸ª io.Writerã€‚æˆ–è€…è¯´æ˜¯ä¸€ä¸ª io.Reader å’Œ io.Writer åˆæˆä¸€ä¸ª io.Readerã€‚è¿™å¾ˆå®¹æ˜“å°±è”æƒ³åˆ° Linux é‡Œé¢çš„ Tee å‘½ä»¤ã€‚</p><p><img alt="image" src="/assets/images/responsebody_write-624eba73126f446b3e854e546b75d539.png"></p><p>è€Œåœ¨ Golang ä¸­ Tee å‘½ä»¤æ˜¯å®ç°å°±æ˜¯ io.TeeReaderï¼Œé‚£é—®é¢˜ 1 çš„ä¼ªä»£ç å¦‚ä¸‹:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">func HandleResponse(rw http.ResponseWriter, resp *http.Response) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // create TeeReader with response.Body and cacher</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        newRespBody := io.TeeReader(resp.Body, cacher)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // client reads data from response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        io.Copy(rw, newRespBody)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡ TeeReader çš„å¯¹ Response.Body å’Œ Cacher çš„æ•´åˆï¼Œå½“è¯·æ±‚ client ç«¯ä» response.Body ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå°†åŒæ—¶å‘ Cache ä¸­å†™å…¥è¿”å›æ•°æ®ï¼Œä¼˜é›…çš„è§£å†³äº†æµå¼æ•°æ®çš„å¤„ç†ã€‚</p><ul><li>é—®é¢˜ 2ï¼šå¦‚ä½•åœ¨ç¼“å­˜å‰å…ˆæ¸…æ´—æµæ•°æ®</li></ul><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¼“å­˜å‰å…ˆæ¸…æ´—æµæ•°æ®ï¼Œè¯·æ±‚ç«¯å’Œè¿‡æ»¤ç«¯éœ€è¦åŒæ—¶è¯»å– response.Bodyï¼ˆ2 æ¬¡è¯»å–é—®é¢˜ï¼‰ã€‚ä¹Ÿå°±æ˜¯éœ€è¦å°† response.Body(io.Reader) è½¬æ¢æˆä¸¤ä¸ª io.Readerã€‚</p><p><img alt="image" src="data:image/png;base64,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"></p><p>ä¹Ÿæ„å‘³ç€é—®é¢˜ 2 è½¬åŒ–æˆï¼šé—®é¢˜ 1 ä¸­ç¼“å­˜ç«¯çš„ io.Writer è½¬æ¢æˆ Data Filter çš„ io.Readerã€‚å…¶å®åœ¨ Linux å‘½ä»¤ä¸­ä¹Ÿèƒ½æ‰¾åˆ°ç±»ä¼¼å‘½ä»¤ï¼Œå°±æ˜¯ç®¡é“ã€‚å› æ­¤é—®é¢˜ 2 çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">func HandleResponse(rw http.ResponseWriter, resp *http.Response) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pr, pw := io.Pipe()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // create TeeReader with response.Body and Pipe writer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        newRespBody := io.TeeReader(resp.Body, pw)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        go func() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // filter reads data from response </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                io.Copy(dataFilter, pr)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // client reads data from response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        io.Copy(rw, newRespBody)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡ io.TeeReader å’Œ io.PiPeï¼Œå½“è¯·æ±‚ client ç«¯ä» response.Body ä¸­è¯»å–æ•°æ®æ—¶ï¼ŒFilter å°†åŒæ—¶ä» Response è¯»å–åˆ°æ•°æ®ï¼Œä¼˜é›…çš„è§£å†³äº†æµå¼æ•°æ®çš„ 2 æ¬¡è¯»å–é—®é¢˜ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurthubå®ç°">YurtHubå®ç°<a aria-hidden="true" class="hash-link" href="#yurthubå®ç°" title="Direct link to heading">â€‹</a></h2><p>æœ€åçœ‹ä¸€ä¸‹ YurtHub ä¸­ç›¸å…³å®ç°ï¼Œç”±äº Response.Body ä¸º io.ReadCloserï¼Œæ‰€ä»¥å®ç°äº† dualReadCloserã€‚åŒæ—¶ YurtHub å¯èƒ½ä¹Ÿé¢ä¸´å¯¹ http.Request çš„ç¼“å­˜ï¼Œæ‰€ä»¥å¢åŠ äº† isRespBody å‚æ•°ç”¨äºåˆ¤å®šæ˜¯å¦éœ€è¦è´Ÿè´£å…³é—­ response.Bodyã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// https://github.com/openyurtio/openyurt/blob/master/pkg/yurthub/util/util.go#L156</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// NewDualReadCloser create an dualReadCloser object</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func NewDualReadCloser(rc io.ReadCloser, isRespBody bool) (io.ReadCloser, io.ReadCloser) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pr, pw := io.Pipe()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dr := &amp;dualReadCloser{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        rc:         rc,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pw:         pw,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        isRespBody: isRespBody,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return dr, pr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">type dualReadCloser struct {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rc io.ReadCloser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pw *io.PipeWriter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // isRespBody shows rc(is.ReadCloser) is a response.Body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // or not(maybe a request.Body). if it is true(it&#x27;s a response.Body),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // we should close the response body in Close func, else not,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // it(request body) will be closed by http request caller</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    isRespBody bool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Read read data into p and write into pipe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (dr *dualReadCloser) Read(p []byte) (n int, err error) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n, err = dr.rc.Read(p)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if n &gt; 0 {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if n, err := dr.pw.Write(p[:n]); err != nil {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            klog.Errorf(&quot;dualReader: failed to write %v&quot;, err)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return n, err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Close close two readers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (dr *dualReadCloser) Close() error {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    errs := make([]error, 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if dr.isRespBody {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if err := dr.rc.Close(); err != nil {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            errs = append(errs, err)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if err := dr.pw.Close(); err != nil {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        errs = append(errs, err)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(errs) != 0 {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return fmt.Errorf(&quot;failed to close dualReader, %v&quot;, errs)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨ä½¿ç”¨ dualReadCloser æ—¶ï¼Œå¯ä»¥åœ¨ httputil.NewSingleHostReverseProxy çš„ modifyResponse() æ–¹æ³•ä¸­çœ‹åˆ°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// https://github.com/openyurtio/openyurt/blob/master/pkg/yurthub/proxy/remote/remote.go#L85</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (rp *RemoteProxy) modifyResponse(resp *http.Response) error {rambohe-ch, 10 months ago: â€¢ hello openyurt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // çœç•¥éƒ¨åˆ†å‰ç½®æ£€æŸ¥                                                          </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rc, prc := util.NewDualReadCloser(resp.Body, true)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            go func(ctx context.Context, prc io.ReadCloser, stopCh &lt;-chan struct{}) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                err := rp.cacheMgr.CacheResponse(ctx, prc, stopCh)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if err != nil &amp;&amp; err != io.EOF &amp;&amp; err != context.Canceled {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    klog.Errorf(&quot;%s response cache ended with error, %v&quot;, util.ReqString(req), err)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }(ctx, prc, rp.stopCh)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            resp.Body = rc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æ€»ç»“">æ€»ç»“<a aria-hidden="true" class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h2><p>OpenYurt äº 2020 å¹´ 9 æœˆè¿›å…¥ CNCF æ²™ç®±åï¼ŒæŒç»­ä¿æŒäº†å¿«é€Ÿå‘å±•å’Œè¿­ä»£ï¼Œåœ¨ç¤¾åŒºåŒå­¦ä¸€èµ·åŠªåŠ›ä¸‹ï¼Œç›®å‰å·²ç»å¼€æºçš„èƒ½åŠ›æœ‰ï¼š</p><ul><li>è¾¹ç¼˜è‡ªæ²»</li><li>è¾¹ç¼˜å•å…ƒåŒ–ç®¡ç†</li><li>äº‘è¾¹ååŒè¿ç»´</li><li>ä¸€é”®å¼æ— ç¼è½¬æ¢èƒ½åŠ›</li></ul><p><a href="https://mp.weixin.qq.com/s/vdFrCDiIhPLVbOnf6vRxEw" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/yurthub">yurthub</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Play-with-OpenYurt-on-Raspberry-Pi">Getting Started with OpenYurt:play with OpenYurt on Raspberry Pi</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-01-05T00:00:00.000Z" itemprop="datePublished">January 5, 2021</time> Â· <!-- -->18 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/zyjhtangtang" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/zyjhtangtang.png" alt="zyjhtangtang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zyjhtangtang" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zyjhtangtang</span></a></div><small class="avatar__subtitle" itemprop="description">Member of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img alt="image" src="/assets/images/Raspberry_Pi-0d62d9c9627727b87279383f61ae8222.png"></p><p>éšç€è¾¹ç¼˜è®¡ç®—çš„å¿«é€Ÿå‘å±•ï¼Œè¶Šæ¥è¶Šå¤šçš„æ•°æ®éœ€è¦åˆ°ç½‘ç»œçš„è¾¹ç¼˜ä¾§è¿›è¡Œå­˜å‚¨ã€å¤„ç†å’Œåˆ†æï¼Œè¾¹ç¼˜çš„è®¾å¤‡å’Œåº”ç”¨å‘ˆçˆ†å‘å¼å¢é•¿ã€‚å¦‚ä½•é«˜æ•ˆçš„ç®¡ç†è¾¹ç¼˜ä¾§çš„èµ„æºå’Œåº”ç”¨æ˜¯ä¸šç•Œé¢ä¸´çš„ä¸€ä¸ªä¸»è¦é—®é¢˜ã€‚å½“å‰ï¼Œé‡‡ç”¨äº‘åŸç”Ÿçš„æ–¹æ³•ï¼Œå°†äº‘è®¡ç®—çš„èƒ½åŠ›ä¸‹æ²‰åˆ°è¾¹ç¼˜å¹¶åœ¨äº‘ç«¯åšç»Ÿä¸€è°ƒåº¦ã€ç®¡æ§çš„äº‘è¾¹ç«¯ä¸€ä½“åŒ–æ¶æ„å¾—åˆ°äº†ä¸šç•Œçš„å¹¿æ³›è®¤å¯ã€‚</p><p>2020 å¹´ 5 æœˆï¼Œé˜¿é‡Œå·´å·´å¼€æºé¦–ä¸ª Kubernetes æ— ä¾µå…¥çš„è¾¹ç¼˜è®¡ç®—äº‘åŸç”Ÿé¡¹ç›® OpenYurtï¼Œå¹¶äºåŒå¹´ 9 æœˆä»½è¿›å…¥ CNCF SandBoxã€‚OpenYurt é’ˆå¯¹è¾¹ç¼˜åœºæ™¯ä¸­ç½‘ç»œä¸ç¨³å®šã€äº‘è¾¹è¿ç»´å›°éš¾ç­‰é—®é¢˜ï¼Œå¯¹åŸç”Ÿ Kubernetes æ— ä¾µå…¥åœ°å¢å¼ºï¼Œé‡ç‚¹æä¾›äº†è¾¹ç¼˜èŠ‚ç‚¹è‡ªæ²»ã€äº‘è¾¹è¿ç»´é€šé“ã€è¾¹ç¼˜å•å…ƒåŒ–çš„èƒ½åŠ›ã€‚</p><p>å¦‚å›¾ä¸‹æ‰€ç¤ºï¼Œ
<img alt="image" src="/assets/images/kubernetes-324e5f10b1e66083e02453040890714b.png"></p><p>æœ¬æ–‡é€šè¿‡åœ¨äº‘ç«¯éƒ¨ç½² Kubernetes é›†ç¾¤çš„æ§åˆ¶é¢ï¼Œå¹¶å°†æ ‘è“æ´¾æ¥å…¥é›†ç¾¤æ¥æ­å»ºäº‘ç®¡è¾¹åœºæ™¯ã€‚åŸºäºè¿™ä¸ªç¯å¢ƒæ¼”ç¤º OpenYurt çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå¸¦å¤§å®¶å¿«é€Ÿä¸Šæ‰‹ OpenYurtã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡<a aria-hidden="true" class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1åŸºç¡€ç¯å¢ƒä»‹ç»">1ï¼‰åŸºç¡€ç¯å¢ƒä»‹ç»<a aria-hidden="true" class="hash-link" href="#1åŸºç¡€ç¯å¢ƒä»‹ç»" title="Direct link to heading">â€‹</a></h3><p>åœ¨äº‘ç«¯ï¼Œè´­ä¹° ENS èŠ‚ç‚¹ï¼ˆENS èŠ‚ç‚¹å…·æœ‰å…¬ç½‘ IPï¼Œæ–¹ä¾¿é€šè¿‡å…¬ç½‘å¯¹å¤–æš´éœ²æœåŠ¡ï¼‰æ¥éƒ¨ç½²åŸç”Ÿ K8s é›†ç¾¤çš„ç®¡æ§ç»„ä»¶ã€‚å…¶ä¸­ç³»ç»Ÿé‡‡ç”¨ ubuntu18.04ã€hostname ä¸º master-nodeã€docker ç‰ˆæœ¬ä¸º 19.03.5ã€‚</p><p>åœ¨è¾¹ç¼˜ï¼Œå°†æ ‘è“æ´¾ 4 ä¸æœ¬åœ°çš„è·¯ç”±å™¨è¿æ¥ï¼Œç»„æˆè¾¹ç¼˜ç§ç½‘ç¯å¢ƒï¼Œè·¯ç”±å™¨é€šè¿‡ 4G ç½‘å¡è®¿é—®äº’è”ç½‘ã€‚å…¶ä¸­æ ‘è“æ´¾ 4 é¢„è£…ç³»ç»Ÿä¸º ubuntu18.04ã€hostnameä¸º edge-nodeã€docker ç‰ˆæœ¬ä¸º 19.03.5ã€‚
<img alt="image" src="/assets/images/edge_raspberry_pi-8b6984239d5bceffe23207955be08dfa.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2åŸç”Ÿk8sé›†ç¾¤æ­å»º">2)åŸç”ŸK8sé›†ç¾¤æ­å»º<a aria-hidden="true" class="hash-link" href="#2åŸç”Ÿk8sé›†ç¾¤æ­å»º" title="Direct link to heading">â€‹</a></h3><p>æœ¬æ–‡æ¼”ç¤ºç¯å¢ƒåŸºäºç¤¾åŒº1.16.6ç‰ˆæœ¬çš„K8sé›†ç¾¤ï¼Œå¹¶é‡‡ç”¨ç¤¾åŒºæä¾›çš„kubeadmå·¥å…·æ¥æ­å»ºé›†ç¾¤ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åœ¨äº‘ç«¯èŠ‚ç‚¹å’Œæ ‘è“æ´¾ä¸Šåˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£… Kubernetes ç»„ä»¶ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo &quot;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot; &gt; /etc/apt/sources.list.d/kubernetes.list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt-get update</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt install -y kubelet=1.16.6-00 kubeadm=1.16.6-00 kubectl=1.16.6-00</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ä½¿ç”¨kubeadm åˆå§‹åŒ–äº‘ç«¯èŠ‚ç‚¹ï¼ˆåœ¨äº‘ç«¯èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼‰ï¼Œéƒ¨ç½²è¿‡ç¨‹ä¸­é‡‡ç”¨é˜¿é‡Œäº‘çš„é•œåƒä»“åº“ï¼Œä¸ºäº†æ”¯æŒæ ‘è“æ´¾çš„æ¥å…¥ï¼Œè¯¥ä»“åº“çš„é•œåƒåšäº† manifest åˆ—è¡¨ï¼Œèƒ½å¤Ÿæ”¯æŒ amd64/arm64 ä¸¤ç§ä¸åŒçš„ CPU æ¶æ„ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># master-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubeadm init --image-repository=registry.cn-hangzhou.aliyuncs.com/edge-kubernetes --kubernetes-version=v1.16.6 --pod-network-cidr=10.244.0.0/16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ä¾æ®åˆå§‹åŒ–å®Œæˆä¹‹åçš„æç¤ºï¼Œæ‹·è´ config æ–‡ä»¶åˆ° $HOME/.kube ä¸­ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ ‘è“æ´¾æ¥å…¥äº‘ç«¯é›†ç¾¤ä¾æ®ç¬¬äºŒæ­¥ä¸­åˆå§‹åŒ–å®Œæˆä»¥åè¾“å‡ºçš„èŠ‚ç‚¹æ¥å…¥ä¿¡æ¯ï¼Œåœ¨æ ‘è“æ´¾ä¸Šæ‰§è¡Œæ¥å…¥å‘½ä»¤ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubeadm join 183.195.233.42:6443 --token XXXX \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> --discovery-token-ca-cert-hash XXXX</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ·»åŠ  cni é…ç½®ï¼ˆäº‘ç«¯ç®¡æ§èŠ‚ç‚¹å’Œæ ‘è“æ´¾éƒ½éœ€è¦é…ç½®ï¼‰ï¼Œæœ¬æ–‡æ­å»ºçš„é›†ç¾¤ä½¿ç”¨ä¸»æœºç½‘ç»œã€‚åˆ›å»º cni é…ç½®æ–‡ä»¶ /etc/cni/net.d/0-loopback.confï¼Œå¹¶å°†å¦‚ä¸‹å†…å®¹æ‹·è´åˆ°è¯¥æ–‡ä»¶ä¸­ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;name&quot;: &quot;lo&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;type&quot;: &quot;loopback&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>åœ¨ master èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹éƒ¨ç½²æ•ˆæœã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   74s    v1.16.6   192.168.0.100    &lt;none&gt;        Ubuntu 18.04.4 LTS   4.19.105-v8-28      docker://19.3.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   2m5s   v1.16.6   183.195.233.42   &lt;none&gt;        Ubuntu 18.04.2 LTS   4.15.0-52-generic   docker://19.3.5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>åˆ é™¤ CoreDNSï¼ˆæœ¬æ–‡ Demo ä¸­ CoreDNS ä¸éœ€è¦ä½¿ç”¨ï¼‰ï¼Œå¹¶å°† master èŠ‚ç‚¹çš„ taints å»æ‰ï¼ˆæ–¹ä¾¿åç»­éƒ¨ç½² OpenYurt ç»„ä»¶ï¼‰ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete deployment coredns -n kube-system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl taint node master-node node-role.kubernetes.io/master-</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="åŸç”Ÿ-k8s-é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„é—®é¢˜">åŸç”Ÿ K8s é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„é—®é¢˜<a aria-hidden="true" class="hash-link" href="#åŸç”Ÿ-k8s-é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„é—®é¢˜" title="Direct link to heading">â€‹</a></h2><p>åŸºäºä¸Šè¿°ç¯å¢ƒï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹åŸç”Ÿ K8s åœ¨äº‘ç®¡è¾¹æ¶æ„ä¸­å¯¹äº‘è¾¹è¿ç»´çš„æ”¯æŒå’Œå¯¹äº‘è¾¹ç½‘ç»œæ–­å¼€æ—¶çš„ååº”ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä»äº‘ç«¯éƒ¨ç½²ä¸€ä¸ªæµ‹è¯•åº”ç”¨ nginxï¼Œåœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ kubectl apply -f nginx.yamlï¼Œå…·ä½“çš„éƒ¨ç½² yaml å¦‚ä¸‹ã€‚</p><p>æ³¨æ„ï¼šnodeSelector é€‰æ‹© edge-node èŠ‚ç‚¹ï¼Œä¸»æœºç½‘ç»œé…ç½®ä¸º trueï¼Œå¹¶é…ç½® pod çš„å®¹å¿æ—¶é—´ä¸º 5sï¼ˆé»˜è®¤ 5min, æ­¤å¤„é…ç½®ä¾¿äºæ¼”ç¤º pod é©±é€ï¼‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - key: &quot;node.kubernetes.io/unreachable&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> operator: &quot;Exists&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> effect: &quot;NoExecute&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerationSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - key: &quot;node.kubernetes.io/not-ready&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> operator: &quot;Exists&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> effect: &quot;NoExecute&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerationSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> nodeSelector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> kubernetes.io/hostname: edge-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> image: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> hostNetwork: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æŸ¥çœ‹éƒ¨ç½²ç»“æœï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 11s 192.168.0.100 edge-node &lt;none&gt; </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1æµ‹è¯•å¸¸ç”¨çš„é›†ç¾¤è¿ç»´æŒ‡ä»¤åŒ…æ‹¬-logsexecport-forward">1ï¼‰æµ‹è¯•å¸¸ç”¨çš„é›†ç¾¤è¿ç»´æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ logsã€execã€port-forward<a aria-hidden="true" class="hash-link" href="#1æµ‹è¯•å¸¸ç”¨çš„é›†ç¾¤è¿ç»´æŒ‡ä»¤åŒ…æ‹¬-logsexecport-forward" title="Direct link to heading">â€‹</a></h3><p>åœ¨ master èŠ‚ç‚¹ä¸Šè¿ç»´è¾¹ç¼˜èŠ‚ç‚¹åº”ç”¨ï¼Œæ‰§è¡Œ logs/exec/port-forward ç­‰æŒ‡ä»¤ï¼ŒæŸ¥çœ‹ç»“æœã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl logs nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Error from server: Get https://192.168.0.100:10250/containerLogs/default/nginx/nginx: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl exec -it nginx sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Error from server: error dialing backend: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl port-forward pod/nginx 8888:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">error: error upgrading connection: error dialing backend: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»æ‰§è¡Œç»“æœçœ‹ï¼ŒåŸç”Ÿçš„k8såœ¨äº‘ç®¡è¾¹çš„åœºæ™¯ä¸­ï¼Œæ— æ³•æä¾›ä»äº‘ç«¯è¿ç»´è¾¹ç¼˜åº”ç”¨çš„èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸ºè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²åœ¨ç”¨æˆ·çš„ç§ç½‘ç¯å¢ƒï¼Œä»äº‘ç«¯æ— æ³•é€šè¿‡è¾¹ç¼˜èŠ‚ç‚¹çš„ IP åœ°å€ç›´æ¥è®¿é—®è¾¹ç¼˜èŠ‚ç‚¹ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“">2ï¼‰æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“<a aria-hidden="true" class="hash-link" href="#2æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“" title="Direct link to heading">â€‹</a></h3><p>è¾¹ç¼˜èŠ‚ç‚¹ä¸äº‘ç«¯ç®¡æ§é€šè¿‡å…¬ç½‘è¿æ¥ï¼Œç»å¸¸ä¼šå‡ºç°ç½‘ç»œä¸ç¨³å®šï¼Œäº‘ç«¯æ–­è¿çš„æƒ…å†µã€‚è¿™é‡Œæˆ‘ä»¬å°†åšä¸¤ä¸ªæ–­ç½‘ç›¸å…³çš„æµ‹è¯•ï¼š</p><ul><li><p>æ–­ç½‘ 1 åˆ†é’Ÿ-&gt;æ¢å¤ç½‘ç»œ</p></li><li><p>æ–­ç½‘ 1 åˆ†é’Ÿ-&gt;é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-&gt;æ¢å¤ç½‘ç»œ</p></li></ul><p>è§‚å¯Ÿä¸¤ä¸ªæµ‹è¯•è¿‡ç¨‹ä¸­èŠ‚ç‚¹å’Œ Pod çš„çŠ¶æ€å˜åŒ–ã€‚æœ¬æ–‡ Demo ä¸­çš„æ–­ç½‘æ–¹å¼æ˜¯å°†è·¯ç”±å™¨çš„å…¬ç½‘è¿æ¥æ–­å¼€ã€‚</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="1æ–­ç½‘1åˆ†é’Ÿ-æ¢å¤ç½‘ç»œ">1.æ–­ç½‘1åˆ†é’Ÿ-&gt;æ¢å¤ç½‘ç»œ<a aria-hidden="true" class="hash-link" href="#1æ–­ç½‘1åˆ†é’Ÿ-æ¢å¤ç½‘ç»œ" title="Direct link to heading">â€‹</a></h4><p>æ–­å¼€ç½‘ç»œï¼Œå¤§çº¦ 40s åï¼ŒèŠ‚ç‚¹å˜æˆ NotReadyï¼ˆæ­£å¸¸èŠ‚ç‚¹ 10s é’Ÿä¸ŠæŠ¥ä¸€æ¬¡å¿ƒè·³ï¼Œå½“ 4 æ¬¡æ²¡æœ‰ä¸ŠæŠ¥å¿ƒè·³æ—¶ï¼Œç®¡æ§ç»„ä»¶è®¤ä¸ºèŠ‚ç‚¹å¼‚å¸¸ï¼‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node NotReady &lt;none&gt;   5m13s   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready      master   6m4s    v1.16.6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç»§ç»­ç­‰å¾… 5s ä¹‹åï¼ˆæ­£å¸¸èŠ‚ç‚¹å˜ä¸º NotReady ä¹‹åï¼Œ5m æ‰å¼€å§‹é©±é€ podï¼Œæ­¤å¤„ä¸ºäº†æµ‹è¯•æ•ˆæœï¼Œå°† pod çš„å®¹å¿æ—¶é—´é…æˆäº† 5sï¼‰ï¼Œåº”ç”¨ pod è¢«é©±é€ï¼ŒçŠ¶æ€å˜ä¸º Terminatingã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Terminating 0 3m45s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å°†ç½‘ç»œæ¢å¤ï¼Œè§‚å¯ŸèŠ‚ç‚¹åŠ pod å˜åŒ–ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">No resources found in default namespace.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç½‘ç»œæ¢å¤åï¼ŒèŠ‚ç‚¹çŠ¶æ€å˜æˆ readyï¼Œä¸šåŠ¡ pod è¢«æ¸…é™¤ï¼Œè¿™æ˜¯å› ä¸ºè¾¹ç¼˜èŠ‚ç‚¹çš„ Kubelet è·å–åˆ°ä¸šåŠ¡ Pod çš„ Terminating çŠ¶æ€ï¼Œå¯¹ä¸šåŠ¡ Pod åšåˆ é™¤æ“ä½œï¼Œå¹¶è¿”å›åˆ é™¤æˆåŠŸï¼Œäº‘ç«¯ä¹Ÿåšäº†ç›¸åº”çš„æ¸…ç†ã€‚è‡³æ­¤ï¼Œä¸šåŠ¡ Pod ç”±äºäº‘è¾¹ç½‘ç»œçš„ä¸ç¨³å®šè€Œè¢«é©±é€ï¼Œç„¶è€Œåœ¨æ–­ç½‘æœŸé—´ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å…¶å®æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚</p><p>é‡æ–°åˆ›å»ºåº”ç”¨ nginxï¼Œç”¨äºä¸‹é¢æµ‹è¯•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 4s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="2æ–­ç½‘1åˆ†é’Ÿ-é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-æ¢å¤ç½‘ç»œ">2.æ–­ç½‘1åˆ†é’Ÿ-&gt;é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-&gt;æ¢å¤ç½‘ç»œ<a aria-hidden="true" class="hash-link" href="#2æ–­ç½‘1åˆ†é’Ÿ-é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-æ¢å¤ç½‘ç»œ" title="Direct link to heading">â€‹</a></h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æµ‹è¯•åœ¨æ–­ç½‘çš„æƒ…å†µä¸‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹çš„é‡å¯å¯¹ä¸šåŠ¡çš„å½±å“ã€‚æ–­ç½‘ 1 åˆ†é’Ÿä¹‹åï¼ŒNode å’Œ Pod çŠ¶æ€åŒä¸Šé¢æµ‹è¯•ç»“æœï¼ŒNode å˜ä¸º NotReadyï¼ŒPod çš„çŠ¶æ€å˜ä¸º Terminatingã€‚æ­¤æ—¶ï¼Œåˆ‡æ¢åˆ°ç§æœ‰ç½‘ç»œç¯å¢ƒï¼Œç™»å½•åˆ°æ ‘è“æ´¾ä¸Šï¼Œå°†æ ‘è“æ´¾é‡å¯ï¼Œé‡å¯å®Œæˆåç­‰å¾…å¤§çº¦ 1 åˆ†é’Ÿï¼Œè§‚å¯Ÿé‡å¯å‰åèŠ‚ç‚¹ä¸Šçš„å®¹å™¨åˆ—è¡¨ã€‚</p><p>é‡å¯å‰è¾¹ç¼˜èŠ‚ç‚¹å®¹å™¨åˆ—è¡¨ï¼ˆæ­¤æ—¶äº‘è¾¹ç«¯å¼€ï¼Œè™½ç„¶åœ¨äº‘ç«¯è·å–çš„ pod æ˜¯ Terminating çŠ¶æ€ï¼Œä½†æ˜¯è¾¹ç¼˜å¹¶æœª Watch åˆ° Terminating çš„æ“ä½œï¼Œæ‰€ä»¥è¾¹ç¼˜çš„åº”ç”¨è¿˜æ­£å¸¸è¿è¡Œï¼‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">9671cbf28ca6 e86f991e5d10 &quot;/docker-entrypoint.â€¦&quot; About a minute ago Up About a minute k8s_nginx_nginx_default_efdf11c6-a41c-4b95-8ac8-45e02c9e1f4d_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">6272a46f93ef registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 2 minutes ago Up About a minute k8s_POD_nginx_default_efdf11c6-a41c-4b95-8ac8-45e02c9e1f4d_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">698bb024c3db f9ea384ddb34 &quot;/usr/local/bin/kubeâ€¦&quot; 8 minutes ago Up 8 minutes k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">31952700c95b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 8 minutes ago Up 8 minutes k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é‡å¯åèŠ‚ç‚¹å®¹å™¨åˆ—è¡¨ï¼Œæ–­ç½‘é‡å¯åï¼Œkubelet æ— æ³•ä»äº‘ç«¯è·å– Pod ä¿¡æ¯ï¼Œä¸ä¼šé‡å»º Podã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»é‡å¯å‰åçš„å¯¹æ¯”çœ‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹åœ¨æ–­ç½‘é‡å¯ä¹‹åï¼ŒèŠ‚ç‚¹ä¸Šçš„ Pod å…¨éƒ¨æ— æ³•æ¢å¤ã€‚è¿™å°±ä¼šå¯¼è‡´åœ¨äº‘è¾¹æ–­ç½‘æ—¶ï¼Œä¸€æ—¦èŠ‚ç‚¹é‡å¯ï¼Œåº”ç”¨å°†æ— æ³•å·¥ä½œã€‚</p><p>å°†ç½‘ç»œæ¢å¤ï¼Œè§‚å¯ŸèŠ‚ç‚¹åŠ pod å˜åŒ–ï¼ŒåŒä¸Šé¢æµ‹è¯•ç»“æœï¼Œç½‘ç»œæ¢å¤åï¼ŒèŠ‚ç‚¹å˜ä¸º Readyï¼Œä¸šåŠ¡ Pod è¢«æ¸…é™¤ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   11m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   12m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">No resources found in default namespace.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥ï¼Œå†æ¬¡éƒ¨ç½²ä¸šåŠ¡ nginxï¼Œæµ‹è¯• OpenYurt é›†ç¾¤å¯¹äº‘è¾¹è¿ç»´çš„æ”¯æŒå’Œå¯¹äº‘è¾¹æ–­ç½‘æ—¶çš„ååº”ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 12s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="åŸç”Ÿ-k8s-é›†ç¾¤ä¸€é”®è½¬æ¢ä¸º-openyurt-é›†ç¾¤">åŸç”Ÿ K8s é›†ç¾¤ä¸€é”®è½¬æ¢ä¸º OpenYurt é›†ç¾¤<a aria-hidden="true" class="hash-link" href="#åŸç”Ÿ-k8s-é›†ç¾¤ä¸€é”®è½¬æ¢ä¸º-openyurt-é›†ç¾¤" title="Direct link to heading">â€‹</a></h2><p>æ¢ç©¶äº†åŸç”Ÿ Kubernetes åœ¨äº‘è¾¹ä¸€ä½“åŒ–æ¶æ„ä¸­çš„ä¸è¶³ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ OpenYurt é›†ç¾¤æ˜¯å¦èƒ½æ»¡è¶³è¿™ç§åœºæ™¯ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åˆ©ç”¨ OpenYurt ç¤¾åŒºæä¾›çš„é›†ç¾¤è½¬æ¢å·¥å…· yurtctlï¼Œæ¥å°†åŸç”Ÿ K8s é›†ç¾¤è½¬æ¢æˆ OpenYurt é›†ç¾¤ã€‚åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ è¯¥å‘½ä»¤æŒ‡å®šäº†ç»„ä»¶çš„é•œåƒä»¥åŠäº‘ç«¯èŠ‚ç‚¹ï¼Œå¹¶æŒ‡å®šå®‰è£…äº‘è¾¹è¿ç»´é€šé“ yurt-tunnelã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurtctl convert --yurt-controller-manager-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-controller-manager:v0.2.1 --yurt-tunnel-agent-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-agent:v0.2.1 --yurt-tunnel-server-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-server:v0.2.1 --yurtctl-servant-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurtctl-servant:v0.2.1 --yurthub-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurthub:v0.2.1 --cloud-nodes=master-node --deploy-yurttunnel</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è½¬æ¢å¤§æ¦‚éœ€è¦ 2minï¼Œè½¬æ¢å®Œæˆä¹‹åï¼Œè§‚å¯Ÿä¸šåŠ¡ pod çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°è½¬æ¢è¿‡ç¨‹ä¸­å¯¹ä¸šåŠ¡ pod æ— å½±å“ï¼ˆä¹Ÿå¯ä»¥åœ¨è½¬æ¢è¿‡ç¨‹ä¸­åœ¨æ–°çš„ç»ˆç«¯ä½¿ç”¨ kubectl get pod -w è§‚å¯Ÿä¸šåŠ¡ pod çš„çŠ¶æ€ï¼‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 2m4s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ‰§è¡Œå®Œæˆä¹‹åçš„ç»„ä»¶åˆ†å¸ƒå¦‚ä¸‹å›¾ æ‰€ç¤ºï¼Œå…¶ä¸­æ©™è‰²éƒ¨åˆ†æ˜¯ OpenYurt ç›¸å…³çš„ç»„ä»¶ï¼Œè“è‰²éƒ¨åˆ†æ˜¯åŸç”Ÿ K8s ç»„ä»¶ã€‚ç›¸åº”åœ°ï¼Œæˆ‘ä»¬è§‚å¯Ÿäº‘ç«¯èŠ‚ç‚¹å’Œè¾¹ç¼˜èŠ‚ç‚¹çš„ podã€‚</p><p><img alt="image" src="/assets/images/OpenYurt_Cluster-cf4d0928fd91e30dec6fc5ea7f13179b.png"></p><p>äº‘ç«¯èŠ‚ç‚¹ yurt ç›¸å…³çš„ podï¼šyurt-controller-manager å’Œ yurt-tunnel-serverã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods --all-namespaces -owide | grep master | grep yurt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system yurt-controller-manager-7d9db5bf85-6542h 1/1 Running 0 103s 183.195.233.42 master-node &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system   yurt-tunnel-server-65784dfdf-pl5bn         1/1     Running   0          103s    183.195.233.42   master-node   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¾¹ç¼˜èŠ‚ç‚¹æ–°å¢ yurt ç›¸å…³çš„ pod: yurt-hubï¼ˆstatic podï¼‰å’Œ yurt-tunnel-agentã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods --all-namespaces -owide | grep edge | grep yurt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system yurt-hub-edge-node 1/1 Running 0 117s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system   yurt-tunnel-agent-7l8nv                    1/1     Running   0          2m      192.168.0.100    edge-node     &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æµ‹è¯•-openyurt-é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„èƒ½åŠ›">æµ‹è¯• OpenYurt é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„èƒ½åŠ›<a aria-hidden="true" class="hash-link" href="#æµ‹è¯•-openyurt-é›†ç¾¤åœ¨è¾¹ç¼˜åœºæ™¯ä¸­çš„èƒ½åŠ›" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1-æµ‹è¯•-logsexecport-forward-ç­‰è¿ç»´æŒ‡ä»¤æŸ¥çœ‹ç»“æœ">1. æµ‹è¯• logs/exec/port-forward ç­‰è¿ç»´æŒ‡ä»¤ï¼ŒæŸ¥çœ‹ç»“æœ<a aria-hidden="true" class="hash-link" href="#1-æµ‹è¯•-logsexecport-forward-ç­‰è¿ç»´æŒ‡ä»¤æŸ¥çœ‹ç»“æœ" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl logs nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Configuration complete; ready for start up</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl exec -it nginx sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># ls</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bin dev docker-entrypoint.sh home media opt root sbin sys usr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">boot docker-entrypoint.d etc lib mnt proc run srv tmp var</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># exit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl port-forward pod/nginx 8888:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Forwarding from 127.0.0.1:8888 -&gt; 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Handling connection for 8888</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æµ‹è¯• port-forward æ—¶ï¼Œåœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ curl 127.0.0.1:8888ï¼Œå¯ä»¥è®¿é—® nginx æœåŠ¡ã€‚</p><p>ä»æ¼”ç¤ºç»“æœçœ‹ï¼ŒOpenYurt èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¯æŒå¸¸ç”¨çš„äº‘è¾¹è¿ç»´æŒ‡ä»¤ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2-æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“">2. æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“<a aria-hidden="true" class="hash-link" href="#2-æµ‹è¯•è¾¹ç¼˜æ–­ç½‘æ—¶å¯¹ä¸šåŠ¡çš„å½±å“" title="Direct link to heading">â€‹</a></h3><p>åŒæ ·æˆ‘ä»¬é‡å¤åŸç”Ÿ K8s ä¸­æ–­ç½‘çš„ä¸¤ä¸ªæµ‹è¯•ï¼Œåœ¨æµ‹è¯•ä¹‹å‰æˆ‘ä»¬å…ˆä¸ºè¾¹ç¼˜èŠ‚ç‚¹ edge-node å¼€å¯è‡ªæ²»ã€‚åœ¨ OpenYurt é›†ç¾¤ä¸­ï¼Œè¾¹ç¼˜èŠ‚ç‚¹çš„è‡ªæ²»æ˜¯é€šè¿‡ä¸€ä¸ª annotation æ¥æ ‡è¯†çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl annotate node edge-node node.beta.alibabacloud.com/autonomy=true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/edge-node annotated</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="1æ–­ç½‘-1-åˆ†é’Ÿ-ç½‘ç»œæ¢å¤">1ï¼‰æ–­ç½‘ 1 åˆ†é’Ÿ-&gt;ç½‘ç»œæ¢å¤<a aria-hidden="true" class="hash-link" href="#1æ–­ç½‘-1-åˆ†é’Ÿ-ç½‘ç»œæ¢å¤" title="Direct link to heading">â€‹</a></h4><p>åŒæ ·ï¼Œå°†è·¯ç”±å™¨å…¬ç½‘æ–­å¼€ï¼Œè§‚å¯Ÿ Node å’Œ Pod çš„çŠ¶æ€ã€‚å¤§çº¦è¿‡äº† 40sï¼ŒèŠ‚ç‚¹çš„çŠ¶æ€å˜æˆ NotReadyï¼Œè€Œå¤§çº¦è¿‡ 1min ä»¥åï¼ŒPod çš„çŠ¶æ€ä¸€ç›´æ˜¯ Runningï¼Œå¹¶ä¸ä¼šè¢«é©±é€ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node NotReady &lt;none&gt;   24m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready      master   25m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx   1/1     Running   0          5m7s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¢å¤ç½‘ç»œï¼Œè§‚å¯Ÿ Node å’Œ Pod çš„çŠ¶æ€ï¼ŒNode çŠ¶æ€å˜ä¸º Readyï¼ŒPod ä¿æŒ Runningã€‚å¯è§äº‘è¾¹ç½‘ç»œä¸ç¨³å®šæ—¶ï¼Œå¯¹è¾¹ç¼˜èŠ‚ç‚¹çš„ä¸šåŠ¡ Pod æ— å½±å“ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   25m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   26m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx   1/1     Running   0          6m30s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="2æ–­ç½‘-1-åˆ†é’Ÿ-é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-æ¢å¤ç½‘ç»œ">2ï¼‰æ–­ç½‘ 1 åˆ†é’Ÿ-&gt;é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-&gt;æ¢å¤ç½‘ç»œ<a aria-hidden="true" class="hash-link" href="#2æ–­ç½‘-1-åˆ†é’Ÿ-é‡å¯è¾¹ç¼˜èŠ‚ç‚¹-æ¢å¤ç½‘ç»œ" title="Direct link to heading">â€‹</a></h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æµ‹è¯•åœ¨æ–­ç½‘çš„æƒ…å†µä¸‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹çš„é‡å¯å¯¹ä¸šåŠ¡çš„å½±å“ã€‚æ–­ç½‘ 1 åˆ†é’Ÿä¹‹åï¼ŒNode å’Œ Pod çŠ¶æ€åŒä¸Šé¢æµ‹è¯•ç»“æœï¼ŒNode å˜ä¸º NotReadyï¼ŒPod ä¿æŒ Runningã€‚åŒæ ·ï¼Œæˆ‘ä»¬ç™»å½•åˆ°æ ‘è“æ´¾ä¸Šï¼Œå°†æ ‘è“æ´¾é‡å¯ï¼Œè§‚å¯Ÿé‡å¯å‰åèŠ‚ç‚¹ä¸Šçš„å®¹å™¨åˆ—è¡¨ã€‚</p><p>é‡å¯å‰è¾¹ç¼˜èŠ‚ç‚¹å®¹å™¨åˆ—è¡¨ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">38727ec9270c 70bf6668c7eb &quot;yurthub --v=2 --serâ€¦&quot; 7 minutes ago Up 7 minutes k8s_yurt-hub_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c403ace1d4ff registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">de0d693e9e74 473ae979be68 &quot;yurt-tunnel-agent -â€¦&quot; 7 minutes ago Up 7 minutes k8s_yurt-tunnel-agent_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a0763f143f74 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">80c247714402 e86f991e5d10 &quot;/docker-entrypoint.â€¦&quot; 7 minutes ago Up 7 minutes k8s_nginx_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">01f7770cb0f7 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">7e65f83090f6 f9ea384ddb34 &quot;/usr/local/bin/kubeâ€¦&quot; 17 minutes ago Up 17 minutes k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c1ed142fc75b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 17 minutes ago Up 17 minutes k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é‡å¯åè¾¹ç¼˜èŠ‚ç‚¹å®¹å™¨åˆ—è¡¨ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0c66b87066a0 473ae979be68 &quot;yurt-tunnel-agent -â€¦&quot; 12 seconds ago Up 11 seconds k8s_yurt-tunnel-agent_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a4fb3e4e8c8f e86f991e5d10 &quot;/docker-entrypoint.â€¦&quot; 58 seconds ago Up 56 seconds k8s_nginx_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fce730d64b32 f9ea384ddb34 &quot;/usr/local/bin/kubeâ€¦&quot; 58 seconds ago Up 57 seconds k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c78166ea563f registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 57 seconds k8s_POD_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">799ad14bcd3b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 57 seconds k8s_POD_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">627673da6a85 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 58 seconds k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">04da705e4120 70bf6668c7eb &quot;yurthub --v=2 --serâ€¦&quot; About a minute ago Up About a minute k8s_yurt-hub_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">260057d935ee registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; About a minute ago Up About a minute k8s_POD_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»é‡å¯å‰åçš„å¯¹æ¯”çœ‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹åœ¨æ–­ç½‘é‡å¯ä¹‹åï¼ŒèŠ‚ç‚¹ä¸Šçš„ pod èƒ½æ­£å¸¸æ‹‰èµ·ï¼ŒOpenYurt çš„èŠ‚ç‚¹è‡ªæ²»èƒ½åŠ›å¯ä»¥åœ¨æ–­ç½‘ä¸‹ä¿è¯ä¸šåŠ¡çš„ç¨³å®šè¿è¡Œã€‚</p><p>æ¢å¤ç½‘ç»œï¼ŒèŠ‚ç‚¹ Readyï¼Œè§‚å¯Ÿä¸šåŠ¡ pod çš„çŠ¶æ€ï¼Œç½‘ç»œæ¢å¤åï¼Œä¸šåŠ¡ pod çŠ¶æ€ä¿æŒ runningï¼Œæœ‰ä¸€æ¬¡é‡å¯è®°å½•ï¼Œç¬¦åˆé¢„æœŸã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 1 11m 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åï¼Œæˆ‘ä»¬ä»yurtctlçš„èƒ½åŠ›å°†OpenYurté›†ç¾¤ï¼Œè½¬æ¢ä¸ºåŸç”ŸK8sé›†ç¾¤ã€‚åŒæ ·ï¼Œå¯ä»¥è§‚å¯Ÿè½¬æ¢è¿‡ç¨‹ä¸­å¯¹ç°æœ‰ä¸šåŠ¡ä¸ä¼šæœ‰å½±å“ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurtctl revert --yurtctl-servant-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurtctl-servant:v0.2.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>OpenYurt ä½œä¸ºé˜¿é‡Œé¦–ä¸ªè¾¹ç¼˜äº‘åŸç”Ÿå¼€æºé¡¹ç›®ï¼ŒåŸºäºå•†ä¸šåŒ–äº§å“ ACK@Edgeï¼Œåœ¨é›†å›¢å†…éƒ¨ç»å†äº†é•¿æ—¶é—´çš„æ‰“ç£¨ã€‚å·²ç»åº”ç”¨åœ¨ CDNã€IoTã€ç›’é©¬ã€ENSã€èœé¸Ÿç‰©æµç­‰ä¼—å¤šåœºæ™¯ã€‚é’ˆå¯¹è¾¹ç¼˜åœºæ™¯ï¼Œè¯¥é¡¹ç›®åšæŒä¿æŒåŸç”Ÿ K8s çš„ç‰¹æ€§ï¼Œä»¥ Addon çš„å½¢å¼æä¾›äº†è¾¹ç¼˜èŠ‚ç‚¹è‡ªæ²»ã€äº‘è¾¹ç«¯ä¸€ä½“åŒ–è¿ç»´é€šé“ç­‰èƒ½åŠ›ã€‚æœ€è¿‘åœ¨ç¤¾åŒºåŒå­¦çš„ä¸€èµ·åŠªåŠ›ä¸‹åˆå¼€æºäº†è¾¹ç¼˜å•å…ƒåŒ–ç®¡ç†èƒ½åŠ›ï¼ŒåŒæ—¶åç»­è¿˜ä¼šç»§ç»­å¼€æºæ›´å¤šçš„è¾¹ç¼˜ç®¡ç†èƒ½åŠ›ï¼Œæ¬¢è¿å¤§å®¶ç§¯æå‚ä¸è´¡çŒ®ã€‚</p><p><a href="https://mp.weixin.qq.com/s/Anr8UhTaNe3FCnKKfKoXNQ" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Build-side-efficient-collaborative-network">How to build Kubernetes Native Cloud side efficient collaborative network</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-11-06T00:00:00.000Z" itemprop="datePublished">November 6, 2020</time> Â· <!-- -->21 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/charleszheng44.png" alt="Chao Zheng"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chao Zheng</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>å¯¼è¯»ï¼šOpenYurtæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„äº‘è¾¹ååŒä¸€ä½“åŒ–æ¶æ„ï¼Œä¸åŒç±»å¼€æºæ–¹æ¡ˆç›¸æ¯”ï¼ŒOpenYurtæ‹¥æœ‰å¯å®ç°è¾¹ç¼˜è®¡ç®—å…¨åœºæ™¯è¦†ç›–çš„èƒ½åŠ›ã€‚</p><ul><li>OpenYurtæ˜¯å¦‚ä½•åœ¨å¼±ç½‘å’Œæ–­ç½‘ç¯å¢ƒä¸‹å®ç°è¾¹ç¼˜è‡ªæ²»çš„â€”â€”<a href="/blog/Edge-gateway-caching-capabilities">YurtHub</a></li><li>OpenYurtå¦ä¸€ä¸ªæ ¸å¿ƒèƒ½åŠ›â€”â€”äº‘è¾¹é€šä¿¡ï¼Œä»¥åŠç›¸å…³ç»„ä»¶Yurttunnel</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurttunnelä½¿ç”¨åœºæ™¯">Yurttunnelä½¿ç”¨åœºæ™¯<a aria-hidden="true" class="hash-link" href="#yurttunnelä½¿ç”¨åœºæ™¯" title="Direct link to heading">â€‹</a></h2><p>åœ¨åº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¸¸å¸¸éœ€è¦è·å–åº”ç”¨çš„æ—¥å¿—ï¼Œæˆ–ç›´æ¥ç™»å½•åˆ°åº”ç”¨çš„è¿è¡Œç¯å¢ƒä¸­è¿›è¡Œè°ƒè¯•ã€‚åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ kubectl logï¼Œkubectl exec ç­‰æŒ‡ä»¤æ¥å®ç°è¿™äº›éœ€æ±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ kubectl è¯·æ±‚é“¾è·¯ä¸Šï¼Œ kubelet å°†æ‰®æ¼”æœåŠ¡å™¨ç«¯ï¼Œè´Ÿè´£å¤„ç†ç”± kube-apiserver(KAS) è½¬å‘æ¥çš„è¯·æ±‚ï¼Œè¿™å°±è¦æ±‚ KAS å’Œ kubelet ä¹‹é—´éœ€è¦å­˜åœ¨ä¸€æ¡ç½‘ç»œé€šè·¯ï¼Œå…è®¸ KAS ä¸»åŠ¨è®¿é—® kubeletã€‚
<img alt="image" src="/assets/images/kubectl-a986c3e8d3b680dd93899fce88a92821.png">
ç„¶è€Œï¼Œåœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸­ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¸¸ä½äºæœ¬åœ°ä¸“æœ‰ç½‘ç»œä¸­ï¼Œè¿™è™½ç„¶ä¿è¯äº†è¾¹ç¼˜èŠ‚ç‚¹çš„å®‰å…¨ï¼Œä½†ä¹Ÿé€ æˆä½äºäº‘ç«¯ç®¡æ§èŠ‚ç‚¹çš„KASæ— æ³•ç›´æ¥è®¿é—®ä½äºè¾¹ç¼˜èŠ‚ç‚¹çš„kubeletã€‚å› æ­¤ï¼Œä¸ºäº†æ”¯æŒé€šè¿‡äº‘ç«¯èŠ‚ç‚¹å¯¹è¾¹ç¼˜ç«¯åº”ç”¨è¿›è¡Œè¿ç»´æ“ä½œï¼Œæˆ‘ä»¬å¿…é¡»åœ¨äº‘ã€è¾¹ä¹‹é—´å»ºç«‹åå‘è¿ç»´é€šé“ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="åå‘é€šé“">åå‘é€šé“<a aria-hidden="true" class="hash-link" href="#åå‘é€šé“" title="Direct link to heading">â€‹</a></h2><p>Yurttunnelæ˜¯OpenYurtè¿‘æœŸå¼€æºçš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œç”¨æ¥è§£å†³äº‘è¾¹é€šä¿¡é—®é¢˜ã€‚åå‘é€šé“æ˜¯è§£å†³è·¨ç½‘ç»œé€šä¿¡çš„ä¸€ç§å¸¸è§æ–¹å¼ï¼Œè€Œ Yurttunnel çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªåå‘é€šé“ã€‚ä¸€ä¸ªè¾¹ç¼˜é›†ç¾¤ä¸‹å±çš„èŠ‚ç‚¹å¸¸ä½äºä¸åŒçš„ network region ä¸­ï¼Œè€Œä½äºåŒä¸€ä¸ª region å†…çš„èŠ‚ç‚¹ä¹‹é—´æ˜¯å¯ä»¥ç›¸äº’é€šä¿¡çš„ï¼Œå› æ­¤åœ¨è®¾ç½®åå‘é€šé“æ—¶ï¼Œæˆ‘ä»¬åªéœ€ä¿è¯åœ¨æ¯ä¸ª region å†…è®¾ç½®ä¸€ä¸ªä¸ proxy server ç›¸è¿çš„ agent å³å¯ã€‚å…·ä½“åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li><p>åœ¨ç®¡æ§ç»„ä»¶æ‰€åœ¨ç½‘ç»œå†…ï¼Œéƒ¨ç½² proxy serverã€‚</p></li><li><p>proxy server å¯¹å¤–å¼€æ”¾ä¸€ä¸ªå…¬ç½‘å¯ä»¥è®¿é—®çš„ IPã€‚</p></li><li><p>åœ¨æ¯ä¸ª region éƒ¨ç½²ä¸ª agentï¼Œå¹¶é€šè¿‡ server çš„å…¬ç½‘ IP ä¸ server å»ºç«‹é•¿è¿æ¥ã€‚</p></li><li><p>ç®¡æ§ç»„ä»¶å¯¹è¾¹ç¼˜èŠ‚ç‚¹çš„è®¿é—®è¯·æ±‚éƒ½å°†è½¬å‘è‡´ proxy serverã€‚</p></li><li><p>proxy server å†å°†è¯·æ±‚é€šè¿‡å¯¹åº”çš„é•¿è¿æ¥å‘å¾€ç›®æ ‡èŠ‚ç‚¹ã€‚</p></li></ul><p><img alt="image" src="/assets/images/proxy_server_agent-58a080cbcdc31c0c7b82a500d94f9849.png">
åœ¨ Yurttunnel ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ä¸Šæ¸¸<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy" target="_blank" rel="noopener noreferrer">é¡¹ç›®apiserver-network-proxy(ANP)</a> æ¥å®ç°server å’Œ agent é—´çš„é€šä¿¡ã€‚ANP æ˜¯åŸºäº kubernetes 1.16 Alpha æ–°åŠŸèƒ½<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/egressselector/egress_selector.go" target="_blank" rel="noopener noreferrer">EgressSelector</a> å¼€å‘ï¼Œæ„åœ¨å®ç° Kubernetes é›†ç¾¤ç»„ä»¶çš„è·¨ intranet é€šä¿¡ï¼ˆä¾‹å¦‚ï¼Œmaster ä½äºç®¡æ§ VPCï¼Œè€Œ kubelet ç­‰å…¶ä»–ç»„ä»¶ä½äºç”¨æˆ· VPCï¼‰ã€‚</p><p>è¯»è€…å¯èƒ½ä¼šå¥½å¥‡ï¼Œæ—¢ç„¶ OpenYurt æ˜¯åŸºäº ACK@Edge å¼€æºçš„ï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ ACK@Edge çš„äº‘è¾¹è¿ç»´é€šé“ä½¿ç”¨çš„æ˜¯è‡ªç ”ç»„ä»¶ tunnellibï¼Œé‚£ä¸ºä»€ä¹ˆåœ¨å¼€æºç‰ˆæœ¬é‡Œæˆ‘ä»¬è¦é€‰ç”¨ä¸€ä¸ªæ–°çš„ç»„ä»¶å‘¢ï¼Ÿè¿™é‡Œä¸å¾—ä¸å†æ¬¡æåˆ° OpenYurt çš„æ ¸å¿ƒè®¾è®¡ç†å¿µ â€œExtend upstream Kubernetes to Edgeâ€ã€‚</p><p>è¯šç„¶ï¼Œtunnellib ç»è¿‡äº†å¤æ‚çº¿ä¸Šç¯å¢ƒçš„è€ƒéªŒï¼Œç»„ä»¶æ€§èƒ½ç¨³å®šï¼Œä½†æˆ‘ä»¬æ›´å¸Œæœ›èƒ½ä¸ä¸Šæ¸¸ä¿æŒæœ€å¤§çš„æŠ€æœ¯å…¬çº¦æ•°ï¼Œè®© OpenYurt çš„ç”¨æˆ·ä½“éªŒæ›´æ¥è¿‘åŸç”Ÿ Kubernetes ï¼›åŒæ—¶ï¼Œåœ¨ ACK@Edge çš„å¼€å‘å’Œè¿ç»´è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œè¾¹ç¼˜é›†ç¾¤çš„è®¸å¤šéœ€æ±‚ä¹ŸåŒæ ·å­˜åœ¨äºå…¶ä»–åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚ï¼Œå¤§å¤šæ•°äº‘å‚å•†ä¹Ÿéœ€è¦å®ç°èŠ‚ç‚¹è·¨ç½‘ç»œé€šä¿¡ï¼‰ï¼Œå¹¶ä¸”è¿ç»´é€šé“çš„ä¼ è¾“æ•ˆç‡ä¹Ÿèƒ½è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆ4.5ç« å°†è¯¦è¿°ä¼˜åŒ–è¿‡ç¨‹ï¼‰ã€‚å› æ­¤ï¼Œç§‰æ‰¿å¼€æ”¾åˆ†äº«ã€å¹³ç­‰æ™®æƒ çš„å¼€æºç²¾ç¥ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å°†å¼€å‘å’Œè¿ç»´è¿‡ç¨‹ä¸­ç§¯ç´¯çš„çš„å®è´µç»éªŒåœ¨ä¸Šæ¸¸ç¤¾åŒºä¸æ›´å¤šçš„å¼€å‘è€…åˆ†äº«ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="anpå¹¶éå¼€ç®±å³ç”¨">ANPå¹¶éå¼€ç®±å³ç”¨<a aria-hidden="true" class="hash-link" href="#anpå¹¶éå¼€ç®±å³ç”¨" title="Direct link to heading">â€‹</a></h2><p>ç„¶è€Œ ANP é¡¹ç›®ä»å¤„äºèµ·æ­¥é˜¶æ®µï¼ŒåŠŸèƒ½å°šæœªå®Œå–„ï¼Œè®¸å¤šé—®é¢˜ä»æœ‰å¾…è§£å†³ã€‚æˆ‘ä»¬ä»å®è·µä¸­å‘ç°çš„ä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š</p><ul><li><p>å¦‚ä½•è½¬å‘äº‘ç«¯èŠ‚ç‚¹çš„è¯·æ±‚ -- åå‘é€šé“æ­£å¸¸å·¥ä½œçš„ä¸€ä¸ªå‰ææ˜¯ï¼Œç®¡æ§èŠ‚ç‚¹å‘å¾€è¾¹ç¼˜èŠ‚ç‚¹çš„è¯·æ±‚å¿…é¡»å…ˆç»è¿‡ proxy serverã€‚å¯¹äº Kubernetes 1.16 + ç‰ˆæœ¬ï¼ŒKAS èƒ½å€Ÿç”± EgressSelector å°†å‘å¾€èŠ‚ç‚¹çš„è¯·æ±‚å…ˆå‘å¾€æŒ‡å®šçš„ proxy serverã€‚ä½†å¯¹äº 1.16 ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒKAS åŠå…¶ä»–ç®¡æ§ç»„ä»¶ï¼ˆPrometheus å’Œ metrics serverï¼‰åªèƒ½ç›´æ¥è®¿é—®èŠ‚ç‚¹ï¼Œè€Œä¸èƒ½ç»•é“ proxy serverã€‚å¯ä»¥é¢„è§çš„æ˜¯ï¼Œéƒ¨åˆ†ç”¨æˆ·åœ¨çŸ­æœŸå†…ï¼Œä»å°†ä½¿ç”¨ 1.16 ä»¥å‰çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸” Prometheus å’Œ metrics server ç­‰ç®¡æ§ç»„ä»¶åœ¨çŸ­æœŸå†…ä¹Ÿæ²¡æœ‰æ”¯æŒ EgressSelector çš„è®¡åˆ’ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•å°†ç®¡æ§ç»„ä»¶å‘å¾€èŠ‚ç‚¹çš„è¯·æ±‚è½¬å‘è‡´ proxy serverã€‚</p></li><li><p>å¦‚ä½•ç¡®ä¿ server å‰¯æœ¬è¦†ç›–æ‰€æœ‰çš„ region -- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªè¾¹ç¼˜é›†ç¾¤å¸¸å¸¸åŒ…å«ä¸Šä¸‡ä¸ªèŠ‚ç‚¹ï¼Œå¹¶åŒæ—¶æœåŠ¡ä¸Šç™¾åç”¨æˆ·ï¼Œå¦‚æœä¸€ä¸ªé›†ç¾¤åªæœ‰ä¸€ä¸ª proxy serverï¼Œ é‚£ä¹ˆï¼Œä¸€æ—¦ proxy server å‡ºç°æ•…éšœï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å°†æ— æ³•å¯¹ä½äºè¾¹ç¼˜èŠ‚ç‚¹ä¸Šçš„ pod è¿›è¡Œæ“ä½œã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åŒæ—¶éƒ¨ç½²å¤šä¸ª proxy server å‰¯æœ¬ä»¥ä¿è¯é›†ç¾¤é«˜å¯ç”¨ã€‚åŒæ—¶ï¼Œproxy server çš„å·¥ä½œè´Ÿè·å°†éšç€è®¿é—®æµé‡çš„å¢å¤§è€Œå¢å¤§ï¼Œç”¨æˆ·çš„è®¿é—®å»¶æ—¶ä¹ŸåŠ¿å¿…å¢åŠ ã€‚å› æ­¤åœ¨éƒ¨ç½² proxy server æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è€ƒè™‘å¦‚ä½•å¯¹ proxy server è¿›è¡Œæ°´å¹³æ‹“å±•ï¼Œä»¥åº”å¯¹é«˜å¹¶å‘åœºæ™¯ã€‚ä¸€ä¸ªåº”å¯¹å•ç‚¹æ•…éšœå’Œé«˜å¹¶å‘åœºæ™¯çš„ç»å…¸è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œéƒ¨ç½²å¤šä¸ª proxy server å‰¯æœ¬ï¼Œå¹¶ä½¿ç”¨è´Ÿè½½å‡è¡¡è¿›è¡Œæµé‡åˆ†å‘ã€‚ç„¶è€Œåœ¨ OpenYurt åœºæ™¯ä¸‹ï¼Œå¯¹äº KAS å‘æ¥çš„ä»»æ„è¯·æ±‚ï¼ŒLoadBalancer (LB) ä¼šè½¬å‘ç»™å“ªä¸ª server å‰¯æœ¬æ˜¯ä¸å¯æ§çš„ï¼Œå› æ­¤ï¼Œéœ€è¦è§£å†³çš„ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ª server å‰¯æœ¬éƒ½èƒ½ä¸æ‰€æœ‰çš„ agent å»ºç«‹è¿æ¥ã€‚</p></li><li><p>å¦‚ä½•å°†è¯·æ±‚è½¬å‘ç»™æ­£ç¡®çš„ agent -- åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œproxy server åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œéœ€æ ¹æ®è¯·æ±‚çš„ destination IPï¼Œå°†è¯·æ±‚è½¬å‘è‡³ä½äºå¯¹åº” network region å†…çš„ agentã€‚ç„¶è€Œï¼ŒANPç›®å‰çš„å®ç°ï¼Œå‡è®¾æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä½äºä¸€ä¸ªç½‘ç»œç©ºé—´å†…ï¼Œ server ä¼šéšæœºæŒ‘é€‰ä¸€ä¸ª agent è½¬å‘è¯·æ±‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„ç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•å°†è¯·æ±‚æ­£ç¡®åœ°è½¬å‘ç»™æŒ‡å®šçš„ agentã€‚ </p></li><li><p>å¦‚ä½•è§£é™¤ç»„ä»¶å¯¹èŠ‚ç‚¹è¯ä¹¦çš„ä¾èµ– -- åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸º server æä¾›ä¸€å¥— TLS è¯ä¹¦ï¼Œä»¥å®ç° server ä¸ KASï¼Œserver ä¸ agent é—´çš„å®‰å…¨é€šä¿¡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸º agent å‡†å¤‡ä¸€å¥— TLS client è¯ä¹¦ï¼Œç”¨ä»¥å»ºç«‹ agent å’Œ server é—´çš„ gRPC ä¿¡é“ã€‚ANP ç›®å‰çš„å®ç°ï¼Œè¦æ±‚ server å¿…é¡»å’Œ KAS éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”åœ¨å¯åŠ¨æ—¶æŒ‚è½½èŠ‚ç‚¹ volume å…±äº« KAS tls è¯ä¹¦ã€‚åŒæ ·ï¼Œagent ä¹Ÿéœ€è¦åœ¨å¯åŠ¨æ—¶æŒ‚è½½ volume å…±äº« kubelet tls è¯ä¹¦ã€‚è¿™æ— å½¢ä¸­é™ä½äº†éƒ¨ç½²çš„çµæ´»æ€§ï¼Œé€ æˆäº†ç»„å»ºå¯¹èŠ‚ç‚¹è¯ä¹¦çš„å¼ºä¾èµ–ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½å¸Œæœ›å°† server éƒ¨ç½²åœ¨é KAS æ‰€åœ¨èŠ‚ç‚¹ä¸Šã€‚å› æ­¤ï¼Œå¦ä¸€ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•è§£é™¤ç»„ä»¶å¯¹èŠ‚ç‚¹è¯ä¹¦çš„ä¾èµ–ã€‚</p></li></ul><ul><li>å¦‚ä½•ç¼©å° Tunnel å¸¦å®½ -- ANP çš„ä¸€ä¸ªæ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼Œæ˜¯ä½¿ç”¨ gRPC å°è£… KAS æ‰€æœ‰å¯¹å¤– HTTP è¯·æ±‚ã€‚è¿™é‡Œé€‰æ‹© gRPCï¼Œä¸»è¦æ˜¯çœ‹é‡å…¶å¯¹æµï¼ˆstreamï¼‰çš„æ”¯æŒå’Œæ¸…æ™°çš„æ¥å£è§„èŒƒï¼Œæ­¤å¤–ï¼Œå¼ºç±»å‹çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æœ‰æ•ˆå‡å°‘è¿è¡Œæ—¶é”™è¯¯ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°ï¼Œç›¸è¾ƒäºç›´æ¥ä½¿ç”¨ TCP åè®®ï¼Œé‡‡ç”¨ ANP ä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€å¢åŠ å¸¦å®½ã€‚ä»äº§å“å±‚é¢è€ƒè™‘ï¼ŒTunnel æµé‡èµ°çš„æ˜¯å…¬ç½‘ï¼Œå¸¦å®½çš„å¢åŠ ä¹Ÿæ„å‘³ç€ç”¨æˆ·æˆæœ¬çš„å¢åŠ ã€‚å› æ­¤ï¼Œä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜æ˜¯ï¼Œåœ¨æé«˜ç³»ç»Ÿç¨³å®šæ€§çš„åŒæ—¶ï¼Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿèƒ½ç¼©å°å¸¦å®½ï¼Ÿ </li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurttunnelè®¾è®¡è§£æ">Yurttunnelè®¾è®¡è§£æ<a aria-hidden="true" class="hash-link" href="#yurttunnelè®¾è®¡è§£æ" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1åˆ¶å®šdnatè§„åˆ™è½¬å‘äº‘ç«¯èŠ‚ç‚¹çš„è¯·æ±‚">1.åˆ¶å®šDNATè§„åˆ™è½¬å‘äº‘ç«¯èŠ‚ç‚¹çš„è¯·æ±‚<a aria-hidden="true" class="hash-link" href="#1åˆ¶å®šdnatè§„åˆ™è½¬å‘äº‘ç«¯èŠ‚ç‚¹çš„è¯·æ±‚" title="Direct link to heading">â€‹</a></h3><p>å¦‚å‰æ–‡æ‰€è¿°ï¼ŒANP æ˜¯åŸºäºä¸Šæ¸¸æ–°åŠŸèƒ½ EgressSelector å¼€å‘çš„ï¼Œè¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨å¯åŠ¨ KAS æ—¶é€šè¿‡ä¼ å…¥ egress configuration æ¥è¦æ±‚ KAS å°† egress è¯·æ±‚è½¬å‘åˆ°æŒ‡å®šçš„ proxy serverã€‚ä½†ç”±äºæˆ‘ä»¬éœ€è¦å…¼é¡¾æ–°è€ç‰ˆæœ¬çš„ Kubernetes é›†ç¾¤ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°ï¼Œå…¶ä»–ç®¡æ§ç»„ä»¶ï¼ˆPrometheus å’Œ metric serverï¼‰å¹¶ä¸æ”¯æŒ EgressSelector ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åœ¨æ— æ³•ä½¿ç”¨ EgressSelector çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å°† KAS egress è¯·æ±‚è½¬å‘è‡´ proxy serverã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸€ä¸ªäº‘ç«¯ç®¡æ§èŠ‚ç‚¹ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ª Yurttunnel Server å‰¯æœ¬ï¼Œå¹¶åœ¨ Server ä¸­å†…åµŒä¸€ä¸ªæ–°ç»„ä»¶ Iptabel Managerã€‚Iptable Manager ä¼šé€šè¿‡åœ¨å®¿ä¸»æœºçš„ Iptable ä¸­çš„ OUTPUT é“¾ä¸­æ·»åŠ  DNAT è§„åˆ™ï¼Œå°†ç®¡æ§ç»„ä»¶å¯¹èŠ‚ç‚¹çš„è¯·æ±‚è½¬å‘è‡´ Yurttunnel Serverã€‚</p><p>åŒæ—¶ï¼Œå½“å¯ç”¨ EgressSelector åï¼ŒKAS å¯¹å¤–è¯·æ±‚éƒ½éµå¾ªä¸€ä¸ªç»Ÿä¸€çš„æ ¼å¼ï¼Œå› æ­¤æˆ‘ä»¬æ–°å¢ä¸€ä¸ªç»„ä»¶ï¼Œ ANP interceptorã€‚ANP interceptor ä¼šè´Ÿè´£æˆªå–ä» master å‘æ¥çš„ http è¯·æ±‚ï¼Œå¹¶å°†å…¶å°è£…æˆ EgressSelector æ ¼å¼ã€‚Yurttunnel è¯·æ±‚è½¬å‘çš„å…·ä½“æµç¨‹è§å›¾ä¸‰ã€‚
<img alt="image" src="/assets/images/yurttunnel-37d6b1940619816205bf637ecda07532.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2åŠ¨æ€è·å–serverå‰¯æœ¬æ•°">2.åŠ¨æ€è·å–Serverå‰¯æœ¬æ•°<a aria-hidden="true" class="hash-link" href="#2åŠ¨æ€è·å–serverå‰¯æœ¬æ•°" title="Direct link to heading">â€‹</a></h3><p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼æ¥ç®¡ç†yurttunnel serverï¼Œæ‰€æœ‰çš„ingressè¯·æ±‚éƒ½ä¼šé€šè¿‡LBåˆ†å‘ç»™ä¸€ä¸ªserverå‰¯æœ¬ã€‚ç”±äºæˆ‘ä»¬æ— æ³•é¢„æµ‹LBä¼šæŒ‘é€‰å“ªä¸ªserverå‰¯æœ¬ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯æ¯ä¸ª server å‰¯æœ¬éƒ½è¦ä¸æ‰€æœ‰çš„ agent å»ºç«‹è¿æ¥ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ ANP è‡ªå¸¦çš„åŠŸèƒ½å®ç°è¿™ä¸€éœ€æ±‚ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>åœ¨å¯åŠ¨ yurttunnel server æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†å‰¯æœ¬æ•°ï¼ˆserverCountï¼‰ä¼ å…¥æ¯ä¸ª server å‰¯æœ¬ä¸­ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªå‰¯æœ¬æŒ‡å®šä¸€ä¸ª server IDï¼›</p></li><li><p>agent è¿æ¥ LB åï¼ŒLBä¼šéšæœºé€‰æ‹©ä¸€ä¸ª server å‰¯æœ¬å¹¶è®©å…¶ä¸ agent å»ºç«‹é•¿è¿æ¥ï¼›</p></li><li><p>ä¸æ­¤åŒæ—¶ï¼Œserver ä¼šé€šè¿‡è¯¥é€šé“å‘ agent è¿”å›ä¸€ä¸ª ACK packageï¼Œè¿™ä¸ª package ä¸­å°†åŒ…å« serverCount å’Œ serverIDï¼›</p></li><li><p>agent é€šè¿‡è§£æ ACK packageï¼Œå¯ä»¥è·æ‚‰ server å‰¯æœ¬çš„ä¸ªæ•°ï¼Œå¹¶åœ¨æœ¬åœ°è®°å½•å·²è¿æ¥çš„ serverIDï¼›</p></li><li><p>å¦‚æœ agent å‘ç°ï¼Œæœ¬åœ°è¿æ¥çš„ server å‰¯æœ¬æ•°å°äº serverCountï¼Œåˆ™ä¼šå†æ¬¡å‘ LB å‘é€è¿æ¥è¯·æ±‚ï¼Œç›´è‡³æœ¬åœ°è®°å½•çš„ serverID æ•°ä¸ server Count æ•°ä¸€è‡´ä¸ºæ­¢ã€‚</p></li></ul><p>è¯¥æœºåˆ¶è™½ç„¶å¸®åŠ©æˆ‘ä»¬å®ç°äº†serverå‰¯æœ¬çš„å…¨ç½‘æ®µè¦†ç›–ã€‚ä½†åŒæ—¶ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„ç¼ºç‚¹ï¼Œç”±äº agent æ— æ³•é€‰æ‹©ä¸å“ªä¸ª server å‰¯æœ¬å»ºç«‹è¿æ¥ï¼Œå› æ­¤ï¼Œä¸ºäº†è¿æ¥æ‰€æœ‰çš„ server å‰¯æœ¬ï¼Œagent å¿…é¡»åå¤è®¿é—® LBã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œserver ç”±äºè¿˜æ²¡æœ‰ä¸æ‰€æœ‰çš„ agent å»ºç«‹è¿æ¥ï¼ŒKAS å‘æ¥çš„è¯·æ±‚å¯èƒ½æ— æ³•è½¬å‘è‡³å¯¹åº”çš„èŠ‚ç‚¹ã€‚ä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œä¸ºæ¯ä¸ª serverå‰¯æœ¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ LBï¼Œè´Ÿè´£ä¸ agent ä¹‹é—´çš„è¿æ¥ï¼ŒåŒæ—¶åœ¨agentç«¯è®°å½•æ‰€æœ‰ serverå‰¯æœ¬å¯¹åº” LB çš„ä¿¡æ¯ï¼Œè¿™ä¸€æ–¹æ¡ˆèƒ½å¸®åŠ© agent å¿«é€Ÿåœ°ä¸æ‰€æœ‰çš„ server å‰¯æœ¬å»ºç«‹è¿æ¥ã€‚è¯¥æ–¹æ¡ˆçš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œç›®å‰ä»åœ¨ä¸ä¸Šæ¸¸ç¤¾åŒºçš„å¼€å‘è€…è®¨è®ºä¸­ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3ä¸ºanpæ·»åŠ ä»£ç†ç­–ç•¥">3.ä¸ºANPæ·»åŠ ä»£ç†ç­–ç•¥<a aria-hidden="true" class="hash-link" href="#3ä¸ºanpæ·»åŠ ä»£ç†ç­–ç•¥" title="Direct link to heading">â€‹</a></h3><p>åœ¨OpenYurtçš„ç½‘ç»œæ¨¡å‹ä¸‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„network regionä¸­ï¼Œéšæœºé€‰æ‹©çš„ agent å¯èƒ½æ— æ³•å°†è¯·æ±‚è½¬å‘è‡³ä½äºå…¶ä»– region å†…çš„èŠ‚ç‚¹ä¸Šã€‚å› æ­¤æˆ‘ä»¬ä¸å¾—ä¸ä¿®æ”¹ ANP server åº•å±‚ä»£ç†è½¬å‘çš„é€»è¾‘ã€‚ç„¶è€Œï¼Œæ ¹æ®é•¿æœŸçš„ç»éªŒï¼Œæˆ‘ä»¬ç›¸ä¿¡ï¼Œproxy server æ”¯æŒä¸åŒçš„ä»£ç†ç­–ç•¥ï¼Œä¾‹å¦‚ï¼Œå°†è¯·æ±‚è½¬å‘è‡³æŒ‡å®šæ•°æ®ä¸­å¿ƒï¼Œregionï¼Œæˆ–è€…æŒ‡å®šä¸»æœºï¼Œæ˜¯ä¸€ä¸ªè¾ƒä¸ºé€šç”¨çš„éœ€æ±‚ã€‚ç»è¿‡å’Œ ANP ç¤¾åŒºå¼€å‘è€…è®¨è®ºï¼Œæˆ‘ä»¬å†³å®šé‡æ„ ANP ç®¡ç† agent è¿æ¥çš„æ¥å£ï¼Œå…è®¸ç”¨æˆ·æ ¹æ®éœ€æ±‚å®ç°æ–°çš„ä»£ç†ç­–ç•¥ï¼Œå¹¶è®¡åˆ’å°†è¯¥ feature æœ€ç»ˆåˆå…¥ä¸Šæ¸¸ä»£ç åº“ã€‚ç›®å‰é‡æ„å·¥ä½œä»åœ¨è¿›è¡Œä¸­ï¼Œåœ¨ Yurttunnel ç¬¬ä¸€ä¸ªå¼€æºç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æš‚æ—¶é‡‡ç”¨ä»¥ä¸‹é…ç½®ï¼š</p><ul><li><p>åœ¨æ¯ä¸ªè¾¹ç¼˜èŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ª agentã€‚</p></li><li><p>agent åœ¨ server å¤„ç™»è®°æ—¶ï¼Œä½¿ç”¨ agent æ‰€åœ¨èŠ‚ç‚¹çš„ IP ä½œä¸º agentIDã€‚</p></li><li><p>server åœ¨è½¬å‘è¯·æ±‚æ—¶ï¼Œé€šè¿‡åŒ¹é…è¯·æ±‚ç›®æ ‡ IP å’Œ agentIDï¼Œå°†è¯·æ±‚è½¬å‘è‡³å¯¹åº”çš„ agentã€‚</p></li></ul><p>æˆ‘ä»¬è®¡åˆ’åœ¨OpenYurtåç»­å‘å¸ƒYurt Unitï¼ˆè¾¹ç¼˜èŠ‚ç‚¹åˆ†åŒºç®¡æ§ï¼‰ä¹‹åï¼Œé…åˆæ–°å¢çš„ANPä»£ç†è½¬å‘ç­–ç•¥ï¼Œå®ç°agentçš„åˆ†åŒºéƒ¨ç½²ï¼Œå’Œè¯·æ±‚çš„åˆ†åŒºè½¬å‘ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4åŠ¨æ€ç”³è¯·å®‰å…¨è¯ä¹¦">4.åŠ¨æ€ç”³è¯·å®‰å…¨è¯ä¹¦<a aria-hidden="true" class="hash-link" href="#4åŠ¨æ€ç”³è¯·å®‰å…¨è¯ä¹¦" title="Direct link to heading">â€‹</a></h3><p>ä¸ºäº†è§£é™¤yurttunnelç»„ä»¶å¯¹èŠ‚ç‚¹è¯ä¹¦çš„ä¾èµ–ï¼Œæˆ‘ä»¬åœ¨yurttunnelä¸­æ–°å¢cert managerç»„ä»¶ï¼Œcert managerä¼šåœ¨serverå’Œagentè¿è¡Œåï¼Œå‘KASæäº¤certificate signning request(CSR)ã€‚server å°†ä½¿ç”¨ç”³è¯·åˆ°çš„è¯ä¹¦æ¥ç¡®ä¿å…¶ä¸ KAS å’Œ agent é—´çš„å®‰å…¨é€šä¿¡ï¼Œagent ä¼šä½¿ç”¨ç”³è¯·åˆ°çš„è¯ä¹¦ç¡®ä¿å…¶ä¸ server é—´ gRPC ä¿¡é“çš„å®‰å…¨ã€‚ç”±äº agent å’Œ kubelet é—´æ˜¯é€šè¿‡ tcp åè®®è¿æ¥ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æ— éœ€ä¸º agent å’Œ kubelet é—´çš„è¿æ¥å‡†å¤‡è¯ä¹¦ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="5å‹ç¼©tunnelå¸¦å®½èŠ‚çº¦æˆæœ¬">5.å‹ç¼©Tunnelå¸¦å®½ï¼ŒèŠ‚çº¦æˆæœ¬<a aria-hidden="true" class="hash-link" href="#5å‹ç¼©tunnelå¸¦å®½èŠ‚çº¦æˆæœ¬" title="Direct link to heading">â€‹</a></h3><p>åœ¨ä¸Šæ–‡ï¼Œæˆ‘ä»¬æåˆ°ï¼Œä½¿ç”¨gRPCå°è£…Tunnelè™½ç„¶å¯ä»¥æé«˜ä¼ è¾“ç¨³å®šæ€§ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ å…¬ç½‘æµé‡ã€‚è¿™æ˜¯å¦æ„å‘³ç€ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œæˆ‘ä»¬åªèƒ½äºŒé€‰ä¸€ï¼Ÿé€šè¿‡å¯¹ä¸åŒç”¨æˆ·åœºæ™¯çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä½¿ç”¨è¿ç»´é€šé“æ˜¯ä¸ºäº†è·å–å®¹å™¨æ—¥å¿—ï¼ˆå³ kubectl logï¼‰ï¼Œè€Œä¼ ç»Ÿæ—¥å¿—æ–‡ä»¶ï¼Œå­˜åœ¨è®¸å¤šç›¸åŒçš„æ–‡æœ¬ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬æ¨æ–­ä½¿ç”¨ gzip ç­‰å‹ç¼©ç®—æ³•èƒ½æœ‰æ•ˆç¼©å°å¸¦å®½ã€‚ä¸ºäº†éªŒè¯è¿™ä¸€å‡è®¾ï¼Œæˆ‘ä»¬åœ¨ ANP åº•å±‚çš„ gRPC åº“ä¸­æ·»åŠ äº† gzip compressorï¼Œå¹¶ä¸”å¯¹æ¯”äº†ä¸ä½¿ç”¨åŸç”Ÿ TCP è¿æ¥åœºæ™¯ä¸‹çš„æ•°æ®ä¼ è¾“é‡ã€‚</p><p>æˆ‘ä»¬è€ƒè™‘çš„ç¬¬ä¸€ä¸ªå®éªŒåœºæ™¯æ˜¯ï¼Œåˆ†åˆ«é€šè¿‡ TCP è¿æ¥å’Œ ANP è·å–åŒä¸€ kubeproxy å®¹å™¨çš„æ—¥å¿—ï¼Œæˆ‘ä»¬æˆªå–äº†è¿™ä¸€è¿‡ç¨‹ä¸­ Tunnel ä¸ŠåŒå‘ package å’Œ bytes æ€»é‡ã€‚</p><p><img alt="image" src="data:image/png;base64,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"></p><p>å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œé€šè¿‡ä½¿ç”¨ ANPï¼Œ æ€»ä¼ è¾“æ•°æ®é‡ä¸‹é™äº† 29.93%ã€‚</p><p>ç»è¿‡é•¿æ—¶é—´è¿è¡Œï¼Œå®¹å™¨çš„æ—¥å¿—æ–‡æœ¬å¸¸å¸¸å¯ä»¥è¾¾åˆ°åå‡ å…†ï¼Œä¸ºäº†æ¨¡æ‹Ÿè·å–å¤§æ–‡æœ¬æ—¥å¿—çš„åœºæ™¯ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€åŒ…å« 10.5M systemd logï¼ˆå³ journalctlï¼‰çš„ ubuntu å®¹å™¨ï¼ŒåŒæ ·æˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨åŸç”Ÿ TCP è¿æ¥å’Œ ANP ä¼ è¾“è¯¥æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶æµ‹é‡äº† Tunnel ä¸Šçš„æ•°æ®æ€»é‡
<img alt="image" src="/assets/images/large_log-134be99fb1d206593ae4701ab02ec08a.png"></p><p>å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œåœ¨æ—¥å¿—æ–‡æœ¬è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä½¿ç”¨ ANPï¼Œ æ€»ä¼ è¾“æ•°æ®é‡ä¸‹é™äº† 40.85%ã€‚</p><p>ç”±æ­¤å¯è§ï¼Œç›¸è¾ƒäºåŸç”Ÿ TCP è¿æ¥ï¼ŒANP ä¸ä»…èƒ½æä¾›æ›´é«˜çš„ä¼ è¾“ç¨³å®šæ€§ï¼Œè¿˜å¯ä»¥å¤§å¹…é™ä½å…¬ç½‘æµé‡ã€‚è€ƒè™‘åˆ°è¾¹ç¼˜é›†ç¾¤åŠ¨è¾„ä¸Šä¸‡çš„èŠ‚ç‚¹è§„æ¨¡ï¼Œæ–°çš„è§£å†³æ–¹æ¡ˆå°†å¸®åŠ©ç”¨æˆ·åœ¨å…¬ç½‘æµé‡æ–¹é¢èŠ‚çº¦å¤§é‡å¼€é”€ã€‚</p><p>##Yurttunnelç³»ç»Ÿæ¶æ„
<img alt="image" src="/assets/images/Yurttunnel_arch-a35ea31101910abdd501f7313b7d0a43.png"></p><p>ç»¼ä¸Šï¼ŒYurttunnel ä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š</p><ul><li><p>Yurttunnel Server - è´Ÿè´£å°† apiserverï¼Œprometheusï¼Œmetrics server ç­‰ç®¡æ§ç»„ä»¶å‘å¾€èŠ‚ç‚¹çš„è¯·æ±‚ï¼Œè½¬å‘è‡³å¯¹åº”çš„ agentã€‚å…·ä½“åŒ…æ‹¬ä»¥ä¸‹å­ç»„ä»¶ï¼š</p><ul><li>ANP Proxy Server - å¯¹ ANP gRPC server çš„å°è£…ï¼Œè´Ÿè´£ç®¡ç†ä¸ Yurttunnel Agent ä¹‹é—´çš„é•¿è¿æ¥ï¼Œå¹¶è½¬å‘è¯·æ±‚ã€‚</li><li>Iptable Manager - ä¿®æ”¹ç®¡æ§èŠ‚ç‚¹çš„ DNAT è§„åˆ™ï¼Œä»¥ç¡®ä¿ç®¡æ§ç»„ä»¶çš„è¯·æ±‚èƒ½è¢«è½¬å‘è‡³ Yurttunnel Serverã€‚</li><li>Cert Manager - ä¸º Yurttunnel Server ç”Ÿæˆ TLS è¯ä¹¦ã€‚</li><li>Request Interceptor - å°† KAS å¯¹èŠ‚ç‚¹çš„ HTTP è¯·æ±‚å°è£…åˆ°ç¬¦åˆ ANP è§„åˆ™çš„ gRPC åŒ…é‡Œã€‚</li></ul></li><li><p>Yurttunnel Agent - ä¸ Yurttunnel Server ä¸»åŠ¨å»ºç«‹è¿æ¥ï¼Œå¹¶å°† Yurttunnel Server å‘æ¥çš„è¯·æ±‚è½¬å‘ç»™ Kubeletã€‚å…·ä½“åŒ…æ‹¬ä¸¤ä¸ªå­ç»„ä»¶ï¼š</p><ul><li>ANP Proxy Agent - å¯¹ ANP gRPC agent çš„å°è£…ï¼Œç›¸è¾ƒäºä¸Šæ¸¸ï¼Œæˆ‘ä»¬é¢å¤–åŠ å…¥äº† gzip compressor ä»¥å‹ç¼©æ•°æ®ã€‚</li><li>Cert Manager - ä¸º Yurttunnel Agent ç”Ÿæˆ TLS è¯ä¹¦ã€‚</li></ul></li><li><p>Yurttunnel Server Service - é€šå¸¸æ˜¯ä¸€ä¸ª SLBï¼Œè´Ÿè´£å°†ç®¡æ§ç»„ä»¶å‘æ¥çš„è¯·æ±‚åˆ†å‘ç»™åˆé€‚çš„ Yurttunnel Server å‰¯æœ¬ï¼Œä¿è¯ Yurttunnel çš„é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡ã€‚</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æ€»ç»“å’Œå±•æœ›">æ€»ç»“å’Œå±•æœ›<a aria-hidden="true" class="hash-link" href="#æ€»ç»“å’Œå±•æœ›" title="Direct link to heading">â€‹</a></h2><p>Yurttunnel ä½œä¸º OpenYurt è¿‘æœŸå¼€æºçš„é‡è¦ç»„ä»¶ï¼Œæ‰“é€šäº† OpenYurt é›†ç¾¤çš„äº‘è¾¹é€šé“ï¼Œä¸ºè¾¹ç¼˜é›†ç¾¤ä¸Šçš„å®¹å™¨è¿ç»´æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ã€‚é€šè¿‡å¯¹ä¸Šæ¸¸è§£å†³æ–¹æ¡ˆè¿›è¡Œæ”¹é€ ï¼ŒYurttunnel ä¸ä»…æä¾›äº†æ›´é«˜çš„ä¼ è¾“ç¨³å®šæ€§ï¼Œä¹Ÿå¤§å¹…é™ä½äº†æ•°æ®ä¼ è¾“é‡ã€‚</p><p><a href="https://mp.weixin.qq.com/s/nRUv4u9JbiIdrUPB_cZOBg" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/yurttunnel">yurttunnel</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Expansion-capability-of-Yurthub">Viewing Expansion Ability of YurtHub from Edge Autonomy</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-06-29T00:00:00.000Z" itemprop="datePublished">June 29, 2020</time> Â· <!-- -->10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">rambohe</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>å¯¼è¯»ï¼šOpenYurt è‡ªå¼€æºä»¥æ¥ï¼Œä»¥éä¾µå…¥å¼çš„æ¶æ„è®¾è®¡èåˆäº‘åŸç”Ÿå’Œè¾¹ç¼˜è®¡ç®—ä¸¤å¤§é¢†åŸŸï¼Œå¼•èµ·äº†ä¸å°‘è¡Œä¸šå†…åŒå­¦çš„å…³æ³¨ã€‚é˜¿é‡Œäº‘æ¨å‡ºå¼€æºé¡¹ç›® OpenYurtï¼Œä¸€æ–¹é¢æ˜¯æŠŠé˜¿é‡Œäº‘åœ¨äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—é¢†åŸŸçš„ç»éªŒå›é¦ˆç»™å¼€æºç¤¾åŒºï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¸Œæœ›åŠ é€Ÿäº‘è®¡ç®—å‘è¾¹ç¼˜å»¶ä¼¸çš„è¿›ç¨‹ï¼Œå¹¶å’Œç¤¾åŒºå…±åŒæ¢è®¨æœªæ¥äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—æ¶æ„çš„ç»Ÿä¸€æ ‡å‡†ã€‚
æœ¬æ–‡ä¸»è¦ä»‹ç»äº† OpenYurt ä¸­ç»„ä»¶ YurtHub çš„æ‰©å±•èƒ½åŠ›ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="openyurtä»‹ç»">OpenYurtä»‹ç»<a aria-hidden="true" class="hash-link" href="#openyurtä»‹ç»" title="Direct link to heading">â€‹</a></h2><p>é˜¿é‡Œäº‘è¾¹ç¼˜å®¹å™¨æœåŠ¡ä¸Šçº¿ 1 å¹´åï¼Œæ­£å¼å¼€æºäº†äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—è§£å†³æ–¹æ¡ˆ OpenYurtï¼Œè·Ÿå…¶ä»–å¼€æºçš„å®¹å™¨åŒ–è¾¹ç¼˜è®¡ç®—æ–¹æ¡ˆçš„åŒºåˆ«åœ¨äºï¼šOpenYurt ç§‰æŒ Extending your native Kubernetes to edge çš„ç†å¿µï¼Œå¯¹ Kubernetes ç³»ç»Ÿé›¶ä¿®æ”¹ï¼Œå¹¶æä¾›ä¸€é”®å¼è½¬æ¢åŸç”Ÿ Kubernetes ä¸º openyurtï¼Œè®©åŸç”Ÿ K8s é›†ç¾¤å…·å¤‡è¾¹ç¼˜é›†ç¾¤èƒ½åŠ›ã€‚</p><p>åŒæ—¶éšç€ OpenYurt çš„æŒç»­æ¼”è¿›ï¼Œä¹Ÿä¸€å®šä¼šç»§ç»­ä¿æŒå¦‚ä¸‹å‘å±•ç†å¿µï¼š</p><ul><li><p>éä¾µå…¥å¼å¢å¼º K8s</p></li><li><p>ä¿æŒå’Œäº‘åŸç”Ÿç¤¾åŒºä¸»æµæŠ€æœ¯åŒæ­¥æ¼”è¿›</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurthubæ¶æ„è¯´æ˜">YurtHubæ¶æ„è¯´æ˜<a aria-hidden="true" class="hash-link" href="#yurthubæ¶æ„è¯´æ˜" title="Direct link to heading">â€‹</a></h2><p>åœ¨<a href="/blog/YurtHub-design-detail">å‰é¢çš„æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† OpenYurt çš„è¾¹ç¼˜è‡ªæ²»èƒ½åŠ›ï¼Œé‡ç‚¹è§£è¯»äº†å…¶ä¸­çš„ç»„ä»¶ YurtHubã€‚å…¶æ¶æ„å›¾å¦‚ä¸‹ï¼š
OpenYurtç»„ä»¶YurtHubæ„æ¶å›¾ï¼š</p><p><img alt="image" src="/assets/images/yurthub-40267e14a620859d35d3085eb5de2d24.png"></p><p>ä¸Kubernetesè®¾è®¡ç†å¿µå¥‘åˆï¼ŒYurtHubçš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯ï¼Œéå¸¸å®¹æ˜“æ‰©å±•å‡ºæ›´å¤šçš„èƒ½åŠ›ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurthubçš„æ‹“å±•èƒ½åŠ›">YurtHubçš„æ‹“å±•èƒ½åŠ›<a aria-hidden="true" class="hash-link" href="#yurthubçš„æ‹“å±•èƒ½åŠ›" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1è¾¹ç¼˜ç½‘ç»œè‡ªæ²»">1ï¼‰è¾¹ç¼˜ç½‘ç»œè‡ªæ²»<a aria-hidden="true" class="hash-link" href="#1è¾¹ç¼˜ç½‘ç»œè‡ªæ²»" title="Direct link to heading">â€‹</a></h3><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä½•è°“è¾¹ç¼˜ç½‘ç»œè‡ªæ²»ï¼šå³åœ¨è¾¹ç¼˜å’Œäº‘ç«¯ç½‘ç»œæ–­è¿æ—¶ï¼Œä¸ç®¡æ˜¯ä¸šåŠ¡å®¹å™¨é‡å¯ï¼Œæˆ–æ˜¯è¾¹ç¼˜èŠ‚ç‚¹é‡å¯ç­‰ï¼Œè¾¹ç¼˜ä¸šåŠ¡çš„è·¨èŠ‚ç‚¹é€šä¿¡å¯ä»¥æŒç»­å·¥ä½œæˆ–æ˜¯è‡ªåŠ¨æ¢å¤ã€‚</p><p>åœ¨OpenYurtä¸­ï¼Œå®ç°è¾¹ç¼˜è‡ªæ²»éœ€è¦è§£å†³å¦‚ä¸‹çš„é—®é¢˜ï¼ˆä»¥flannel vxlan overlayç½‘ç»œä¸ºä¾‹ï¼‰ï¼š</p><ul><li>é—®é¢˜ 1: èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œé…ç½®å¯ä»¥è‡ªæ²»ï¼Œkube-proxy çš„ iptables / ipvs è§„åˆ™ï¼Œflannel çš„ fdb / arp / route é…ç½®ï¼Œcoredns çš„åŸŸåè§£æç­‰ç½‘ç»œé…ç½®ï¼Œåœ¨èŠ‚ç‚¹é‡å¯åå¯ä»¥è‡ªåŠ¨æ¢å¤ï¼Œå¦åˆ™è¾¹ç¼˜è·¨èŠ‚ç‚¹é€šä¿¡å°†æ— æ³•æŒç»­ï¼›</li><li>é—®é¢˜ 2: ä¸šåŠ¡å®¹å™¨ IP ä¿æŒä¸å˜ï¼Œå› ä¸ºå’Œäº‘ç«¯ç½‘ç»œæ–­è¿çŠ¶æ€ä¸‹å®¹å™¨ IP å˜åŒ–å°†æ— æ³•é€šçŸ¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼›</li><li>é—®é¢˜ 3: vtep(vxlan tunnel endpoint) çš„ mac åœ°å€ä¿æŒä¸å˜ï¼ŒåŸå› å’Œå®¹å™¨ IP ä¿æŒä¸å˜ç±»ä¼¼ã€‚</li></ul><p>ä»é—®é¢˜ 1 å¯ä»¥çœ‹å‡ºï¼Œå¿…é¡»è§£å†³ kube-proxy / flannel / coredns ç­‰ç»„ä»¶çš„è‡ªæ²»ï¼Œæ‰èƒ½å®ç°ç½‘ç»œé…ç½®çš„è‡ªæ²»ã€‚å¦‚æœä¹‹å‰è¾¹ç¼˜è‡ªæ²»æ˜¯é‡‡ç”¨é‡æ„ kubelet æ¥å®ç°çš„è¯ï¼Œè¦å®ç°è¾¹ç¼˜ç½‘ç»œè‡ªæ²»å°±ä¼šç¢°åˆ°å¾ˆå¤§çš„éº»çƒ¦ï¼Œå¦‚æœå¼ºè¡ŒæŠŠé‡æ„çš„ kubelet è‡ªæ²»èƒ½åŠ›ç§»æ¤åˆ°å„ä¸ªç½‘ç»œç»„ä»¶ (kube-proxy / flannel / coredns)ï¼Œä¹Ÿå¯¹æ•´ä¸ªæ¶æ„å°†æ˜¯å™©æ¢¦ã€‚</p><p>åœ¨ OpenYurt ä¸­å› ä¸º YurtHub çš„ç‹¬ç«‹æ€§ï¼Œkube-proxy / flannel / coredns ç­‰ç½‘ç»œç»„ä»¶è½»æ¾ä½¿ç”¨ YurtHub æ¥å®ç°ç½‘ç»œé…ç½®çš„è‡ªæ²»èƒ½åŠ›ã€‚å› ä¸º YurtHub ç¼“å­˜äº† service ç­‰ç½‘ç»œé…ç½®èµ„æºåœ¨ local storageï¼Œå³ä½¿æ–­ç½‘å¹¶ä¸”èŠ‚ç‚¹é‡å¯ï¼Œç½‘ç»œç»„ä»¶ä»ç„¶å¯ä»¥è·å¾—æ–­ç½‘å‰çš„ object çŠ¶æ€ä»¥åŠç›¸åº”çš„é…ç½®ä¿¡æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img alt="image" src="/assets/images/local_storage-1840a2ad53f7d9f8ea961465a9104ee8.png"></p><p>é—®é¢˜ 2ï¼Œ3 å’Œ Kubernetes core æ— å…³ï¼Œä¸»è¦æ¶‰åŠåˆ° cni æ’ä»¶å’Œ flanneld çš„å¢å¼ºï¼Œåç»­æ–‡ç« ä¸­å†è¯¦ç»†ä»‹ç»ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2å¤šäº‘ç«¯åœ°å€æ”¯æŒ">2ï¼‰å¤šäº‘ç«¯åœ°å€æ”¯æŒ<a aria-hidden="true" class="hash-link" href="#2å¤šäº‘ç«¯åœ°å€æ”¯æŒ" title="Direct link to heading">â€‹</a></h3><p>å…¬æœ‰äº‘ä¸Šçš„ Kubernetes é«˜å¯ç”¨éƒ¨ç½²æ—¶ï¼Œå¤šå®ä¾‹ kube-apiserver å‰é¢ä¸€èˆ¬éƒ½æŒ‚äº†ä¸€ä¸ª SLBï¼Œä½†æ˜¯åœ¨ä¸“æœ‰äº‘åœºæ™¯ä¸‹æˆ–è€…è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹ï¼ŒèŠ‚ç‚¹éœ€è¦é€šè¿‡å¤šä¸ªäº‘ç«¯åœ°å€æ¥è®¿é—®ã€‚æ¯”å¦‚:</p><ul><li>ä¸“æœ‰äº‘åœºæ™¯ï¼šå› ä¸ºæ²¡æœ‰ SLB æœåŠ¡ï¼Œç”¨æˆ·éœ€è¦åœ¨äº‘ç«¯é€šè¿‡ VIP æ–¹å¼æ¥è‡ªè¡Œå®ç° kube-apiserver çš„è´Ÿè½½å‡è¡¡ï¼Œæˆ–è€…åƒ kubespray é‚£æ ·åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ª nginx æ¥å®ç°å¤šäº‘ç«¯åœ°å€çš„è®¿é—®ï¼›</li><li>è¾¹ç¼˜è®¡ç®—åœºæ™¯: è€ƒè™‘åˆ°è¾¹ç¼˜å’Œäº‘ç«¯ä¹‹é—´ç½‘ç»œçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§è¦æ±‚ï¼ŒæŸäº›åœºæ™¯ä¸‹ç”¨æˆ·ä¹Ÿé€šè¿‡ä¸“çº¿å’Œå…¬ç½‘ä¸¤ç§æ–¹å¼å’Œäº‘ç«¯é€šä¿¡ï¼Œæ¯”å¦‚ä¼˜å…ˆé‡‡ç”¨ä¸“çº¿ï¼Œå½“ä¸“çº¿æ•…éšœæ—¶èƒ½è‡ªåŠ¨åˆ‡æ¢åˆ°å…¬ç½‘é€šä¿¡ã€‚</li></ul><p>YurtHubæ­£å¼è€ƒè™‘åˆ°äº†ä¸Šè¿°çš„éœ€æ±‚ï¼Œæ”¯æŒå¤šäº‘ç«¯åœ°å€è®¿é—®ã€‚äº‘ç«¯åœ°å€çš„è´Ÿè½½å‡è¡¡æ¨¡å¼å¯ä»¥é€‰æ‹©ï¼š</p><ul><li><p>rr(round-robin)ï¼šè½®è½¬æ¨¡å¼ï¼Œé»˜è®¤é€‰æ‹©è¯¥æ¨¡å¼ï¼›</p></li><li><p>priority: ä¼˜å…ˆçº§æ¨¡å¼ï¼Œé«˜ä¼˜å…ˆçº§åœ°å€æ•…éšœåæ‰ä½¿ç”¨ä½ä¼˜å…ˆçº§åœ°å€ã€‚</p></li></ul><p>å…·ä½“å¯ä»¥å‚ç…§ YurtHub çš„ LB æ¨¡å—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img alt="image" src="/assets/images/local_storage-1840a2ad53f7d9f8ea961465a9104ee8.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3èŠ‚ç‚¹ç»´åº¦çš„äº‘ç«¯æµæ§">3ï¼‰èŠ‚ç‚¹ç»´åº¦çš„äº‘ç«¯æµæ§<a aria-hidden="true" class="hash-link" href="#3èŠ‚ç‚¹ç»´åº¦çš„äº‘ç«¯æµæ§" title="Direct link to heading">â€‹</a></h3><p>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œæµæ§éƒ½æ˜¯ä¸€ä¸ªæ— æ³•å›é¿çš„é—®é¢˜ã€‚åŸç”Ÿ Kubernetes ä»é›†ç¾¤è§†è§’åœ¨ kube-apiserver ä¸­ä»¥åŠä»è®¿é—®è€…è§†è§’åœ¨ client-go åº“ä¸­å°è£…äº†æµé‡ç®¡æ§ï¼Œåœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹ï¼Œclient-go çš„æµé‡ç®¡æ§æ—¢åˆ†æ•£åˆå¯¹ä¸šåŠ¡æœ‰ä¸€å®šä¾µå…¥ï¼Œæ˜¾ç„¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³æµæ§é—®é¢˜ã€‚</p><p>YurtHub åœ¨è¾¹ç¼˜å¯ä»¥æ¥ç®¡ä¸è®ºæ˜¯ç³»ç»Ÿç»„ä»¶è¿˜æ˜¯ä¸šåŠ¡å®¹å™¨å¯¹äº‘ç«¯è®¿é—®çš„æµé‡ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³èŠ‚ç‚¹ç»´åº¦çš„äº‘ç«¯æµæ§é—®é¢˜ã€‚ç›®å‰ YurtHub çš„æµæ§é…ç½®æ˜¯ï¼šå•èŠ‚ç‚¹ä¸Šå¯¹äº‘ç«¯çš„å¹¶å‘è¯·æ±‚æ•°è¶…è¿‡ 250 ä¸ªæ—¶ï¼Œå°†æ‹’ç»æ–°çš„è¯·æ±‚ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4èŠ‚ç‚¹è¯ä¹¦è½®è½¬ç®¡ç†">4ï¼‰èŠ‚ç‚¹è¯ä¹¦è½®è½¬ç®¡ç†<a aria-hidden="true" class="hash-link" href="#4èŠ‚ç‚¹è¯ä¹¦è½®è½¬ç®¡ç†" title="Direct link to heading">â€‹</a></h3><p>Kubernetes å·²ç»æ”¯æŒèŠ‚ç‚¹è¯ä¹¦è‡ªåŠ¨è½®æ¢ï¼Œå³å½“èŠ‚ç‚¹è¯ä¹¦å¿«è¿‡æœŸå‰ï¼Œkubelet ä¼šè‡ªåŠ¨å‘äº‘ç«¯ç”³è¯·æ–°çš„èŠ‚ç‚¹è¯ä¹¦ã€‚ä½†æ˜¯åœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½å› ä¸ºè¾¹ç¼˜å’Œäº‘ç«¯ç½‘ç»œçš„æ–­è¿ï¼Œé€ æˆ kubelet å°†æ— æ³•å®Œæˆè¯ä¹¦çš„è½®æ¢ã€‚è¯ä¹¦è¿‡æœŸåå³ä½¿å’Œäº‘ç«¯ç½‘ç»œè¿æ¥æ¢å¤ï¼ŒèŠ‚ç‚¹è¯ä¹¦ä¹Ÿå¯èƒ½æ— æ³•è‡ªåŠ¨è½®æ¢ï¼Œå¹¶é€ æˆ kubelet çš„é¢‘ç¹é‡å¯ã€‚</p><p>YurtHub åœ¨æ¥ç®¡èŠ‚ç‚¹å’Œäº‘ç«¯é€šä¿¡æµé‡æ—¶ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ¥ç®¡èŠ‚ç‚¹çš„è¯ä¹¦ç®¡ç†ã€‚è¿™æ ·æ—¢è§£å†³äº†å„ç±»å®‰è£…å·¥å…·å¯¹èŠ‚ç‚¹è¯ä¹¦çš„ç®¡ç†çš„ä¸ä¸€è‡´ï¼Œä¹Ÿè§£å†³äº†è¯ä¹¦è¿‡æœŸåç½‘ç»œå†æ¢å¤æ—¶çš„è¯ä¹¦è½®æ¢é—®é¢˜ã€‚å¦å¤–ç›®å‰ YurtHub è¿˜æ˜¯ kubelet å…±äº«èŠ‚ç‚¹è¯ä¹¦ï¼ŒYurtHub çš„ç‹¬ç«‹èŠ‚ç‚¹è¯ä¹¦ç®¡ç†åŠŸèƒ½å°†åœ¨è¿‘æœŸå¼€æºã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="5å…¶ä»–">5ï¼‰å…¶ä»–<a aria-hidden="true" class="hash-link" href="#5å…¶ä»–" title="Direct link to heading">â€‹</a></h3><p>YurtHub é™¤äº†å‰é¢ä»‹ç»çš„æ‰©å±•èƒ½åŠ›ï¼Œè¿˜æœ‰å¾ˆå¤šæœ‰ä»·å€¼çš„èƒ½åŠ›ï¼Œåœ¨æ­¤ä¹Ÿç®€å•ä»‹ç»ï¼š</p><ul><li>èŠ‚ç‚¹å¤šç§Ÿéš”ç¦»ç®¡ç†ï¼šåœ¨å…·å¤‡å¤šç§Ÿéš”ç¦»èƒ½åŠ›çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œå‡å®šèŠ‚ç‚¹å½’å±äºæŸä¸ªç§Ÿæˆ·ï¼Œé‚£ä¹ˆ YurtHub å°†å¯ä»¥ç¡®ä¿èŠ‚ç‚¹ä¸Šæ‰€æœ‰äº‘ç«¯è¯·æ±‚éƒ½åªè¿”å›èŠ‚ç‚¹æ‰€å±ç§Ÿæˆ·çš„èµ„æºã€‚æ¯”å¦‚è¯´ list service å°†åªè¿”å›è¯¥ç§Ÿæˆ·çš„ serviceã€‚è€Œè¿™ç§å¤šç§Ÿéš”ç¦»èƒ½åŠ›ä¸éœ€è¦å…¶ä»–ç»„ä»¶åšä»»ä½•ä¿®æ”¹ã€‚å½“ç„¶å¦‚æœè¦å®ç°é›†ç¾¤å†…çš„å¤šç§Ÿéš”ç¦»ï¼Œéœ€è¦é…åˆç›¸åº”çš„å¤šç»„ CRD ç­‰ï¼Œè¯¦ç»†å¯ä»¥å‚ç…§<a href="https://github.com/kubernetes-sigs/multi-tenancy" target="_blank" rel="noopener noreferrer">é¡¹ç›®kubernetes-sigs/multi-tenancy</a></li><li>é›†ç¾¤é—´èŠ‚ç‚¹è¿ç§»ï¼šæŸäº›åœºæ™¯ä¸‹ï¼Œè¾¹ç¼˜èŠ‚ç‚¹éœ€è¦ä»é›†ç¾¤ A è¿ç§»åˆ°é›†ç¾¤ Bï¼Œå¸¸è§„æ“ä½œæ˜¯å…ˆä»é›†ç¾¤ A ä¸‹çº¿ï¼Œç„¶åå†æ¬¡æ¥å…¥é›†ç¾¤ Bï¼Œæœ€ååœ¨é›†ç¾¤ B éƒ¨ç½²èŠ‚ç‚¹ä¸Šçš„åº”ç”¨ã€‚å› ä¸º YurtHub å¯¹èŠ‚ç‚¹æµé‡ä»¥åŠèŠ‚ç‚¹è¯ä¹¦çš„æ¥ç®¡ï¼Œå¯ä»¥ç›´æ¥å¯¹ YurtHub æ³¨å…¥é›†ç¾¤Bçš„ä¿¡æ¯ï¼Œè®©èŠ‚ç‚¹æ— æŸè¿ç§»åˆ°é›†ç¾¤ Bï¼›</li><li>é€šè¿‡åŸŸåè®¿é—®äº‘ç«¯kube-apiserverç­‰ç­‰ä¸€äº›å…¶ä»–åŠŸèƒ½ã€‚</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æ€»ç»“">æ€»ç»“<a aria-hidden="true" class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h2><p>é€šè¿‡ä¸Šè¿°çš„æ‰©å±•èƒ½åŠ›å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>YurtHub ä¸ä»…ä»…æ˜¯è¾¹ç¼˜èŠ‚ç‚¹ä¸Šçš„å¸¦æœ‰æ•°æ®ç¼“å­˜èƒ½åŠ›çš„åå‘ä»£ç†ï¼Œè€Œä¸”å¯¹ Kubernetes èŠ‚ç‚¹åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†åŠ äº†ä¸€å±‚æ–°çš„å°è£…ï¼Œæä¾›è¾¹ç¼˜è®¡ç®—æ‰€éœ€è¦çš„æ ¸å¿ƒç®¡æ§èƒ½åŠ›ï¼›</li></ul><ul><li>YurtHub ä¸ä»…ä»…é€‚ç”¨äºè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œå…¶å®è¿˜å¯ä»¥ä½œä¸ºèŠ‚ç‚¹ä¾§çš„ä¸€ä¸ªå¸¸å¤‡ç»„ä»¶ï¼Œé€‚ç”¨äºä½¿ç”¨ Kubernetes çš„ä»»æ„åœºæ™¯ã€‚ç›¸ä¿¡è¿™ä¹Ÿä¼šé©±åŠ¨ YurtHub å‘æ›´é«˜æ€§èƒ½ï¼Œæ›´é«˜ç¨³å®šæ€§å‘å±•ã€‚</li></ul><p><a href="https://mp.weixin.qq.com/s/gYxK3GLhDRNkHibYgTchOg" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/yurthub">yurthub</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/YurtHub-design-detail">YurtHub Design Detail:edge autonomy of OpenYurt</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-06-18T00:00:00.000Z" itemprop="datePublished">June 18, 2020</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">rambohe</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img alt="image" src="/assets/images/OpenYurt-de0f93f0c16ddb05b6782cbe66107b22.png"></p><p>å¯¼è¯»ï¼šOpenYurt å¼€æºä¸¤å‘¨ä»¥æ¥ï¼Œä»¥éä¾µå…¥å¼çš„æ¶æ„è®¾è®¡èåˆäº‘åŸç”Ÿå’Œè¾¹ç¼˜è®¡ç®—ä¸¤å¤§é¢†åŸŸï¼Œå¼•èµ·äº†ä¸å°‘è¡Œä¸šå†…åŒå­¦çš„å…³æ³¨ã€‚é˜¿é‡Œäº‘æ¨å‡ºå¼€æºé¡¹ç›® OpenYurtï¼Œä¸€æ–¹é¢æ˜¯æŠŠé˜¿é‡Œäº‘åœ¨äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—é¢†åŸŸçš„ç»éªŒå›é¦ˆç»™å¼€æºç¤¾åŒºï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¸Œæœ›åŠ é€Ÿäº‘è®¡ç®—å‘è¾¹ç¼˜å»¶ä¼¸çš„è¿›ç¨‹ï¼Œå¹¶å’Œç¤¾åŒºå…±åŒæ¢è®¨æœªæ¥äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—æ¶æ„çš„ç»Ÿä¸€æ ‡å‡†ã€‚
æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»OpenYurtçš„è¾¹ç¼˜è‡ªæ²»èƒ½åŠ›çš„è®¾è®¡ç»†èŠ‚ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="è¾¹ç¼˜è‡ªæ²»ç‰¹æ€§">è¾¹ç¼˜è‡ªæ²»ç‰¹æ€§<a aria-hidden="true" class="hash-link" href="#è¾¹ç¼˜è‡ªæ²»ç‰¹æ€§" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1ç‰¹æ€§ä»‹ç»">1ï¼‰ç‰¹æ€§ä»‹ç»<a aria-hidden="true" class="hash-link" href="#1ç‰¹æ€§ä»‹ç»" title="Direct link to heading">â€‹</a></h3><p>å°† Kubernetes ç³»ç»Ÿå»¶å±•åˆ°è¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å°†é€šè¿‡å…¬ç½‘å’Œäº‘ç«¯è¿æ¥ï¼Œä»å…¬ç½‘çš„ä¸ç¨³å®šæ€§ä»¥åŠæˆæœ¬ç­‰å› ç´ è€ƒè™‘ï¼Œè¾¹ç¼˜è¦æ±‚æ–­ç½‘çŠ¶æ€æˆ–è€…å¼±ç½‘çŠ¶æ€ä¸‹è¾¹ç¼˜ä¸šåŠ¡å¯ä»¥æŒç»­è¿è¡Œã€‚æˆ‘ä»¬ä» Gartner çš„è¾¹ç¼˜è®¡ç®—æŠ¥å‘Šä¸­æåˆ°çš„è¾¹ç¼˜è®¡ç®—è¯‰æ±‚ä¸­ï¼Œè¾¹ç¼˜è‡ªæ²»ä¹Ÿæ˜¯ä¸»è¦è¯‰æ±‚ä¹‹ä¸€ï¼š
<img alt="image" src="/assets/images/Gartner-191be30024185ef4f96cfa64c5018d75.png"></p><p>ä» Kubernetes ç³»ç»Ÿæ¶æ„æ¥çœ‹ï¼Œä¸»è¦å› ä¸º Slave Agent(Kubelet) ä¸­çš„å®¹å™¨ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ–­ç½‘çŠ¶æ€ä¸‹å› ä¸ºæ— æ³•ä»äº‘ç«¯è·å–ä¸šåŠ¡æ•°æ®ï¼Œå¦‚æœèŠ‚ç‚¹æˆ–è€… Kubelet é‡å¯ï¼Œå°†æ— æ³•è¿›è¡Œä¸šåŠ¡å®¹å™¨æ¢å¤ã€‚
<img alt="image" src="/assets/images/slave_agent-78fcbd7915b7c27d65a0147c3283c27a.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2è¾¹ç¼˜è‡ªæ²»éœ€è¦è§£å†³çš„é—®é¢˜">2ï¼‰è¾¹ç¼˜è‡ªæ²»éœ€è¦è§£å†³çš„é—®é¢˜<a aria-hidden="true" class="hash-link" href="#2è¾¹ç¼˜è‡ªæ²»éœ€è¦è§£å†³çš„é—®é¢˜" title="Direct link to heading">â€‹</a></h3><p>å› æ­¤è¾¹ç¼˜è‡ªæ²»åœ¨Kubernetesç³»ç»Ÿé‡Œï¼Œéœ€è¦è§£å†³ä¸‹é¢çš„é—®é¢˜ï¼š</p><ul><li><p>é—®é¢˜ 1ï¼šèŠ‚ç‚¹å¼‚å¸¸æˆ–é‡å¯æ—¶ï¼Œå†…å­˜æ•°æ®ä¸¢å¤±ï¼Œç½‘ç»œæ–­è¿æ—¶ä¸šåŠ¡å®¹å™¨æ— æ³•æ¢å¤ï¼›</p></li><li><p>é—®é¢˜ 2ï¼šç½‘ç»œé•¿æ—¶é—´æ–­è¿ï¼Œäº‘ç«¯æ§åˆ¶å™¨å¯¹ä¸šåŠ¡å®¹å™¨è¿›è¡Œé©±é€ï¼›</p></li><li><p>é—®é¢˜ 3ï¼šé•¿æ—¶é—´æ–­è¿åç½‘ç»œæ¢å¤æ—¶ï¼Œè¾¹ç¼˜å’Œäº‘ç«¯æ•°æ®çš„ä¸€è‡´æ€§ä¿éšœã€‚</p></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ1">é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ1<a aria-hidden="true" class="hash-link" href="#é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ1" title="Direct link to heading">â€‹</a></h4><p>é‡æ„ kubelet ç»„ä»¶ï¼Œå¤ç”¨æˆ–è€…å‚è€ƒ kubelet çš„ checkpoint åŠŸèƒ½ï¼ŒæŒä¹…åŒ–å®¹å™¨ä¸šåŠ¡æ•°æ®åˆ°æœ¬åœ°ç£ç›˜ï¼Œç½‘ç»œæ–­è¿çŠ¶æ€ä¸‹åˆ©ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®å®ç°ä¸šåŠ¡æ¢å¤ã€‚
<img alt="image" src="/assets/images/checkpoint-7a1381e53605c36f128716d35475b6a5.png">
è¯¥æ–¹æ¡ˆç»è¿‡é‡æ„ kubeletï¼ŒæˆåŠŸè§£å†³è¾¹ç¼˜è‡ªæ²»çš„éœ€æ±‚ï¼Œå…·å¤‡å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li><p>é€šè¿‡é‡æ„ kubeletï¼Œæ–¹ä¾¿åœ¨ kubelet ä¸­é›†æˆå¯¹ç«¯è®¾å¤‡çš„ç®¡ç†èƒ½åŠ›ï¼›</p></li><li><p>é€šè¿‡é‡æ„ kubeletï¼Œå¯ä»¥å¯¹ kubelet è¿›è¡Œè½»é‡åŒ–æ”¹é€ ã€‚æ­¤ä¼˜ç‚¹ä½†æ˜¯ä¹Ÿæ„å‘³ç€åŸç”Ÿ kubelet åŠŸèƒ½ç¼ºå¤±çš„é—®é¢˜ã€‚</p></li></ul><p>ä½†æ˜¯ä¹Ÿæœ‰å¦‚ä¸‹ä¸è¶³ï¼š</p><ul><li><p>å¯ç»´æŠ¤æ€§å·®: ä¾µå…¥å¼ä¿®æ”¹ kubelet coreï¼Œè·Ÿéšç¤¾åŒºç‰ˆæœ¬å‡çº§éå¸¸å›°éš¾ï¼Œç†Ÿæ‚‰kubeletçš„åŒå­¦éƒ½ä¼šæœ‰åŒæ„Ÿï¼Œkubelet ç»„ä»¶ç”±äºç›´æ¥è´Ÿè´£è®¡ç®—ï¼Œå­˜å‚¨ï¼Œç½‘ç»œäº¤äº’ï¼Œæ‰€ä»¥å…¶ä»£ç ç»“æ„å’Œé€»è¾‘å¼‚å¸¸å¤æ‚ã€‚å› æ­¤æŒç»­ç»´æŠ¤ä¸€ä¸ªæ·±åº¦ä¿®æ”¹è¿‡çš„ kubelet çš„å·¥ä½œé‡å¯æƒ³è€ŒçŸ¥ï¼›</p></li><li><p>å¯æ‰©å±•æ€§å·®: å› ä¸ºè‡ªæ²»èƒ½åŠ›ç›´æ¥åšåˆ°é‡æ„çš„ kubelet ç»„ä»¶ä¸­ï¼Œè¿™æ ·è¾¹ç¼˜èŠ‚ç‚¹å¦‚æœå…¶ä»–ç»„ä»¶(å¦‚ç½‘ç»œç»„ä»¶)æƒ³å¤ç”¨è¾¹ç¼˜è‡ªæ²»èƒ½åŠ›å°†é¢ä¸´é‡å¤é€ è½®å­çš„å¢ƒåœ°ï¼›</p></li><li><p>åœºæ™¯è€¦åˆæ›´æ·±: ä¾‹å¦‚åœ¨ kubelet é‡æ„ä¸­å¢åŠ äº† IOT è®¾å¤‡ç®¡ç†ï¼Œå°†å¯èƒ½ä½¿ kubelet å’Œ IOT åœºæ™¯æ·±åº¦è€¦åˆã€‚</p></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ2openyurtä½¿ç”¨æ–¹æ¡ˆ">é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ2ï¼ˆOpenYurtä½¿ç”¨æ–¹æ¡ˆï¼‰<a aria-hidden="true" class="hash-link" href="#é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆ2openyurtä½¿ç”¨æ–¹æ¡ˆ" title="Direct link to heading">â€‹</a></h4><p>åœ¨è¾¹ç¼˜èŠ‚ç‚¹ä¸Šå¢åŠ  web ç¼“å­˜åŠè¯·æ±‚ä»£ç† hub(å–åä¸º YurtHubï¼Œå•†ä¸šäº§å“ä¸­åä¸º edge-hub)ï¼Œè¾¹ç¼˜ä¾§ç»„ä»¶(kubelet)å’Œäº‘ç«¯é€šä¿¡å°†ç»ç”±è¯¥ç»„ä»¶ã€‚YurtHub ç›¸å½“äºå¸¦æœ‰æ•°æ®ç¼“å­˜åŠŸèƒ½çš„â€é€æ˜ç½‘å…³â€œï¼Œå’Œäº‘ç«¯ç½‘ç»œæ–­è¿çŠ¶æ€ä¸‹ï¼Œå¦‚æœèŠ‚ç‚¹æˆ–è€… kubelet é‡å¯ï¼Œå°†ä» YurtHub ä¸­è·å–åˆ°ä¸šåŠ¡å®¹å™¨ç›¸å…³æ•°æ®ï¼Œæœ‰æ•ˆè§£å†³è¾¹ç¼˜è‡ªæ²»çš„é—®é¢˜</p><p><img alt="image" src="/assets/images/edge_hub-08066dde85946999b57d59dac0a6cbe8.png"></p><p>ç›¸æ¯”è§£å†³æ–¹æ¡ˆ1ï¼Œæœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li><p>kubelet é›¶ä¿®æ”¹ï¼Œæ„å‘³åŸç”Ÿ kubelet èƒ½åŠ›å¤©ç„¶å…·å¤‡ï¼ŒåŒæ—¶è·Ÿéš Kubernetes ç‰ˆæœ¬å‡çº§é›¶è´Ÿæ‹…ï¼›</p></li><li><p>å¯æ‰©å±•æ€§å¼ºï¼ŒèŠ‚ç‚¹å…¶ä»–ç»„ä»¶è½»æ¾å¤ç”¨ YurtHubï¼›</p></li><li><p>ä¸ Kubernetes è®¾è®¡ç†å¿µå¥‘åˆï¼ŒYurtHub éå¸¸å®¹æ˜“æ‰©å±•å‡ºæ›´å¤šçš„èƒ½åŠ›ã€‚</p></li></ul><p>å½“ç„¶ OpenYurt çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿä¼šé¢ä¸´å¦‚ä¸‹çš„é—®é¢˜ï¼šåŸç”Ÿ kubelet æ¯”è¾ƒ high-weightï¼Œåœ¨èµ„æºç´§å¼ åœºæ™¯ä¸‹åº”ç”¨ä¼šæ¯”è¾ƒæŒ‘æˆ˜ã€‚ç›®å‰å•†ä¸šäº§å“ä¸­èŠ‚ç‚¹è§„æ ¼æ¨è 2U4G èµ·æ­¥ã€‚</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="é—®é¢˜2çš„è§£å†³æ–¹æ¡ˆ">é—®é¢˜2çš„è§£å†³æ–¹æ¡ˆ<a aria-hidden="true" class="hash-link" href="#é—®é¢˜2çš„è§£å†³æ–¹æ¡ˆ" title="Direct link to heading">â€‹</a></h4><p>è¯¥é—®é¢˜æ­£æ˜¯é€šè¿‡å¼€æºç»„ä»¶ yurt-controller-manager ä¸­çš„ Node Controller æ¥è§£å†³çš„ã€‚å¦‚ github ä¸»é¡µä»‹ç»æ‰€ç¤ºï¼š
<img alt="image" src="/assets/images/OpenYurt_arch-a3dcd2a758bb9c978f52c8a61c6a98f6.png"></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="é—®é¢˜3çš„è§£å†³æ–¹æ¡ˆ">é—®é¢˜3çš„è§£å†³æ–¹æ¡ˆ<a aria-hidden="true" class="hash-link" href="#é—®é¢˜3çš„è§£å†³æ–¹æ¡ˆ" title="Direct link to heading">â€‹</a></h4><p>Kubernetes ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ˜¯é€šè¿‡äº‘ç«¯å¯¹è¾¹ç¼˜è¿›è¡Œç®¡æ§çš„(å¦‚åº”ç”¨éƒ¨ç½²ï¼Œå‡çº§ï¼Œæ‰©ç¼©å®¹ç­‰)ï¼Œå› æ­¤å½“è¾¹ç¼˜å’Œäº‘ç«¯ç½‘ç»œæ–­è”æ—¶ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å°†ä¸ä¼šä»äº‘ç«¯åŒæ­¥ç”¨æˆ·å¯¹èŠ‚ç‚¹çš„ç®¡æ§æ“ä½œï¼Œå› æ­¤æ–­ç½‘æœŸé—´ï¼Œåªè¦ YurtHub ä¿æŒæœ¬åœ°ç¼“å­˜æ•°æ®å’Œæ–­ç½‘æ—¶åˆ»ä¸€è‡´(å³æ–­ç½‘æœŸé—´è¾¹ç¼˜ç¼“å­˜æ•°æ®ä¸æ›´æ–°)ï¼Œè€Œç½‘ç»œæ¢å¤æ—¶ï¼Œå†ä»äº‘ç«¯åŒæ­¥æœ€æ–°æ•°æ®å³å¯ã€‚</p><p><a href="https://mp.weixin.qq.com/s/4BLfvMJJA623ZwRSgUE69A" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/yurthub">yurthub</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Use-of-yurtctl">Yurtctl:make the native k8s cluster achieve edge computing capabilities</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2020</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/charleszheng44.png" alt="Chao Zheng"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chao Zheng</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img alt="image" src="/assets/images/OpenYurt-de0f93f0c16ddb05b6782cbe66107b22.png"></p><p>éšç€ç‰©è”ç½‘æŠ€æœ¯ä»¥åŠ 5G æŠ€æœ¯çš„é«˜é€Ÿå‘å±•ï¼Œå°†äº‘è®¡ç®—çš„èƒ½åŠ›å»¶ä¼¸è‡³è¾¹ç¼˜è®¾å¤‡ç«¯ï¼Œå¹¶é€šè¿‡ä¸­å¿ƒè¿›è¡Œç»Ÿä¸€äº¤ä»˜ã€ç®¡æ§ï¼Œå·²æˆä¸ºäº‘è®¡ç®—çš„é‡è¦å‘å±•è¶‹åŠ¿ã€‚ä¸ºæœåŠ¡æ›´å¤šå¼€å‘è€…æŠŠæ¡è¿™ä¸€è¶‹åŠ¿ï¼Œ5æœˆ29æ—¥ï¼Œé˜¿é‡Œå·´å·´æ­£å¼å¯¹å¤–å¼€æºäº†åŸºäº ACK@Edgeï¼ˆè¾¹ç¼˜é›†ç¾¤æ‰˜ç®¡æœåŠ¡ï¼‰çš„äº‘åŸç”Ÿè¾¹ç¼˜è®¡ç®—æ¡†æ¶ â€”â€”
<a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer">OpenYurt</a></p><p>è‡ª OpenYurt å¼€æºä»¥æ¥å—åˆ°äº†å¼€å‘è€…çš„å…³æ³¨ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« å°†å¸¦å¤§å®¶å¿«é€Ÿä¸Šæ‰‹ OpenYurt ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ OpenYurt æä¾›çš„å‘½ä»¤è¡Œç®¡ç†å·¥å…· Yurtctlï¼Œ é«˜æ•ˆå¿«é€Ÿåœ°éƒ¨ç½² OpenYurt é›†ç¾¤ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="openyurtä»‹ç»">OpenYurtä»‹ç»<a aria-hidden="true" class="hash-link" href="#openyurtä»‹ç»" title="Direct link to heading">â€‹</a></h2><p>OpenYurt ä¸»æ‰“â€œäº‘è¾¹ä¸€ä½“åŒ–â€æ¦‚å¿µï¼Œä¾æ‰˜ Kubernetes å¼ºå¤§çš„å®¹å™¨åº”ç”¨ç¼–æ’èƒ½åŠ›ï¼Œæ»¡è¶³äº†äº‘è¾¹ä¸€ä½“åŒ–çš„åº”ç”¨åˆ†å‘ã€äº¤ä»˜ã€å’Œç®¡æ§çš„è¯‰æ±‚ã€‚ç›¸è¾ƒäºå…¶ä»–åŸºäº Kubernetes çš„è¾¹ç¼˜è®¡ç®—æ¡†æ¶ï¼ŒOpenYurt ç§‰æŒç€â€œæœ€å°ä¿®æ”¹â€åŸåˆ™ï¼Œé€šè¿‡åœ¨è¾¹ç¼˜èŠ‚ç‚¹å®‰è£… Yurthub ç»„ä»¶ï¼Œå’Œåœ¨äº‘ç«¯éƒ¨ç½² Yurt-controller-managerï¼Œä¿è¯äº†åœ¨å¯¹ Kubernetes é›¶ä¾µå…¥çš„æƒ…å†µä¸‹ï¼Œæä¾›ç®¡ç†è¾¹ç¼˜è®¡ç®—åº”ç”¨æ‰€éœ€çš„ç›¸å…³èƒ½åŠ›ã€‚</p><p>OpenYurt èƒ½å¸®ç”¨æˆ·è§£å†³åœ¨æµ·é‡è¾¹ã€ç«¯èµ„æºä¸Šå®Œæˆå¤§è§„æ¨¡åº”ç”¨äº¤ä»˜ã€è¿ç»´ã€ç®¡æ§çš„é—®é¢˜ï¼Œå¹¶æä¾›ä¸­å¿ƒæœåŠ¡ä¸‹æ²‰é€šé“ï¼Œå®ç°å’Œè¾¹ç¼˜è®¡ç®—åº”ç”¨çš„æ— ç¼å¯¹æ¥ã€‚åœ¨è®¾è®¡ OpenYurt ä¹‹åˆï¼Œæˆ‘ä»¬å°±éå¸¸å¼ºè°ƒä¿æŒç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ï¼Œä¸å¢åŠ ç”¨æˆ·è¿ç»´è´Ÿæ‹…ï¼Œè®©ç”¨æˆ·çœŸæ­£æ–¹ä¾¿åœ° â€œExtending your native kubernetes to edgeâ€ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yurtctlä¸€é”®è®©åŸç”Ÿk8sé›†ç¾¤å…·å¤‡è¾¹ç¼˜è®¡ç®—èƒ½åŠ›">Yurtctlï¼šä¸€é”®è®©åŸç”Ÿk8sé›†ç¾¤å…·å¤‡è¾¹ç¼˜è®¡ç®—èƒ½åŠ›<a aria-hidden="true" class="hash-link" href="#yurtctlä¸€é”®è®©åŸç”Ÿk8sé›†ç¾¤å…·å¤‡è¾¹ç¼˜è®¡ç®—èƒ½åŠ›" title="Direct link to heading">â€‹</a></h2><p>ä¸ºäº†è®©åŸç”Ÿ K8s é›†ç¾¤å…·å¤‡è¾¹ç¼˜è®¡ç®—èƒ½åŠ›ï¼ŒOpenYurt ä»¥ addon ä¸ºè½½ä½“ï¼Œéä¾µå…¥å¼ç»™åŸç”Ÿ K8s å¢å¼ºäº†å¦‚ä¸‹èƒ½åŠ›ï¼š</p><ul><li>è¾¹ç¼˜è‡ªæ²»èƒ½åŠ›ï¼ˆYurtHubï¼šå·²å¼€æºï¼‰ï¼Œä¿è¯åœ¨å¼±ç½‘æˆ–è€…é‡å¯èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²åœ¨è¾¹ç¼˜èŠ‚ç‚¹ä¸Šçš„åº”ç”¨ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œï¼›</li><li>äº‘è¾¹ååŒèƒ½åŠ›ï¼ˆå¾…å¼€æºï¼‰ï¼Œé€šè¿‡äº‘è¾¹è¿ç»´é€šé“è§£å†³è¾¹ç¼˜çš„è¿ç»´éœ€æ±‚ï¼ŒåŒæ—¶æä¾›äº‘è¾¹ååŒèƒ½åŠ›ï¼›</li><li>å•å…ƒåŒ–ç®¡ç†èƒ½åŠ›ï¼ˆå¾…å¼€æºï¼‰ï¼Œä¸ºåˆ†æ•£çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œè¾¹ç¼˜åº”ç”¨ï¼Œåº”ç”¨é—´æµé‡æä¾›å•å…ƒåŒ–é—­ç¯ç®¡ç†èƒ½åŠ›ï¼›</li></ul><p>åŸºäºè¿‡å¾€ACK@Edgeçš„çº¿ä¸Šè¿ç»´ç»éªŒï¼Œæˆ‘ä»¬å¼€æºäº†Yurtctlå‘½ä»¤è¡Œå·¥å…·ï¼Œå¸®åŠ©å®ç°äº†åŸç”ŸKuberneteså’ŒOpenYurtä¹‹é—´çš„æ— ç¼è½¬æ¢ä»¥åŠå¯¹OpenYurtç›¸å…³ç»„ä»¶çš„é«˜æ•ˆè¿ç»´ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="yurtctlçš„å·¥ä½œåŸç†">Yurtctlçš„å·¥ä½œåŸç†<a aria-hidden="true" class="hash-link" href="#yurtctlçš„å·¥ä½œåŸç†" title="Direct link to heading">â€‹</a></h3><p><img alt="image" src="/assets/images/Yurtctl_convert-a9c53e14e22eb124ca818cd77d382cd8.png"></p><p>Yurtctlæ˜¯ä¸€ä¸ªä¸­å¿ƒåŒ–çš„ç®¡æ§å·¥å…·ã€‚åœ¨ OpenYurtäº‘è¾¹ä¸€ä½“çš„æ¶æ„é‡Œï¼ŒYurtctl å°†ç›´æ¥ä¸ APIServer è¿›è¡Œäº¤äº’ã€‚å®ƒå€ŸåŠ©åŸç”Ÿ Kubernetesçš„Job workloadå¯¹æ¯ä¸ªnodeè¿›è¡Œè¿ç»´æ“ä½œã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨æ‰§è¡Œè½¬æ¢ï¼ˆconvertï¼‰æ“ä½œæ—¶ï¼ŒYurtctl ä¼šé€šè¿‡ Job å°†ä¸€ä¸ª servant Pod éƒ¨ç½²åˆ°ç”¨æˆ·æŒ‡å®šçš„è¾¹ç¼˜èŠ‚ç‚¹ä¸Šã€‚</p><p>servant Pod é‡Œçš„å®¹å™¨æ‰§è¡Œçš„å…·ä½“æ“ä½œè¯·å‚è€ƒï¼šï¼ˆOpenYurt:release-v0.1-beta.1ï½v0.3ï¼‰
<a href="https://github.com/openyurtio/openyurt/blob/release-v0.1-beta.1/config/yurtctl-servant/setup_edgenode" target="_blank" rel="noopener noreferrer">https://github.com/openyurtio/openyurt/blob/release-v0.1-beta.1/config/yurtctl-servant/setup_edgenode</a></p><p>ç”±äº servant Pod éœ€è¦ç›´æ¥æ“ä½œèŠ‚ç‚¹ root ç”¨æˆ·çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚å°† yurthub é…ç½®æ–‡ä»¶æ”¾ç½®äº /etc/kubernetes/manifests ç›®å½•ä¸‹ï¼‰ï¼Œå¹¶ä¸”éœ€è¦é‡ç½®ç³»ç»Ÿç®¡ç†ç¨‹åºï¼ˆkubelet.serviceï¼‰ï¼Œservant Pod ä¸­çš„ container å°†è¢«èµ‹äºˆ privileged æƒé™ï¼Œå…è®¸å…¶ä¸èŠ‚ç‚¹å…±äº« pid namespaceï¼Œå¹¶å°†å€Ÿç”± nsenter å‘½ä»¤è¿›å…¥èŠ‚ç‚¹ä¸»å‘½åç©ºé—´å®Œæˆç›¸å…³æ“ä½œã€‚å½“ servant Job æˆåŠŸæ‰§è¡Œåï¼ŒJob ä¼šè‡ªåŠ¨åˆ é™¤ã€‚å¦‚æœå¤±è´¥ï¼ŒJob åˆ™ä¼šè¢«ä¿ç•™ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜æ’æŸ¥é”™è¯¯åŸå› ã€‚å€Ÿç”±è¯¥æœºåˆ¶ï¼ŒYurtctl è¿˜å¯å¯¹ Yurthub è¿›è¡Œæ›´æ–°æˆ–è€…åˆ é™¤ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="æ¡ˆä¾‹ä¸€é”®è½¬æ¢openyurté›†ç¾¤">æ¡ˆä¾‹ï¼šä¸€é”®è½¬æ¢OpenYurté›†ç¾¤<a aria-hidden="true" class="hash-link" href="#æ¡ˆä¾‹ä¸€é”®è½¬æ¢openyurté›†ç¾¤" title="Direct link to heading">â€‹</a></h2><p>###1ï¼‰è·å–yurtctl
OpenYurt github ä»“åº“åŒ…æ‹¬äº† yurtctl çš„æºç ï¼Œä¸‹è½½ OpenYurt ä»“åº“ä¹‹åï¼Œå³å¯é€šè¿‡ç¼–è¯‘è·å¾— yurtctlï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ make build WHAT=cmd/yurtctl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hack/make-rules/build.sh cmd/yurtctl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Building cmd/yurtctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¼–è¯‘æˆåŠŸä¹‹åï¼Œyurtctl å¯æ‰§è¡Œæ–‡ä»¶å°±å¯ä»¥åœ¨ _output/bin/ ç›®å½•ä¸‹æ‰¾åˆ°ã€‚ </p><p>###2ï¼‰å°†Kubernetesè½¬æ¢ä¸ºOpenYurt
å¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªåŒèŠ‚ç‚¹ï¼ˆnode1 å’Œ node2ï¼‰çš„ Kubernetes é›†ç¾¤è½¬æ¢æˆ OpenYurt é›†ç¾¤ï¼Œå¹¶ä¸”åªæƒ³è®© node2 æˆä¸ºè‡ªæ²»è¾¹ç¼˜èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æ‰§è¡Œ yurtctl convert æ¥å®ç°ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ yurtctl convert --cloud-nodes node1 --provider ack</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:34:33.714304   40825 convert.go:164] mark node1 as the cloud-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:34:33.719816   40825 convert.go:172] mark node2 as the edge-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:34:33.736609   40825 convert.go:198] deploy the yurt controller manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:34:33.742272   40825 convert.go:210] deploying the yurt-hub and resetting the kubelet service...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:34:53.810165   40825 util.go:168] servant job(yurtctl-servant-convert-node2) has succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆåŠŸé…ç½®èŠ‚ç‚¹ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†è¾¹ç¼˜èŠ‚ç‚¹æ ‡è®°ä¸ºè‡ªæ²»çŠ¶æ€ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ yurtctl markautonomous # å¦‚æœç”¨æˆ·åªæƒ³æ ‡è®°éƒ¨åˆ†è¾¹ç¼˜èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ --autonomous-nodes é€‰é¡¹æŒ‡å®š</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0602 11:22:05.610222   89160 markautonomous.go:149] mark node2 as autonomous</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ç€æˆ‘ä»¬å°±å¯ä»¥æµ‹è¯• node2 åœ¨æ–­ç½‘ç¯å¢ƒä¸‹æ˜¯å¦èƒ½å®ç°èŠ‚ç‚¹è‡ªæ²»ã€‚é¦–å…ˆï¼Œåœ¨ node2 ä¸Šéƒ¨ç½²ä¸€ä¸ªæµ‹è¯• podï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl apply -f-&lt;&lt;EOF</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: bbox</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  nodeName: node2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - image: busybox</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - top</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name: bbox</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod/bbox created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç™»é™†åˆ° node2 ä¸Šï¼Œå°† Yurthub çš„ --server-addr å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªä¸å¯è®¿é—®çš„åœ°å€ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo sed -i &#x27;s|--server-addr=.*|--server-addr=https://1.1.1.1:1111|&#x27; /etc/kubernetes/manifests/yurt-hub.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è€å¿ƒç­‰å¾… 40 ç§’ï¼Œæˆ‘ä»¬å°†è§‚å¯Ÿåˆ°ï¼Œå³ä½¿ node2 å·²ç»å¤„äº NotReady çŠ¶æ€ï¼Œpod1 ä»ç„¶å¤„äº Running çŠ¶æ€ã€‚è¿™è¯´æ˜å½“è¾¹ç¼˜èŠ‚ç‚¹å¤„äºè‡ªæ²»çŠ¶æ€æ—¶ï¼Œå³ä½¿ node ä¸åœ¨çº¿ï¼ŒPod ä¹Ÿä¸ä¼šè¢«äº‘ç«¯ node controller é©±é€ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get node </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME           STATUS     ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node1          Ready      master   14m   v1.14.8</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node2          NotReady   &lt;none&gt;   12m   v1.14.8</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME   READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bbox   1/1     Running   0          5m12s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™æ—¶å¦‚æœå°† node2 é‡å¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ docker ps ï¼ˆå‡è®¾èŠ‚ç‚¹ä½¿ç”¨ docker ä½œä¸º container runtimeï¼‰å‘½ä»¤æ¥éªŒè¯ bbox Pod ä¼šè¢«é‡æ–°æ‹‰èµ·ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ docker ps --format &#x27;table {{.ID}}\t{{.Image}}\t{{.RunningFor}}&#x27; | grep busybox</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">d0c8134fddc1        busybox          About a minutes ago</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™æ˜¯å› ä¸º Kubelet ä¼šä» Yurthub è¯»å–ç¼“å­˜çš„æ•°æ®ï¼Œæ¢å¤é‡å¯å‰çš„PodçŠ¶æ€ã€‚è¿™éƒ¨åˆ†æŠ€æœ¯ç»†èŠ‚æˆ‘ä»¬ä¼šåœ¨åç»­çš„æ–‡ç« é‡Œè¯¦ç»†ä»‹ç»ã€‚</p><p>###3ï¼‰å°†OpenYurtè½¬æ¢å›Kubernetes
ç›¸å¯¹çš„ï¼Œé€šè¿‡è¿è¡Œ yurtctl revert å‘½ä»¤ï¼Œç”¨æˆ·å¯ä»¥å°†ä¸€ä¸ª OpenYurt é›†ç¾¤è½¬æ¢å› Kubernetes é›†ç¾¤ã€‚å‡è®¾æˆ‘ä»¬æƒ³å°†ä¸Šè¿°åŒèŠ‚ç‚¹ Kubernetes é›†ç¾¤è½¬æ¢å› Kubernetes æ¨¡å¼ï¼Œé‚£ä¹ˆåªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼ˆè¿è¡Œè¯¥å‘½ä»¤å‰ï¼Œè¯·å…ˆå°† node2 ä¸Šçš„ yurthub é‡æ–°è¿ä¸Š apiserverï¼‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ yurtctl revert</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:38:55.522376   41016 revert.go:106] label alibabacloud.com/is-edge-worker is removed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:38:55.527998   41016 revert.go:116] yurt controller manager is removed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:38:55.548354   41016 revert.go:130] ServiceAccount node-controller is created</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:39:05.572686   41016 util.go:168] servant job(yurtctl-servant-revert-node2) has succeeded</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">I0603 14:39:05.572718   41016 revert.go:142] yurt-hub is removed, kubelet service is reset</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦‚æœè¿˜æƒ³äº†è§£æ›´å¤š yurtctl çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒ OpenYurt github ä»“åº“ä¸‹çš„yurtctlçš„æ•™ç¨‹ï¼š<a href="https://github.com/alibaba/openyurt/tree/master/docs/tutorial%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/openyurt/tree/master/docs/tutorialã€‚</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="whats-next">what&#x27;s Next<a aria-hidden="true" class="hash-link" href="#whats-next" title="Direct link to heading">â€‹</a></h2><p>Yurtctl ç›®æ ‡æ˜¯æˆä¸ºè¿ç»´äººå‘˜ç®¡ç† OpenYurt é›†ç¾¤çš„æœ‰åŠ›å·¥å…·ã€‚å› æ­¤æˆ‘ä»¬ä¼šæŒç»­æ¼”è¿› Yurtctl ä»¥æ”¯æŒ OpenYurt çš„æ–°åŠŸèƒ½å’Œæ–°å¢çš„è¿ç»´æµç¨‹æˆ–åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œä¸ä¹…ä¹‹å OpenYurt è¿˜å°†å¼€æº Yurttunnelï¼ŒYurtunit ç­‰ç»„ä»¶ï¼ŒYurtctl ä¹Ÿå°†å¯¹è¿™äº›ç»„ä»¶æä¾›æ”¯æŒã€‚æˆ‘ä»¬åŒæ—¶æ¬¢è¿å¤§å®¶æå‡ºå¯¹ Yurtctl çš„éœ€æ±‚ï¼Œä¸€èµ·åŠªåŠ›ä½¿å…¶æ›´åŠ å®Œå–„ã€‚</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="ç¤¾åŒºå»ºè®¾">ç¤¾åŒºå»ºè®¾<a aria-hidden="true" class="hash-link" href="#ç¤¾åŒºå»ºè®¾" title="Direct link to heading">â€‹</a></h2><p>OpenYurt ç¤¾åŒºæ¬¢è¿æ–°ç”¨æˆ·åŠ å…¥å’Œå‚ä¸å…±å»ºã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ Github issue è·å–æŠ€æœ¯æ”¯æŒã€æŠ¥å‘Š bugã€æå‡ºéœ€æ±‚æ„è§ç­‰ï¼Œæˆ–è€…é€šè¿‡ OpenYurt ç”¨æˆ·é’‰é’‰ç¾¤ç›´æ¥å’Œ core å¼€å‘äººå‘˜å–å¾—è”ç³»ã€‚
<a href="https://mp.weixin.qq.com/s/tQIIfwClRRmEYO9dE3znhw" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/yurtctl">yurtctl</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/blog/Introduce-of-OpenYurt">OpenYurt:edge computing cloud native project</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-05-29T00:00:00.000Z" itemprop="datePublished">May 29, 2020</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/Fei-Guo" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/Fei-Guo.png" alt="Fei Guo"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Fei-Guo" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Fei Guo</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/huangyuqi" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/huangyuqi.png" alt="frank-huangyuqi"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/huangyuqi" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">frank-huangyuqi</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">rambohe</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenYurt</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img alt="image" src="/assets/images/OpenYurt-de0f93f0c16ddb05b6782cbe66107b22.png"></p><p>å¯¼è¯»ï¼šåŒ—äº¬æ—¶é—´ 5 æœˆ 29 æ—¥ï¼Œåœ¨é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ ACK@Edgeï¼ˆè¾¹ç¼˜é›†ç¾¤æ‰˜ç®¡æœåŠ¡ï¼‰ ä¸Šçº¿ä¸€å‘¨å¹´ä¹‹é™…ï¼Œé˜¿é‡Œå·´å·´æ­£å¼å®£å¸ƒå°†å…¶æ ¸å¿ƒèƒ½åŠ›å¼€æºï¼Œå¹¶å‘ç¤¾åŒºè´¡çŒ®å®Œæ•´çš„è¾¹ç¼˜è®¡ç®—äº‘åŸç”Ÿé¡¹ç›® -- OpenYurtã€‚</p><p>è¾¹ç¼˜äº‘è®¡ç®—æ˜¯åŸºäºäº‘è®¡ç®—æŠ€æœ¯çš„æ ¸å¿ƒå’Œè¾¹ç¼˜è®¡ç®—çš„èƒ½åŠ›ï¼Œæ„ç­‘åœ¨è¾¹ç¼˜åŸºç¡€è®¾æ–½ä¹‹ä¸Šçš„æ–°å‹è®¡ç®—å¹³å°ï¼Œå¹¶æ­£åœ¨æˆä¸ºè¡Œä¸šçš„æ–°ç„¦ç‚¹ã€‚OpenYurt ä½œä¸ºé˜¿é‡Œå·´å·´é¦–ä¸ªè¾¹ç¼˜è®¡ç®—äº‘åŸç”Ÿå¼€æºé¡¹ç›®ï¼Œæ±‡èšäº†é˜¿é‡Œå·´å·´ä¼—å¤šè¾¹ç¼˜è®¡ç®—ä¸šåŠ¡å›¢é˜Ÿçš„æ·±åšæŠ€æœ¯ç§¯ç´¯ï¼Œæ·±åº¦æŒ–æ˜äº†è¾¹ç¼˜è®¡ç®— + äº‘åŸç”Ÿè½åœ°å®æ–½è¯‰æ±‚ã€‚</p><p>ä¸¤å¹´å‰ï¼ŒOpenYurt ä½œä¸ºå…¬å…±äº‘æœåŠ¡ ACK@Edge çš„æ ¸å¿ƒæ¡†æ¶ï¼Œå°±å·²ç»åº”ç”¨äº CDNã€éŸ³è§†é¢‘ç›´æ’­ã€ç‰©è”ç½‘ã€ç‰©æµã€å·¥ä¸šå¤§è„‘ã€åŸå¸‚å¤§è„‘ç­‰å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œå¹¶æœåŠ¡äºé˜¿é‡Œäº‘ LinkEdgeã€ç›’é©¬ã€ä¼˜é…·ã€è§†é¢‘äº‘ï¼ˆè§†é¢‘ç‚¹æ’­ã€è§†é¢‘ç›´æ’­ã€å®æ—¶é€šä¿¡ã€è§†é¢‘ç›‘æ§ã€æ™ºèƒ½è§†è§‰ï¼‰ç­‰å¤šä¸ªä¸šåŠ¡æˆ–é¡¹ç›®ä¸­ã€‚</p><p>é˜¿é‡Œå·´å·´äº‘åŸç”Ÿå¼€æºè´Ÿè´£äººã€äº‘åŸç”Ÿåº”ç”¨å¹³å°èµ„æ·±æŠ€æœ¯ä¸“å®¶æå“è¡¨ç¤ºï¼šâ€œéšç€è¾¹ç¼˜è®¡ç®—çš„åœºæ™¯å’Œéœ€æ±‚ä¸æ–­å¢åŠ ï¼Œâ€˜äº‘è¾¹ååŒâ€™ã€â€˜è¾¹ç¼˜äº‘åŸç”Ÿâ€™æ­£åœ¨é€æ¸æˆä¸ºæ–°çš„æŠ€æœ¯ç„¦ç‚¹ã€‚OpenYurt å¼€æºé¡¹ç›®å®è·µâ€˜äº‘è¾¹ä¸€ä½“åŒ–â€™æ¦‚å¿µï¼Œä¾æ‰˜åŸç”Ÿ Kubernetes å¼ºå¤§çš„å®¹å™¨ç¼–æ’ã€è°ƒåº¦èƒ½åŠ›ï¼Œå®ç°å®Œå…¨è¾¹ç¼˜è®¡ç®—äº‘åŸç”ŸåŸºç¡€è®¾æ–½æ¶æ„ï¼Œå¸®åŠ©å¼€å‘è€…è½»æ¾å®Œæˆåœ¨æµ·é‡è¾¹ã€ç«¯èµ„æºä¸Šçš„å¤§è§„æ¨¡åº”ç”¨çš„äº¤ä»˜ã€è¿ç»´ã€ç®¡æ§ã€‚æˆ‘ä»¬å¸Œæœ› OpenYurt å¼€æºèƒ½æ¨åŠ¨ç¤¾åŒºåœ¨äº‘åŸç”Ÿå’Œè¾¹ç¼˜è®¡ç®—äº¤å‰é¢†åŸŸçš„ååŒå‘å±•ã€‚â€</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="ä»€ä¹ˆæ˜¯openyurt">ä»€ä¹ˆæ˜¯OpenYurt<a aria-hidden="true" class="hash-link" href="#ä»€ä¹ˆæ˜¯openyurt" title="Direct link to heading">â€‹</a></h2><p><img alt="image" src="/assets/images/OpenYurt-01-b706847ee60a69ed405be1564734ed6e.png"></p><p>ä½¿ç”¨ OpenYurtï¼ˆYurtï¼Œ/jÉœËrt/ï¼Œè’™å¤åŒ…ï¼‰ä½œä¸ºæœ¬æ¬¡å¼€æºé¡¹ç›®åç§°ï¼ŒæœŸæœ›ä»¥å…¶â€œå½¢â€æ¥è¡¨ç¤ºè¾¹ç¼˜è®¡ç®—ä¾§é‡äºåˆ›å»ºä¸€ä¸ªé›†ä¸­ç®¡ç†ä½†ç‰©ç†åˆ†å¸ƒçš„åŸºç¡€è®¾æ–½ï¼Œå¹¶æ”¯æŒè‡ªåŠ¨/è‡ªæ²»è¿è¡Œæ“ä½œçš„å«ä¹‰ã€‚</p><p>OpenYurt ä¸»æ‰“â€œäº‘è¾¹ä¸€ä½“åŒ–â€æ¦‚å¿µï¼Œä¾æ‰˜åŸç”Ÿ Kubernetes å¼ºå¤§çš„å®¹å™¨ç¼–æ’ã€è°ƒåº¦èƒ½åŠ›ï¼Œé€šè¿‡ä¼—å¤šè¾¹ç¼˜è®¡ç®—åº”ç”¨åœºæ™¯é”¤ç‚¼ï¼Œå®ç°äº†ä¸€æ•´å¥—å¯¹åŸç”Ÿ Kubernetesâ€œé›¶â€ä¾µå…¥çš„è¾¹ç¼˜äº‘åŸç”Ÿæ–¹æ¡ˆï¼Œæä¾›è¯¸å¦‚è¾¹ç¼˜è‡ªæ²»ã€é«˜æ•ˆè¿ç»´é€šé“ã€è¾¹ç¼˜å•å…ƒåŒ–ç®¡ç†ã€è¾¹ç¼˜æµé‡æ‹“æ‰‘ç®¡ç†ï¼Œå®‰å…¨å®¹å™¨ã€è¾¹ç¼˜ Serverless/FaaSã€å¼‚æ„èµ„æºæ”¯æŒç­‰èƒ½åŠ›ã€‚OpenYurt èƒ½å¸®ç”¨æˆ·è§£å†³åœ¨æµ·é‡è¾¹ã€ç«¯èµ„æºä¸Šå®Œæˆå¤§è§„æ¨¡åº”ç”¨äº¤ä»˜ã€è¿ç»´ã€ç®¡æ§çš„é—®é¢˜ï¼Œå¹¶æä¾›ä¸­å¿ƒæœåŠ¡ä¸‹æ²‰é€šé“ï¼Œå®ç°å’Œè¾¹ç¼˜è®¡ç®—åº”ç”¨çš„æ— ç¼å¯¹æ¥ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1openyurtè¯ç”ŸèƒŒæ™¯">1ï¼‰OpenYurtè¯ç”ŸèƒŒæ™¯<a aria-hidden="true" class="hash-link" href="#1openyurtè¯ç”ŸèƒŒæ™¯" title="Direct link to heading">â€‹</a></h3><p><img alt="image" src="/assets/images/OpenYurt-02-f917b1d6fc1c832f325baa2a27be7ed3.png">
ä» 2017 å¹´åº•å¼€å§‹ï¼Œé˜¿é‡Œäº‘ç‰©è”ç½‘ï¼ˆIoTï¼‰å’Œ CDN (å†…å®¹åˆ†å‘ç½‘ç»œ)æœåŠ¡ä½œä¸ºå…¸å‹çš„è¾¹ç¼˜è®¡ç®—ä¸šåŠ¡æ­£é¢ä¸´ç€äº§å“è§„æ¨¡çš„çˆ†å‘å¼å¢é•¿ã€è¿ç»´å¤æ‚åº¦æ€¥å‰§æ”€å‡ã€è¿ç»´æ•ˆç‡ä¸é«˜çš„â€œä¸‰éš¾â€å¢ƒåœ°ï¼Œå› æ­¤å¼•å…¥äº‘åŸç”Ÿç†å¿µã€å…¨é¢è½¬å‹è¾¹ç¼˜åº”ç”¨çš„è¿ç»´ç®¡ç†æ¨¡å¼æˆä¸ºäºŸéœ€è§£å†³çš„é—®é¢˜ã€‚</p><p>æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼ŒOpenYurt è¯ç”Ÿäºé˜¿é‡Œäº‘å®¹å™¨æœåŠ¡å›¢é˜Ÿï¼Œå¹¶åœ¨æ¥ä¸‹æ¥çš„ä¸¤å¹´å¤šæ—¶é—´å†…ï¼Œä½œä¸ºå…¬å…±äº‘æœåŠ¡ ACK@Edge çš„æ ¸å¿ƒæ¡†æ¶è¢«å¹¿æ³›åº”ç”¨äº CDNã€éŸ³è§†é¢‘ç›´æ’­ã€ç‰©è”ç½‘ã€ç‰©æµã€å·¥ä¸šå¤§è„‘ã€åŸå¸‚å¤§è„‘ç­‰å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œå¹¶æ­£åœ¨æœåŠ¡äºé˜¿é‡Œäº‘ LinkEdgeã€ç›’é©¬ã€ä¼˜é…·ã€è§†é¢‘äº‘ï¼ˆè§†é¢‘ç‚¹æ’­ï¼Œè§†é¢‘ç›´æ’­ï¼Œå®æ—¶é€šä¿¡ï¼Œè§†é¢‘ç›‘æ§ï¼Œæ™ºèƒ½è§†è§‰ï¼‰ç­‰å¤šä¸ªä¸šåŠ¡æˆ–é¡¹ç›®ä¸­ã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2openyurtæŠ€æœ¯ç‰¹ç‚¹">2ï¼‰OpenYurtæŠ€æœ¯ç‰¹ç‚¹<a aria-hidden="true" class="hash-link" href="#2openyurtæŠ€æœ¯ç‰¹ç‚¹" title="Direct link to heading">â€‹</a></h3><p>OpenYurtæ²¿ç”¨äº†ç›®å‰ä¸šç•Œæµè¡Œçš„â€œä¸­å¿ƒç®¡æ§ã€è¾¹ç¼˜è‡ªæ²»â€çš„è¾¹ç¼˜åº”ç”¨ç®¡ç†æ¶æ„ï¼Œå°†â€œäº‘è¾¹ç«¯ä¸€ä½“åŒ–ååŒâ€ä½œä¸ºç›®æ ‡ï¼Œèµ‹èƒ½äº‘åŸç”Ÿèƒ½åŠ›å‘è¾¹ç¼˜ç«¯æ‹“å±•ã€‚åœ¨æŠ€æœ¯å®ç°ä¸Šï¼ŒOpenYurtè´¯å½»äº†â€œExtending your native Kubernetes to Edgeâ€çš„æ ¸å¿ƒè®¾è®¡ç†å¿µï¼Œå…¶æŠ€æœ¯æ–¹æ¡ˆæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å¯¹åŸç”ŸKubernetesâ€œé›¶â€ä¾µå…¥ï¼Œä¿è¯å¯¹åŸç”Ÿk8s APIçš„å®Œå…¨å…¼å®¹ã€‚</li></ul><p>OpenYurté€šè¿‡proxy node network trafficï¼Œå¯¹ Kubernetes èŠ‚ç‚¹åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†åŠ äº†ä¸€å±‚æ–°çš„å°è£…ï¼Œæä¾›è¾¹ç¼˜è®¡ç®—æ‰€éœ€è¦çš„æ ¸å¿ƒç®¡æ§èƒ½åŠ›ï¼›</p><ul><li><p>æ— ç¼è½¬æ¢ï¼ŒOpenYurtæä¾›äº†å·¥å…·å°†åŸç”ŸKubernetesâ€œä¸€é”®å¼â€è½¬æ¢æˆæ”¯æŒè¾¹ç¼˜è®¡ç®—èƒ½åŠ›çš„ Kubernetes é›†ç¾¤ï¼›</p></li><li><p>ä½Overheadï¼ŒOpenYurtå‚è€ƒäº†å¤§é‡è¾¹ç¼˜è®¡ç®—åœºæ™¯çš„å®é™…éœ€æ±‚ï¼Œåœ¨ä¿è¯åŠŸèƒ½å’Œå¯é æ€§çš„åŸºç¡€ä¸Šï¼Œæœ¬ç€æœ€å°åŒ–ï¼Œæœ€ç®€åŒ–çš„è®¾è®¡ç†å¿µï¼Œä¸¥æ ¼é™åˆ¶æ–°å¢ç»„ä»¶çš„èµ„æºè¯‰æ±‚ã€‚  </p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3openyurtæ ¸å¿ƒèƒ½åŠ›">3ï¼‰OpenYurtæ ¸å¿ƒèƒ½åŠ›<a aria-hidden="true" class="hash-link" href="#3openyurtæ ¸å¿ƒèƒ½åŠ›" title="Direct link to heading">â€‹</a></h3><p><img alt="image" src="/assets/images/OpenYurt_arch-a3dcd2a758bb9c978f52c8a61c6a98f6.png"></p><ul><li>è¾¹ç¼˜è‡ªæ²»èƒ½åŠ›ï¼š </li></ul><p>YurtHubä½œä¸ºèŠ‚ç‚¹ä¸Šçš„ä¸´æ—¶é…ç½®ä¸­å¿ƒï¼Œåœ¨ç½‘ç»œè¿æ¥ä¸­æ–­çš„æƒ…å†µä¸‹ï¼ŒæŒç»­ä¸ºèŠ‚ç‚¹ä¸Šæ‰€æœ‰è®¾å¤‡å’Œå®¢æˆ·ä¸šåŠ¡æä¾›æ•°æ®é…ç½®æœåŠ¡ã€‚YurtHub æä¾›äº†å¯¹å¤§é‡åŸç”Ÿ Kubernetes APIçš„æ”¯æŒï¼Œå¯ä»¥åœ¨èŠ‚ç‚¹å’Œè¾¹ç¼˜å•å…ƒç»´åº¦æä¾›â€œShadowApiserverâ€çš„èƒ½åŠ›ï¼Œåœ¨è¾¹ç¼˜è®¡ç®—å¼±ç½‘ç»œé“¾æ¥åœºæ™¯çš„ä»·å€¼å°¤ä¸ºçªå‡ºï¼›</p><ul><li>è¾¹ç¼˜è¿ç»´é€šé“</li></ul><p>åœ¨è¾¹ç¼˜åœºæ™¯ï¼Œç”±äºå¤§å¤šæ•°è¾¹ç¼˜èŠ‚ç‚¹æ²¡æœ‰æš´éœ²åœ¨å…¬ç½‘ä¹‹ä¸Šï¼Œä¸­å¿ƒç®¡æ§æ— ç¼å’Œè¾¹ç¼˜èŠ‚ç‚¹ä¸»åŠ¨å»ºç«‹ç½‘ç»œé“¾æ¥ï¼Œæ‰€æœ‰çš„KubernetesåŸç”Ÿåº”ç”¨è¿ç»´APIsï¼ˆlogs/exec/metricsï¼‰ä¼šå¤±å»æ•ˆåŠ›ï¼›
YurtTunnel é€šè¿‡åœ¨ç®¡æ§ä¸è¾¹ç¼˜èŠ‚ç‚¹ä¹‹é—´å»ºç«‹åå‘é€šé“ï¼Œå¹¶å’ŒèŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå®Œæ•´è”åŠ¨ï¼Œæ‰¿è½½åŸç”Ÿè¿ç»´ APIs çš„æµé‡ï¼›</p><ul><li>é›†ç¾¤è½¬æ¢èƒ½åŠ›
Yurtctlä½œä¸ºOpenYurtå®˜æ–¹å‘½ä»¤è¡Œå·¥å…·ï¼Œæä¾›åŸç”ŸKubernetesé›†ç¾¤æ”¯æŒè¾¹ç¼˜è®¡ç®—infrastructureçš„ä¸€é”®å¼åˆ‡æ¢ã€‚</li></ul><p>å…¶ä»–æ›´é«˜çº§çš„åŠŸèƒ½æ¯”å¦‚è¾¹ç¼˜æµé‡ç®¡ç†ã€å•å…ƒåŒ–ç®¡ç†ï¼Œéƒ¨ç½²ã€åŒºåŸŸè‡ªæ²»ç­‰å°†ä¼šé€æ­¥å¼€æºã€‚</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4openyurt-roadmap">4ï¼‰OpenYurt Roadmap<a aria-hidden="true" class="hash-link" href="#4openyurt-roadmap" title="Direct link to heading">â€‹</a></h3><p>ä½œä¸ºé˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ ACK@Edge çš„å¼€æºç‰ˆæœ¬ï¼ŒOpenYurt å°†é‡‡ç”¨å…¨å¼€æºç¤¾åŒºå¼€å‘æ¨¡å¼ï¼Œæ¯å­£åº¦å‘å¸ƒæ–°ç‰ˆæœ¬æ›´æ–°ï¼ŒåŒ…å«ç¤¾åŒºä¸Šæ¸¸å®‰å…¨/å…³é”® bug ä¿®å¤å’Œæ–°ç‰¹æ€§ã€æ–°èƒ½åŠ›ï¼Œå¹¶é€æ­¥å°†äº§å“å®Œæ•´èƒ½åŠ›å¼€æºã€‚</p><p>ä¸»å¯¼è¿™æ¬¡å¼€æºçš„é˜¿é‡Œå·´å·´äº‘åŸç”Ÿåº”ç”¨å¹³å°å›¢é˜Ÿï¼Œç›®å‰å·²ç»å¼€æº OAMã€OpenKruiseã€Dragonflyã€Apache RocketMQã€Apache Dubbo ç­‰ä¼—å¤šæ˜æ˜Ÿé¡¹ç›®ï¼Œæ˜¯å›½å†…æœ€èµ„æ·±çš„äº‘åŸç”Ÿå¼€æºè´¡çŒ®å›¢é˜Ÿã€‚OpenYurt é¡¹ç›®çš„å¼€æºï¼Œæœ¬ç€â€œExtending your native Kubernetes to Edgeâ€çš„è®¾è®¡ç†å¿µï¼Œè®©äº‘åŸç”ŸæŠ€æœ¯åœ¨è¾¹ç¼˜è®¡ç®—é¢†åŸŸçš„ç”Ÿæ€å»ºè®¾ä¸æ™®åŠå‰è¿›äº†ä¸€å¤§æ­¥ï¼Œä¹Ÿä¸ºå…¨çƒå¼€å‘è€…æ‹“å±•äº‘åŸç”Ÿè¾¹ç•Œè´¡çŒ®äº†ä¸€ä»½åŠ›é‡ã€‚</p><p><a href="https://mp.weixin.qq.com/s/0LwCE4CpVdttmvx4FAMArg" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation/yurtcluster">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/">DingTalk (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright Â© 2021 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
<script src="/assets/js/runtime~main.043f6912.js"></script>
<script src="/assets/js/main.6045179a.js"></script>
</body>
</html>