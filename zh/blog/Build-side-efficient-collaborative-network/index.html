<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">如何构建Kubernetes原生云边高效协同网络 | OpenYurt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="如何构建Kubernetes原生云边高效协同网络 | OpenYurt"><meta data-rh="true" name="description" content="导读：OpenYurt是阿里巴巴开源的云边协同一体化架构，与同类开源方案相比，OpenYurt拥有可实现边缘计算全场景覆盖的能力。"><meta data-rh="true" property="og:description" content="导读：OpenYurt是阿里巴巴开源的云边协同一体化架构，与同类开源方案相比，OpenYurt拥有可实现边缘计算全场景覆盖的能力。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-11-06T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/charleszheng44"><meta data-rh="true" property="article:tag" content="yurttunnel"><link data-rh="true" rel="icon" href="/zh/img/openyurt.ico"><link data-rh="true" rel="canonical" href="https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network"><link data-rh="true" rel="alternate" href="https://openyurt.io/blog/Build-side-efficient-collaborative-network" hreflang="en"><link data-rh="true" rel="alternate" href="https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network" hreflang="zh"><link data-rh="true" rel="alternate" href="https://openyurt.io/blog/Build-side-efficient-collaborative-network" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://&lt;NEW_APP_ID&gt;-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network","mainEntityOfPage":"https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network","url":"https://openyurt.io/zh/blog/Build-side-efficient-collaborative-network","headline":"如何构建Kubernetes原生云边高效协同网络","name":"如何构建Kubernetes原生云边高效协同网络","description":"导读：OpenYurt是阿里巴巴开源的云边协同一体化架构，与同类开源方案相比，OpenYurt拥有可实现边缘计算全场景覆盖的能力。","datePublished":"2020-11-06T00:00:00.000Z","author":{"@type":"Person","name":"Chao Zheng","description":"Maintainer of OpenYurt","url":"https://github.com/charleszheng44","image":"https://github.com/charleszheng44.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://openyurt.io/zh/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="OpenYurt Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/zh/opensearch.xml">


<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
<link rel="icon" type="image/png" href="/favicons/favicon.png">
<link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" color="#ffffff" href="/favicons/safari-pinned-tab.svg">
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-config" content="/favicons/browserconfig.xml"><link rel="stylesheet" href="/zh/assets/css/styles.6d236628.css">
<script src="/zh/assets/js/runtime~main.848716f3.js" defer="defer"></script>
<script src="/zh/assets/js/main.3a7ce15b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OpenYurt</b></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh/docs/">v1.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">v1.4</a></li><li><a class="dropdown__link" href="/zh/docs/v1.3/">v1.3</a></li><li><a class="dropdown__link" href="/zh/docs/v1.2/">v1.2</a></li><li><a class="dropdown__link" href="/zh/docs/v1.1/">v1.1</a></li><li><a class="dropdown__link" href="/zh/docs/v1.0/">v1.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.7.0/">v0.7.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.6.0/">v0.6.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.5.0/">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/Build-side-efficient-collaborative-network" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/blog/Build-side-efficient-collaborative-network" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Enable-MetalLB-in-OpenYurt">Edge LoadBalancer service support based on MetalLB</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-to-use-yurtctl-convert-revert">Kubernetes与OpenYurt无缝转换（命令式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-to-use-service-topology">OpenYurt边缘流量闭环能力解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-run-business-pod-in-edge-scenarios">OpenYurt：在边缘场景无缝运行使用InClusterConfig的业务Pod</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Edge-gateway-caching-capabilities">边缘网关缓存能力的优雅实现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Play-with-OpenYurt-on-Raspberry-Pi">在树莓派上玩转 OpenYurt</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh/blog/Build-side-efficient-collaborative-network">如何构建Kubernetes原生云边高效协同网络</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Expansion-capability-of-Yurthub">从边缘自治看YurtHub的扩展能力</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/YurtHub-design-detail">深度解读OpenYurt：边缘自治能力设计解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Use-of-yurtctl">OpenYurt｜一键让原生k8s集群具备边缘计算能力</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Introduce-of-OpenYurt">边缘计算云原生项目 OpenYurt</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">如何构建Kubernetes原生云边高效协同网络</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-11-06T00:00:00.000Z">2020年11月6日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/charleszheng44.png" alt="Chao Zheng"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/charleszheng44" target="_blank" rel="noopener noreferrer"><span>Chao Zheng</span></a></div><small class="avatar__subtitle">Maintainer of OpenYurt</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>导读：OpenYurt是阿里巴巴开源的云边协同一体化架构，与同类开源方案相比，OpenYurt拥有可实现边缘计算全场景覆盖的能力。</p>
<ul>
<li>OpenYurt是如何在弱网和断网环境下实现边缘自治的——<a href="/zh/blog/Edge-gateway-caching-capabilities">YurtHub</a></li>
<li>OpenYurt另一个核心能力——云边通信，以及相关组件Yurttunnel</li>
</ul>
<h2 id="yurttunnel使用场景">Yurttunnel使用场景</h2>
<p>在应用的部署和运维过程中，用户常常需要获取应用的日志，或直接登录到应用的运行环境中进行调试。在 Kubernetes 环境中，我们通常使用 kubectl log，kubectl exec 等指令来实现这些需求。如下图所示，在 kubectl 请求链路上， kubelet 将扮演服务器端，负责处理由 kube-apiserver(KAS) 转发来的请求，这就要求 KAS 和 kubelet 之间需要存在一条网络通路，允许 KAS 主动访问 kubelet。
<img alt="image" src="/zh/assets/images/kubectl-a986c3e8d3b680dd93899fce88a92821.png" width="530" height="181">
然而，在边缘计算场景中，边缘节点常位于本地专有网络中，这虽然保证了边缘节点的安全，但也造成位于云端管控节点的KAS无法直接访问位于边缘节点的kubelet。因此，为了支持通过云端节点对边缘端应用进行运维操作，我们必须在云、边之间建立反向运维通道。</p>
<h2 id="反向通道">反向通道</h2>
<p>Yurttunnel是OpenYurt近期开源的一个重要组件，用来解决云边通信问题。反向通道是解决跨网络通信的一种常见方式，而 Yurttunnel 的本质就是一个反向通道。一个边缘集群下属的节点常位于不同的 network region 中， 而位于同一个 region 内的节点之间是可以相互通信的，因此在设置反向通道时，我们只需保证在每个 region 内设置一个与 proxy server 相连的 agent 即可。具体包括以下几个步骤：</p>
<ul>
<li>
<p>在管控组件所在网络内，部署 proxy server。</p>
</li>
<li>
<p>proxy server 对外开放一个公网可以访问的 IP。</p>
</li>
<li>
<p>在每个 region 部署个 agent，并通过 server 的公网 IP 与 server 建立长连接。</p>
</li>
<li>
<p>管控组件对边缘节点的访问请求都将转发致 proxy server。</p>
</li>
<li>
<p>proxy server 再将请求通过对应的长连接发往目标节点。</p>
</li>
</ul>
<p><img alt="image" src="/zh/assets/images/proxy_server_agent-58a080cbcdc31c0c7b82a500d94f9849.png" width="663" height="456">
在 Yurttunnel 中，我们选择使用上游<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">项目apiserver-network-proxy(ANP)</a> 来实现server 和 agent 间的通信。ANP 是基于 kubernetes 1.16 Alpha 新功能<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/egressselector/egress_selector.go">EgressSelector</a> 开发，意在实现 Kubernetes 集群组件的跨 intranet 通信（例如，master 位于管控 VPC，而 kubelet 等其他组件位于用户 VPC）。</p>
<p>读者可能会好奇，既然 OpenYurt 是基于 ACK@Edge 开源的，而在生产环境中， ACK@Edge 的云边运维通道使用的是自研组件 tunnellib，那为什么在开源版本里我们要选用一个新的组件呢？这里不得不再次提到 OpenYurt 的核心设计理念 “Extend upstream Kubernetes to Edge”。</p>
<p>诚然，tunnellib 经过了复杂线上环境的考验，组件性能稳定，但我们更希望能与上游保持最大的技术公约数，让 OpenYurt 的用户体验更接近原生 Kubernetes ；同时，在 ACK@Edge 的开发和运维过程中，我们发现，边缘集群的许多需求也同样存在于其他场景中（  例如，大多数云厂商也需要实现节点跨网络通信），并且运维通道的传输效率也能进一步优化（4.5章将详述优化过程）。因此，秉承开放分享、平等普惠的开源精神，我们希望能将开发和运维过程中积累的的宝贵经验在上游社区与更多的开发者分享。</p>
<h2 id="anp并非开箱即用">ANP并非开箱即用</h2>
<p>然而 ANP 项目仍处于起步阶段，功能尚未完善，许多问题仍有待解决。我们从实践中发现的主要问题包括：</p>
<ul>
<li>
<p>如何转发云端节点的请求 -- 反向通道正常工作的一个前提是，管控节点发往边缘节点的请求必须先经过 proxy server。对于 Kubernetes 1.16 + 版本，KAS 能借由 EgressSelector 将发往节点的请求先发往指定的 proxy server。但对于 1.16 以前的版本，KAS 及其他管控组件（Prometheus 和 metrics server）只能直接访问节点，而不能绕道 proxy server。可以预见的是，部分用户在短期内，仍将使用 1.16 以前的版本，并且 Prometheus 和 metrics server 等管控组件在短期内也没有支持 EgressSelector 的计划。因此，我们要解决的第一个问题是，如何将管控组件发往节点的请求转发致 proxy server。</p>
</li>
<li>
<p>如何确保 server 副本覆盖所有的 region -- 在生产环境中，一个边缘集群常常包含上万个节点，并同时服务上百名用户，如果一个集群只有一个 proxy server， 那么，一旦 proxy server 出现故障，所有用户都将无法对位于边缘节点上的 pod 进行操作。因此，我们必须同时部署多个 proxy server 副本以保证集群高可用。同时，proxy server 的工作负荷将随着访问流量的增大而增大，用户的访问延时也势必增加。因此在部署 proxy server 时，我们还需考虑如何对 proxy server 进行水平拓展，以应对高并发场景。一个应对单点故障和高并发场景的经典解决方案是，部署多个 proxy server 副本，并使用负载均衡进行流量分发。然而在 OpenYurt 场景下，对于 KAS 发来的任意请求，LoadBalancer (LB) 会转发给哪个 server 副本是不可控的，因此，需要解决的第二个问题是，如何保证每个 server 副本都能与所有的 agent 建立连接。</p>
</li>
<li>
<p>如何将请求转发给正确的 agent -- 在运行过程中，proxy server 在收到请求后，需根据请求的 destination IP，将请求转发至位于对应 network region 内的 agent。然而，ANP目前的实现，假设所有的节点都位于一个网络空间内， server 会随机挑选一个 agent 转发请求。因此，我们需要解决的第三个问题是，如何将请求正确地转发给指定的 agent。</p>
</li>
<li>
<p>如何解除组件对节点证书的依赖 -- 在运行时，我们需要为 server 提供一套 TLS 证书，以实现 server 与 KAS，server 与 agent 间的安全通信。同时，我们也需要为 agent 准备一套 TLS client 证书，用以建立 agent 和 server 间的 gRPC 信道。ANP 目前的实现，要求 server 必须和 KAS 部署在同一个节点上，并且在启动时挂载节点 volume 共享 KAS tls 证书。同样，agent 也需要在启动时挂载 volume 共享 kubelet tls 证书。这无形中降低了部署的灵活性，造成了组件对节点证书的强依赖，在有些情况下，用户可能希望将 server 部署在非 KAS 所在节点上。因此，另一个需要关注的问题是，如何解除组件对节点证书的依赖。</p>
</li>
<li>
<p>如何缩小 Tunnel 带宽 -- ANP 的一个核心设计思想，是使用 gRPC 封装 KAS 所有对外 HTTP 请求。这里选择 gRPC，主要是看重其对流（stream）的支持和清晰的接口规范，此外，强类型的客户端和服务器端可以有效减少运行时错误，提高系统稳定性。然而，我们也发现，相较于直接使用 TCP 协议，采用 ANP 也会带来额外的开销增加带宽。从产品层面考虑，Tunnel 流量走的是公网，带 宽的增加也意味着用户成本的增加。因此，一个非常重要的问题是，在提高系统稳定性的同时，我们是否也能缩小带宽？</p>
</li>
</ul>
<h2 id="yurttunnel设计解析">Yurttunnel设计解析</h2>
<h3 id="1制定dnat规则转发云端节点的请求">1.制定DNAT规则转发云端节点的请求</h3>
<p>如前文所述，ANP 是基于上游新功能 EgressSelector 开发的，该功能允许用户在启动 KAS 时通过传入 egress configuration 来要求 KAS 将 egress 请求转发到指定的 proxy server。但由于我们需要兼顾新老版本的 Kubernetes 集群，并且考虑到，其他管控组件（Prometheus 和 metric server）并不支持 EgressSelector 特性，我们需要保证在无法使用 EgressSelector 的情况下也能将 KAS egress 请求转发致 proxy server。为此，我们在每一个云端管控节点上都部署一个 Yurttunnel Server 副本，并在 Server 中内嵌一个新组件 Iptabel Manager。Iptable Manager 会通过在宿主机的 Iptable 中的 OUTPUT 链中添加 DNAT 规则，将管控组件对节点的请求转发致 Yurttunnel Server。</p>
<p>同时，当启用 EgressSelector 后，KAS 对外请求都遵循一个统一的格式，因此我们新增一个组件， ANP interceptor。ANP interceptor 会负责截取从 master 发来的 http 请求，并将其封装成 EgressSelector 格式。Yurttunnel 请求转发的具体流程见图三。
<img alt="image" src="/zh/assets/images/yurttunnel-37d6b1940619816205bf637ecda07532.png" width="410" height="571"></p>
<h3 id="2动态获取server副本数">2.动态获取Server副本数</h3>
<p>在上一节中，我们提到，我们将采用负载均衡的方式来管理yurttunnel server，所有的ingress请求都会通过LB分发给一个server副本。由于我们无法预测LB会挑选哪个server副本，我们必须保证每个 server 副本都要与所有的 agent 建立连接。这里，我们将使用 ANP 自带的功能实现这一需求，具体流程如下：</p>
<ul>
<li>
<p>  在启动 yurttunnel server 时，我们会将副本数（serverCount）传入每个 server 副本中，并且为每个副本指定一个 server ID；</p>
</li>
<li>
<p>agent 连接 LB 后，LB会随机选择一个 server 副本并让其与 agent 建立长连接；</p>
</li>
<li>
<p>与此同时，server 会通过该通道向 agent 返回一个 ACK package，这个 package 中将包含 serverCount 和 serverID；</p>
</li>
<li>
<p>agent 通过解析 ACK package，可以获悉 server 副本的个数，并在本地记录已连接的 serverID；</p>
</li>
<li>
<p>如果 agent 发现，本地连接的 server 副本数小于 serverCount，则会再次向 LB 发送连接请求，直至本地记录的 serverID 数与 server Count 数一致为止。</p>
</li>
</ul>
<p>该机制虽然帮助我们实现了server副本的全网段覆盖。但同时，也存在不可忽视的缺点，由于 agent 无法选择与哪个 server 副本建立连接，因此，为了连接所有的 server 副本，agent 必须反复访问 LB。在这个过程中，server 由于还没有与所有的 agent 建立连接，KAS 发来的请求可能无法转发至对应的节点。一个潜在的解决方案是，为每个 server副本创建一个独立的 LB，负责与 agent 之间的连接，同时在agent端记录所有 server副本对应 LB 的信息，这一方案能帮助 agent 快速地与所有的 server 副本建立连接。该方案的具体实现细节，目前仍在与上游社区的开发者讨论中。</p>
<h3 id="3为anp添加代理策略">3.为ANP添加代理策略</h3>
<p>在OpenYurt的网络模型下，边缘节点分布在不同的network region中，随机选择的 agent 可能无法将请求转发至位于其他 region 内的节点上。因此我们不得不修改 ANP server 底层代理转发的逻辑。然而，根据长期的经验，我们相信，proxy server 支持不同的代理策略，例如，将请求转发至指定数据中心，region，或者指定主机，是一个较为通用的需求。经过和 ANP 社区开发  者讨论，我们决定重构 ANP 管理 agent 连接的接口，允许用户根据需求实现新的代理策略，并计划将该 feature 最终合入上游代码库。目前重构工作仍在进行中，在 Yurttunnel 第一个开源版本中，我们暂时采用以下配置：</p>
<ul>
<li>
<p>在每个边缘节点上部署一个 agent。</p>
</li>
<li>
<p>agent 在 server 处登记时，使用 agent 所在节点的 IP 作为 agentID。</p>
</li>
<li>
<p>server 在转发请求时，通过匹配请求目标 IP 和 agentID，将请求转发至对应的 agent。</p>
</li>
</ul>
<p>我们计划在OpenYurt后续发布Yurt Unit（边缘节点分区管控）之后，配合新增的ANP代理转发策略，实现agent的分区部署，和请求的分区转发。</p>
<h3 id="4动态申请安全证书">4.动态申请安全证书</h3>
<p>为了解除yurttunnel组件对节点证书的依赖，我们在yurttunnel中新增cert manager组件，cert manager会在server和agent运行后，向KAS提交certificate signning request(CSR)。server 将使用申请到的证书来确保其与 KAS 和 agent 间的安全通信，agent 会使用申请到的证书确保其与 server 间 gRPC 信道的安全。由于 agent 和 kubelet 间是通过 tcp 协议连接，因此，我们无需为 agent 和 kubelet 间的连接准备证书。</p>
<h3 id="5压缩tunnel带宽节约成本">5.压缩Tunnel带宽，节约成本</h3>
<p>在上文，我们提到，使用gRPC封装Tunnel虽然可以提高传输稳定性，但同时也会增加公网流量。这是否意味着稳定性和性能，我们只能二选一？通过对不同用户场景的分析，我们发现，在大多数情况下，用户使用运维通道是为了获取容器日志（即 kubectl log），而传统日志文件，存在许多相同的文本信息，因此我们推断使用 gzip 等压缩算法能有效缩小带宽。为了验证这一假设，我们在 ANP 底层的 gRPC 库中添加了 gzip compressor，并且对比了与使用原生 TCP 连接场景下的数据传输量。</p>
<p>我们考虑的第一个实验场景是，分别通过 TCP 连接和 ANP 获取同一 kubeproxy 容器的日志，我们截取了这一过程中 Tunnel 上双向 package 和 bytes 总量。</p>
<p><img alt="image" src="data:image/png;base64,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" width="643" height="98"></p>
<p>如上表所示，通过使用 ANP， 总传输数据量下降了 29.93%。</p>
<p>经过长时间运行，容器的日志文本常常可以达到十几兆，为了模拟获取大文本日志的场景。我们创建了一包含 10.5M systemd log（即 journalctl）的 ubuntu 容器，同样我们分别使用原生 TCP 连接和 ANP 传输该日志文件，并测量了 Tunnel 上的数据总量
<img alt="image" src="/zh/assets/images/large_log-134be99fb1d206593ae4701ab02ec08a.png" width="643" height="97"></p>
<p>如上表所示，在日志文本较大的情况下，通过使用 ANP， 总传输数据量下降了 40.85%。</p>
<p>由此可见，相较于原生 TCP 连接，ANP 不仅能提供更高的传输稳定性，还可以大幅降低公网流量。考虑到边缘集群动辄上万的节点规模，新的解决方案将帮助用户在公网流量方面节约大量开销。</p>
<p>##Yurttunnel系统架构
<img alt="image" src="/zh/assets/images/Yurttunnel_arch-a35ea31101910abdd501f7313b7d0a43.png" width="798" height="626"></p>
<p>综上，Yurttunnel 主要包含以下组件：</p>
<ul>
<li>
<p>Yurttunnel Server - 负责将 apiserver，prometheus，metrics server 等管控组件发往节点的请求，转发至对应的 agent。具体包括以下子组件：</p>
<ul>
<li>ANP Proxy Server - 对 ANP gRPC server 的封装，负责管理与 Yurttunnel Agent 之间的长连接，并转发请求。</li>
<li>Iptable Manager - 修改管控节点的 DNAT 规则，以确保管控组件的请求能被转发至 Yurttunnel Server。</li>
<li>Cert Manager - 为 Yurttunnel Server 生成 TLS 证书。</li>
<li>Request Interceptor - 将 KAS 对节点的 HTTP 请求封装到符合 ANP 规则的 gRPC 包里。</li>
</ul>
</li>
<li>
<p>Yurttunnel Agent - 与 Yurttunnel Server 主动建立连接，并将 Yurttunnel Server 发来的请求转发给 Kubelet。具体包括两个子组件：</p>
<ul>
<li>ANP Proxy Agent - 对 ANP gRPC agent 的封装，相较于上游，我们额外加入了 gzip compressor 以压缩数据。</li>
<li>Cert Manager - 为 Yurttunnel Agent 生成 TLS 证书。</li>
</ul>
</li>
<li>
<p>Yurttunnel Server Service - 通常是一个 SLB，负责将管控组件发来的请求分发给合适的 Yurttunnel Server 副本，保证 Yurttunnel 的高可用和负载均衡。</p>
</li>
</ul>
<h2 id="总结和展望">总结和展望</h2>
<p>Yurttunnel 作为 OpenYurt 近期开源的重要组件，打通了 OpenYurt 集群的云边通道，为边缘集群上的容器运维提供了一个统一的入口。通过对上游解决方案进行改造，Yurttunnel 不仅提供了更高的传输稳定性，也大幅降低了数据传输量。</p>
<p><a href="https://mp.weixin.qq.com/s/nRUv4u9JbiIdrUPB_cZOBg">原文链接</a></p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/yurttunnel">yurttunnel</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/openyurtio/openyurt.io/tree/master/blog/blog/2020-11-06-Build-side-efficient-collaborative-network.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑本页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/blog/Play-with-OpenYurt-on-Raspberry-Pi"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">在树莓派上玩转 OpenYurt</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/Expansion-capability-of-Yurthub"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">从边缘自治看YurtHub的扩展能力</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#yurttunnel使用场景" class="table-of-contents__link toc-highlight">Yurttunnel使用场景</a></li><li><a href="#反向通道" class="table-of-contents__link toc-highlight">反向通道</a></li><li><a href="#anp并非开箱即用" class="table-of-contents__link toc-highlight">ANP并非开箱即用</a></li><li><a href="#yurttunnel设计解析" class="table-of-contents__link toc-highlight">Yurttunnel设计解析</a><ul><li><a href="#1制定dnat规则转发云端节点的请求" class="table-of-contents__link toc-highlight">1.制定DNAT规则转发云端节点的请求</a></li><li><a href="#2动态获取server副本数" class="table-of-contents__link toc-highlight">2.动态获取Server副本数</a></li><li><a href="#3为anp添加代理策略" class="table-of-contents__link toc-highlight">3.为ANP添加代理策略</a></li><li><a href="#4动态申请安全证书" class="table-of-contents__link toc-highlight">4.动态申请安全证书</a></li><li><a href="#5压缩tunnel带宽节约成本" class="table-of-contents__link toc-highlight">5.压缩Tunnel带宽，节约成本</a></li></ul></li><li><a href="#总结和展望" class="table-of-contents__link toc-highlight">总结和展望</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/installation/summary">快速开始</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/">钉钉 (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright © 2024 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
</body>
</html>