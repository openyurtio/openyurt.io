<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">One post tagged with &quot;openyurt&quot; | OpenYurt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openyurt.io/zh/blog/tags/openyurt"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" property="og:title" content="One post tagged with &quot;openyurt&quot; | OpenYurt"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/zh/img/openyurt.ico"><link data-rh="true" rel="canonical" href="https://openyurt.io/zh/blog/tags/openyurt"><link data-rh="true" rel="alternate" href="https://openyurt.io/blog/tags/openyurt" hreflang="en"><link data-rh="true" rel="alternate" href="https://openyurt.io/zh/blog/tags/openyurt" hreflang="zh"><link data-rh="true" rel="alternate" href="https://openyurt.io/blog/tags/openyurt" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://&lt;NEW_APP_ID&gt;-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="OpenYurt Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/zh/opensearch.xml">


<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
<link rel="icon" type="image/png" href="/favicons/favicon.png">
<link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" color="#ffffff" href="/favicons/safari-pinned-tab.svg">
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-config" content="/favicons/browserconfig.xml"><link rel="stylesheet" href="/zh/assets/css/styles.dd1c872e.css">
<script src="/zh/assets/js/runtime~main.3659bdd9.js" defer="defer"></script>
<script src="/zh/assets/js/main.f80fd377.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OpenYurt</b></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/team">Team</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh/docs/">v1.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">v1.4</a></li><li><a class="dropdown__link" href="/zh/docs/v1.3/">v1.3</a></li><li><a class="dropdown__link" href="/zh/docs/v1.2/">v1.2</a></li><li><a class="dropdown__link" href="/zh/docs/v1.1/">v1.1</a></li><li><a class="dropdown__link" href="/zh/docs/v1.0/">v1.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.7.0/">v0.7.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.6.0/">v0.6.0</a></li><li><a class="dropdown__link" href="/zh/docs/v0.5.0/">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/tags/openyurt" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/blog/tags/openyurt" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Enable-MetalLB-in-OpenYurt">Edge LoadBalancer service support based on MetalLB</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-to-use-yurtctl-convert-revert">Kubernetes与OpenYurt无缝转换（命令式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-to-use-service-topology">OpenYurt边缘流量闭环能力解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/How-run-business-pod-in-edge-scenarios">OpenYurt：在边缘场景无缝运行使用InClusterConfig的业务Pod</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Edge-gateway-caching-capabilities">边缘网关缓存能力的优雅实现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Play-with-OpenYurt-on-Raspberry-Pi">在树莓派上玩转 OpenYurt</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Build-side-efficient-collaborative-network">如何构建Kubernetes原生云边高效协同网络</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Expansion-capability-of-Yurthub">从边缘自治看YurtHub的扩展能力</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/YurtHub-design-detail">深度解读OpenYurt：边缘自治能力设计解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Use-of-yurtctl">OpenYurt｜一键让原生k8s集群具备边缘计算能力</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/Introduce-of-OpenYurt">边缘计算云原生项目 OpenYurt</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>One post tagged with &quot;openyurt&quot;</h1><a href="/zh/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/Enable-MetalLB-in-OpenYurt">Edge LoadBalancer service support based on MetalLB</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-28T00:00:00.000Z">2022年6月28日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zzguang" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/zzguang.png" alt="zzguang"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/zzguang" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">zzguang</span></a></div><small class="authorTitle_nd0D" title="Reviewer of OpenYurt">Reviewer of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景介绍">背景介绍<a href="#背景介绍" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>在云边协同场景下，虽然云端已经具备了较为全面的云原生能力，但边缘侧由于特定的网络环境及应用场景的限制，往往无法提供像云端一样丰富的能力，而实际上用户业务应用的主战场却在边缘侧，
这就导致边缘侧在使用云原生能力的时候或多或少存在一些gaps，而如何解决这些gaps也成为云边协同基础设施软件力求解决的关键问题。本文针对边缘侧服务暴露给集群外访问的场景，来探讨一下在
OpenYurt边缘侧解决上述问题的方法，希望能起到抛砖引玉的效果。</p>
<p>在原生Kubernetes集群中，如果想将服务暴露出来供集群外部访问，通常可以考虑以下几种方式：</p>
<ul>
<li>HostNetwork</li>
<li>ExternalIPs</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>Ingress</li>
</ul>
<p>其中前三种方式，由于自身存在一定的局限性，在条件允许的情况下，通常用户更倾向于选择后两种方式。而对Ingress方式 而言，云端Ingress功能通常会搭配云端SLB服务一起使用，
SLB负责从用户请求到节点维度的负载均衡，而Ingress负责从节点到pod维度的负载均衡，这样就实现了从用户请求到应用pod的全链路的负载均衡功能。然而在云边协同场景下，由于边缘侧并不具备云端SLB服务的能力，边缘Ingress或边缘应用无法暴露LoadBalancer类型的服务供集群外访问，这也成为了边缘侧对外暴露服务的一大痛点。</p>
<p>为了解决上述痛点，目前在开源社区，有几个方案可供选择：MetalLB, PureLB和OpenELB。</p>
<ul>
<li>MetalLB:  <a href="https://github.com/metallb" target="_blank" rel="noopener noreferrer">https://github.com/metallb</a></li>
<li>PureLB:   <a href="https://github.com/purelb" target="_blank" rel="noopener noreferrer">https://github.com/purelb</a></li>
<li>OpenELB:  <a href="https://github.com/openelb" target="_blank" rel="noopener noreferrer">https://github.com/openelb</a></li>
</ul>
<p>关于三个项目之间的比较，可以从网上查到一些相关介绍，整体来说，它们实现的功能大同小异，从项目成熟度及流行度的角度考虑，我们选择以MetalLB为例，探讨一下如何通过MetalLB在OpenYurt
边缘侧实现对LoadBalancer类型service的支持。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div><div class="col text--right col--3"><a aria-label="阅读 Edge LoadBalancer service support based on MetalLB 的全文" href="/zh/blog/Enable-MetalLB-in-OpenYurt"><b>更多</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/How-to-use-yurtctl-convert-revert">Kubernetes与OpenYurt无缝转换（命令式）</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-12-03T00:00:00.000Z">2021年12月3日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/adamzhoul" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/adamzhoul.png" alt="adamzhoul"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/adamzhoul" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">adamzhoul</span></a></div><small class="authorTitle_nd0D" title="Member of OpenYurt">Member of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>打开openYurt的README.md，在简单介绍之后就是Getting started:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> yurtctl convert --provider [minikube|kubeadm|kind] // To convert an existing Kubernetes cluster to an OpenYurt cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> yurtctl revert // To uninstall and revert back to the original cluster settings</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>简单一行命令就可体验OpenYurt了，感觉非常方便。</p>
<p>稍等！为什么是 convert/revert 而不是 install/uninstall ?</p>
<p>这个命令对集群做了什么？</p>
<p>看来，在执行它之前有必要搞清楚它到底做了什么。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="yurtctl-convert-到底做了些什么">yurtctl convert 到底做了些什么？<a href="#yurtctl-convert-到底做了些什么" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心流程">核心流程<a href="#核心流程" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>跟随openYurt<a href="https://github.com/openyurtio/openyurt/blob/5063752a9f6645270e3177e39a46df8c23145af2/pkg/yurtctl/cmd/convert/convert.go#L300" target="_blank" rel="noopener noreferrer">源代码</a>，梳理了convert的核心流程：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. 检查</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   1.1 检查所有node节点状态为ready</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. 组件部署</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.1 给node节点打上相应的label。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.2 使用deployment部署yurt-controller-manager。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.3 使用deployment部署yurt-tunnel-server。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.4 使用daemonset部署yurt-tunnel-agent，部署在边缘节点上。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2.5 使用deployment部署yurt-app-manager。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. k8s组件修改</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  3.1 修改kube-controller-manager.yaml，用来disable nodelifecycle controller</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. 节点转换</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   4.1 写入yurthub.yaml到/etc/kubernetes/manifests，启动静态pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   4.2 修改kubelet配置，使得kubelet访问yurthub而不是直连apiServer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见1、2并没有什么特别，只是常规的服务部署</p>
<p>3，则是对原有k8s系统组件的操作，需要特别注意</p>
<p>4-节点转换看着也并不复杂，却对边缘至关重要。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="disable-nodelifecycle-controller-做了什么">disable nodelifecycle controller 做了什么？<a href="#disable-nodelifecycle-controller-做了什么" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>工作内容：</p>
<ol>
<li>查询控制面节点</li>
<li>创建job，通过<code> nodeName: {{.nodeName}}</code> 确保job的pod调度到对应node上执行(通过nsenter的方式执行，修改宿主机上文件)。</li>
<li>sed -i &#x27;s/--controllers=/--controllers=-nodelifecycle,/g&#x27; /etc/kubernetes/manifests/kube-controller-manager.yaml</li>
</ol>
<p>查看kube-controller-manager.yaml</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- kube-controller-manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --allocate-node-cidrs=true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --controllers=-nodelifecycle,*,bootstrapsigner,tokencleaner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见，上面的一系列操作最终就是修改了kube-controller-manager的启动命令。</p>
<p>查看kube-controller-manager启动参数说明：</p>
<p>--controllers 代表需要开启的controller列表</p>
<p>可见，sed命令就是去掉了nodelifecycle这个controller。</p>
<p>那，nodelifecycle controller是做什么的？</p>
<p>简单来说：</p>
<ol>
<li>不断监听，kubelet上报上来的node信息</li>
<li>如果某个node状态异常，或者说长时间没有上报等
2.1 驱逐这个node节点或者其他 ---&gt; 导致上面的pod被重新调度</li>
</ol>
<p>可见，对于处于弱网环境的边缘节点，很容易就命中异常状态，导致node被驱逐，pod被重新调度。</p>
<p>所以这里把它去掉了。使用yurt-controller-manager来代替它。</p>
<p>即使节点心跳丢失，处于自治模式的节点中的pod也不会从APIServer中驱逐。</p>
<p>注：这里自治模式的节点，指的就是边缘节点。我们通常会通过加annotation的方式把节点标记为自治节点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="节点转换是怎么实现的云端节点和边缘节点有什么差异">节点转换是怎么实现的，云端节点和边缘节点有什么差异?<a href="#节点转换是怎么实现的云端节点和边缘节点有什么差异" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>同样，是通过跑job的方式，在目标宿主机上下文中执行相关操作。</p>
<p>不过，相比于暴力使用nsenter，这里用了更加优雅的方式。通过将宿主机根路径 volume挂载到容器里的方式。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="kubelet的修改">kubelet的修改<a href="#kubelet的修改" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h5>
<p>在文件/var/lib/kubelet/kubeadm-flags.env 中为KUBELET_KUBEADM_ARGS添加配置：</p>
<p><code>--kubeconfig=/var/lib/openyurt/kubelet.conf --bootstrap-kubeconfig=</code></p>
<p>作用：</p>
<ol>
<li>参数：--kubeconfig ， 给kubelet指定了访问apiServer的配置文件。</li>
<li>当--kubeconfig 文件存在，--bootstrap-kubeconfig为空时，
kubelet启动就不需要通过bootstrap-token置换文件证书等过程，直接读取kubeconfig文件访问apiServer。</li>
<li>由于KUBELET_KUBEADM_ARGS 是kubelet启动参数的最后一部分，所以可以起到覆盖前面参数的作用。</li>
</ol>
<p>其中<code>/var/lib/openyurt/kubelet.conf</code>内容如下，直接将流量指定到yurthub：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">clusters:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- cluster:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server: http://127.0.0.1:10261</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name: default-cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">contexts:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- context:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cluster: default-cluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace: default</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user: default-auth</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name: default-context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">current-context: default-context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">preferences: {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="yurthub的启动细节">yurthub的启动细节<a href="#yurthub的启动细节" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h5>
<p>yurthub容器启动参数如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- yurthub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --v=2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --server-addr=__kubernetes_service_addr__</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --node-name=$(NODE_NAME)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --join-token=__join_token__</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- --working-mode=__working_mode__</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过参数我们可看出：</p>
<ol>
<li>server-addr 指定了云端apiServer地址。注意这里的地址一定是公网可访问地址，否则异构网络下会有问题。</li>
<li>join-token 就是加入节点的token，可使用<code>kubeadm token create</code>来创建。k8s提供机制，通过token置换出正常访问的kubeconf文件。</li>
<li>working-mode： cloud/edge。这就是边缘节点和云端节点的差异。</li>
</ol>
<p>我们都知道yurthub可以用来做缓存，是解决边缘自治的重要环节。那么云端为什么也需要部署？为什么还要区分edge或者cloud工作模式？</p>
<p>简单查看yurthub源代码 cmd/yurthub/app/start.go:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">if cfg.WorkingMode == util.WorkingModeEdge {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cacheMgr, err = cachemanager.NewCacheManager(cfg.StorageWrapper, cfg.SerializerManager, cfg.RESTMapperManager, cfg.SharedFactory)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    klog.Infof(&quot;%d. disable cache manager for node %s because it is a cloud node&quot;, trace, cfg.NodeName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if cfg.WorkingMode == util.WorkingModeEdge {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    gcMgr, err := gc.NewGCManager(cfg, restConfigMgr, stopCh)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    klog.Infof(&quot;%d. disable gc manager for node %s because it is a cloud node&quot;, trace, cfg.NodeName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见，云端yurthub，少做了 cache、GC的工作。</p>
<p>查看<a href="https://github.com/openyurtio/openyurt/issues/450" target="_blank" rel="noopener noreferrer">issue</a> 可了解：云端也可以利用yurthub提供的data-filtering能力来控制service的流量</p>
<p>当然，云端也不需要做cache等工作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="命令行参数">命令行参数<a href="#命令行参数" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>在执行过程中，有几个参数比较重要：</p>
<p>--cloud-nodes 用于标识哪些是云端节点，多个节点用逗号分隔：node1,node2</p>
<p>--deploy-yurttunnel 标记是否要部署yurttunnel</p>
<p>--kubeadm-conf-path 标记节点机器上kubeadm配置文件路径。默认：/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</p>
<p>更多参数，可使用 yurtctl convert --help 来查看。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>简单来说，convert核心做了几个事情：</p>
<ol>
<li>disable k8s 的nodelifecontroller，用自己的yurtcontrollermanager来替换它的职责。</li>
<li>安装自己的各类组件，deployment、damenonset 等模式部署。（这类资源部署无需任何担心，因为搞不坏集群，也不太会出现问题。）</li>
<li>边缘节点：启动yurthub静态pod;将kubelet流量转发到yurthub。</li>
</ol>
<p>可见，convert的事情还是比较可控的。执行yurtctl convert 也不用太担心。</p>
<p>当然，最后的担心也应该由 yurtctl revert 来彻底消除！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="yurtctl-revert-又干了些什么">yurtctl revert 又干了些什么？<a href="#yurtctl-revert-又干了些什么" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心流程-1">核心流程<a href="#核心流程-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<ol>
<li>检查
1.1 确保所有node都已经ready</li>
<li>删除自身部署组件
2.1 删除 yurt-controller-manager deployment以及相关资源
2.2 删除yurt-tunnel-agent以及相关资源
2.2 删除yurt-tunnel-server以及相关资源<br>
<!-- -->2.3 删除yurt-app-manager以及相关资源</li>
<li>k8s组件修改
3.1 开启nodelifecontroller, 这个很好理解，就是把修改的命令通过sed命令改回来。</li>
<li>云端、边缘节点转换为原生节点
4.1 修改kubelet配置，直连apiServer
4.2 删除yurthub相关配置、目录</li>
</ol>
<p>整个revert的过程就是convert的反向操作，还比较好理解。</p>
<p>需要注意的是。如果convert失败，比如job执行超时或者失败。job是不会被删除的。</p>
<p>即使yurtctl revert 也不会删除。目的是为了保留现场方便定位问题。</p>
<p>如果需要重新执行yurtctl convert， 需要手动删除job。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get job -n kube-system -A |grep convert</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete job -n kube-system &lt; job-name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结-1">总结<a href="#总结-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>yurtctl convert/revert 命令是最快捷体验openYurt功能的方法之一。</p>
<p>在了解了这两个命令的实现原理，也就对openYurt的技术方案了解大半了。</p>
<p>执行命令也不担心了，so easy！</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/How-to-use-service-topology">OpenYurt边缘流量闭环能力解析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-11-24T00:00:00.000Z">2021年11月24日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/windydayc" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/windydayc.png" alt="Feng Zeng"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/windydayc" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Feng Zeng</span></a></div><small class="authorTitle_nd0D" title="Zhejiang University student, Member of OpenYurt">Zhejiang University student, Member of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="服务拓扑">服务拓扑<a href="#服务拓扑" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>服务拓扑（Service Topology）可以让一个服务根据集群的节点拓扑进行流量路由。 例如，一个服务可以指定流量被优先路由到和客户端 pod 相同的节点或者节点池上。</p>
<p>通过在原生的 Service 上添加 Annotation 实现流量的拓扑配置，相关参数如下所示：</p>
<table><thead><tr><th style="text-align:center"><strong>annotation Key</strong></th><th style="text-align:center"><strong>annotation Value</strong></th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">openyurt.io/topologyKeys</td><td style="text-align:center">kubernetes.io/hostname</td><td style="text-align:center">流量被路由到相同的节点</td></tr><tr><td style="text-align:center">openyurt.io/topologyKeys</td><td style="text-align:center">openyurt.io/nodepool <br>或 <br>kubernetes.io/zone<br></td><td style="text-align:center">流量被路由到相同的节点池</td></tr></tbody></table>
<p>下图为服务拓扑功能的一个例子。<code>service-ud1</code> 添加了注解 <code>openyurt.io/topologyKeys: openyurt.io/nodepool </code>, 当 <code>pod6</code> 访问 <code>service-ud1</code> 的时候，由于 <code>pod6</code> 位于 <code>edge node2</code>，也就是位于杭州节点池，因此其流量只会发往杭州节点池的 <code>pod1</code> 或 <code>pod2</code>上，而不会跨节点池，所以 <code>pod3</code> 和 <code>pod4</code> 收不到。从而实现了同一个节点池中的流量闭环。</p>
<p><img decoding="async" loading="lazy" alt="service-topology" src="/zh/assets/images/service-topology-example-60b16f131cb1d5e4fbdd797a79200a83.png" width="1167" height="529" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提条件">前提条件<a href="#前提条件" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<ol>
<li>Kubernetes v1.18或以上版本，因为需要支持 EndpointSlice 资源。</li>
<li>集群中部署了 Yurt-app-manager。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用方法演示">使用方法演示<a href="#使用方法演示" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>确保 Kubernetes 版本大于1.18。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-control-plane   Ready    master   6m21s   v1.18.19</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-worker          Ready    &lt;none&gt;   5m42s   v1.18.19</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind-worker2         Ready    &lt;none&gt;   5m42s   v1.18.19</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>确保集群中部署了 Yurt-app-manager。</p>
<div class="language-BASH language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get pod -n kube-system </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                                         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">coredns-66bff467f8-jxvnw                     1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">coredns-66bff467f8-lk8v5                     1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">etcd-kind-control-plane                      1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-5dpxt                                1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-ckz88                                1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kindnet-sqxs7                                1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-apiserver-kind-control-plane            1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-controller-manager-kind-control-plane   1/1     Running   0          5m38s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-ddgjt                             1/1     Running   0          7m28s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-j25kr                             1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-proxy-jt9cw                             1/1     Running   0          7m10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-scheduler-kind-control-plane            1/1     Running   0          7m39s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-app-manager-699ffdcb78-8m9sf            1/1     Running   0          37s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-app-manager-699ffdcb78-fdqmq            1/1     Running   0          37s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-controller-manager-6c95788bf-jrqts      1/1     Running   0          6m17s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-control-plane                  1/1     Running   0          3m36s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-worker                         1/1     Running   0          4m50s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurt-hub-kind-worker2                        1/1     Running   0          4m50s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-kube-proxy">配置 kube-proxy<a href="#配置-kube-proxy" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>开启 <code>kube-proxy</code> 的 <code>EndpointSliceProxying</code> <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/feature-gates/" target="_blank" rel="noopener noreferrer">特性门控</a>，并配置其连接 <code>Yurthub</code>。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit cm -n kube-system kube-proxy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  config.conf: |-</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bindAddress: 0.0.0.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    featureGates: # 1. enable EndpointSliceProxying feature gate.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      EndpointSliceProxying: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clientConnection:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      acceptContentTypes: &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      burst: 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      contentType: &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      #kubeconfig: /var/lib/kube-proxy/kubeconfig.conf # 2. comment this line.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      qps: 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clusterCIDR: 10.244.0.0/16</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    configSyncPeriod: 0s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重启 <code>kube-proxy</code>。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl delete pod --selector k8s-app=kube-proxy -n kube-system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod &quot;kube-proxy-cbsmj&quot; deleted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod &quot;kube-proxy-cqwcs&quot; deleted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pod &quot;kube-proxy-m9dgk&quot; deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建节点池">创建节点池<a href="#创建节点池" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<ul>
<li>创建用于测试的节点池。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat &lt;&lt; EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: beijing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type: Cloud</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type: Edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apps.openyurt.io/example: test-hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apps.openyurt.io/example: test-hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: NodePool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type: Edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apps.openyurt.io/example: test-shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    apps.openyurt.io/example: test-shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>将主节点 <code>kind-control-plane</code> 加入到北京节点池，工作节点 <code>kind-worker</code> 加入到杭州节点池， <code>kind-worker2 </code> 加入到上海节点池。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-control-plane apps.openyurt.io/desired-nodepool=beijing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-control-plane labeled</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-worker apps.openyurt.io/desired-nodepool=hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-worker labeled</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl label node kind-worker2 apps.openyurt.io/desired-nodepool=shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/kind-worker2 labeled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>查看节点池信息。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get np</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME       TYPE    READYNODES   NOTREADYNODES   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">beijing    Cloud   1            0               63s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hangzhou   Edge    1            0               63s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shanghai   Edge    1            0               63s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-uniteddeployment">创建 UnitedDeployment<a href="#创建-uniteddeployment" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<ul>
<li>创建 <code>united-deployment1</code> 用于测试。为了便于测试，我们使用 <code>serve_hostname</code> 镜像，当访问 9376 端口时，容器会返回它自己的主机名。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat &lt;&lt; EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: UnitedDeployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    controller-tools.k8s.io: &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  workloadTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    deploymentTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              - name: hostname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                image: mirrorgooglecontainers/serve_hostname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                - containerPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  topology:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pools:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  revisionHistoryLimit: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>创建 <code>united-deployment2</code> 用于测试。这里我们使用<code>nginx</code> 镜像，用来访问由 <code>united-deployment1</code> 创建的 <code>hostname</code> pod。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat &lt;&lt; EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: apps.openyurt.io/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: UnitedDeployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    controller-tools.k8s.io: &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  workloadTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    deploymentTemplate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              app: united-deployment2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              - name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                image: nginx:1.19.3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                - containerPort: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  topology:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pools:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - hangzhou</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      nodeSelectorTerm:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        matchExpressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - key: apps.openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          operator: In</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      replicas: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  revisionHistoryLimit: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>查看由上述 unitedDeployment 创建出来的 pod 信息。</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get pod -l &quot;app in (united-deployment1,united-deployment2)&quot; -o wide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                                                 READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-f2694   1/1     Running   0          18m   10.244.2.3   kind-worker    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95   1/1     Running   0          18m   10.244.2.2   kind-worker    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt   1/1     Running   0          18m   10.244.1.3   kind-worker2   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2   1/1     Running   0          18m   10.244.1.2   kind-worker2   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-hangzhou-lpkzg-6d958b67b6-gf847   1/1     Running   0          15m   10.244.2.4   kind-worker    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-hangzhou-lpkzg-6d958b67b6-lbnwl   1/1     Running   0          15m   10.244.2.5   kind-worker    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-shanghai-tqgd4-57f7555494-9jvjb   1/1     Running   0          15m   10.244.1.5   kind-worker2   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment2-shanghai-tqgd4-57f7555494-rn8n8   1/1     Running   0          15m   10.244.1.4   kind-worker2   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建含有-openyurtiotopologykeys-注解的服务">创建含有 openyurt.io/topologyKeys 注解的服务<a href="#创建含有-openyurtiotopologykeys-注解的服务" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat &lt;&lt; EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: svc-ud1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    openyurt.io/topologyKeys: openyurt.io/nodepool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - port: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建不含-openyurtiotopologykeys-注解的服务">创建不含 openyurt.io/topologyKeys 注解的服务<a href="#创建不含-openyurtiotopologykeys-注解的服务" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat &lt;&lt; EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: svc-ud1-without-topology</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    app: united-deployment1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - port: 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 9376</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试服务拓扑功能">测试服务拓扑功能<a href="#测试服务拓扑功能" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>通过使用上海节点池中的 pod 访问上述创建的两个服务来测试服务拓扑功能。当访问含有 <code>openyurt.io/topologyKeys</code> 注解的服务时，流量会被路由到位于上海节点池中的节点上。</p>
<p>为了进行比较，我们首先测试没有<code>openyurt.io/topologyKeys</code>注解的服务。结果如下，可以看到它的流量既可以被杭州节点池接收，也能被上海节点池接收，并不受节点池的限制。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl exec -it united-deployment2-shanghai-tqgd4-57f7555494-9jvjb bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1-without-topology:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1-without-topology:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1-without-topology:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-twf95</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1-without-topology:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-hangzhou-fv6th-66ff6fd958-f2694</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后我们测试含有<code>openyurt.io/topologyKeys</code>注解的服务。结果如下，可以看到其流量只能路由到上海节点池中的节点。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl exec -it united-deployment2-shanghai-tqgd4-57f7555494-9jvjb bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-wjck2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@united-deployment2-shanghai-tqgd4-57f7555494-9jvjb:/# curl svc-ud1:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">united-deployment1-shanghai-5p8zk-84bdd476b6-hr6xt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/How-run-business-pod-in-edge-scenarios">OpenYurt：在边缘场景无 缝运行使用InClusterConfig的业务Pod</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-15T00:00:00.000Z">2021年10月15日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">rambohe</span></a></div><small class="authorTitle_nd0D" title="Maintainer of OpenYurt">Maintainer of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1背景介绍">1.背景介绍<a href="#1背景介绍" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>OpenYurt是业界首个非侵入的边缘计算云原生开源项目，通过边缘自治，云边协同，边缘单元化，边缘流量闭环等能力为用户提供云边一体化的使用体验。不少用户在使用OpenYurt的时候，经常需要把存量的使用InClusterConfig访问kube-apiserver的Pod通过OpenYurt迁移到边缘环境中。如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/zh/assets/images/InCluster1-1ef22d79567f77ccd6a6d7eeb72185ac.png" width="752" height="273" class="img_ev3q"></p>
<p>在OpenYurt集群中，提供了使用InClusterConfig的业务Pod零修改就可以运行在边缘环境的能力。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2面临挑战">2.面临挑战<a href="#2面临挑战" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>使用InClusterConfig的业务Pod在边缘环境中运行，需要解决如下问题：</p>
<ul>
<li>
<p>问题一：Pod通过InClusterConfig地址访问kube-apiserver，节点上默认网络规则（iptables/ipvs）将会把请求转发到kube-apiserver的PodIP，同时云端与边缘位于不同网络平面，边缘是无法访问到云端的PodIP。所以边缘业务Pod无法通过InClusterConfig访问到kube-apiserver。</p>
<p><img decoding="async" loading="lazy" alt="Incluster2" src="/zh/assets/images/Incluster2-7f6a69f9c29152322fbc57bf978eca6e.png" width="443" height="311" class="img_ev3q"></p>
</li>
<li>
<p>问题二：在解决问题一后，如果云边网络断开时业务Pod容器出现重启等状况，边缘Pod将无法从kube-apiserver获取到业务配置，这会影响到业务Pod的重启运行。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3解决方案">3.解决方案<a href="#3解决方案" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>从上述问题可以看出，我们需要无感知的调整边缘pod的访问地址，同时需要在边缘环境中缓存业务配置，保证云边断网时也可以利用边缘缓存业务配置，保证云边断网时也可以利用边缘缓存来获取业务Pod的配置信息。具体解决方案如下；</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="31边缘pod访问的云端endpoint优化">3.1边缘Pod访问的云端endpoint优化<a href="#31边缘pod访问的云端endpoint优化" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h5>
<ul>
<li>
<p>Pod通过InClusterConfig访问kube-apiserver，源码如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">InClusterConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tokenFile  </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rootCAFile </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 通过Kuberentes service对应的环境变量来获取访问地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> port </span><span class="token operator">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;KUBERNETES_SERVICE_HOST&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;KUBERNETES_SERVICE_PORT&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ErrNotInCluster</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// skip some code...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;https://&quot;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> net</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">JoinHostPort</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    TLSClientConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tlsClientConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BearerToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     </span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BearerTokenFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tokenFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>因此想无感知调整边缘Pod访问的云端endpoint，只需要无侵入修改Pod的KUBERNETES_SERVICE_HOST和KUBERNETE_SERVICE_PORT两个环境变量或者修改kubernetes service地址。解决方案如下：</p>
<ul>
<li>
<p>解决方案一：增加一个admission controller在边缘Pod创建时把kube-apiserver的公网地址自动注入到Pod的环境变量KUBERNETES_SERVICE_HOST和KUBERNETE_SERVICE_PORT</p>
</li>
<li>
<p>解决方案二：边缘数据过滤框架中增加一个fillter yurthub的边缘数据过滤框架类似于admission controller ,专门用于边缘场景下在边缘应用无感知的状态下，无侵入的修改或者过滤云端返回的数据。目前支持的过滤器有：Masterservice，servicetopology，discardcloudservice等</p>
</li>
<li>
<p>解决方案对比：</p>
<table><thead><tr><th style="text-align:center"></th><th style="text-align:center">解决方案一</th><th style="text-align:center">解决方案二</th></tr></thead><tbody><tr><td style="text-align:center">实现方案</td><td style="text-align:center">增加一个admission controller</td><td style="text-align:center">边缘数据过滤框架中增加一个filter</td></tr><tr><td style="text-align:center">复杂度</td><td style="text-align:center">高（需要区别Pod运行在边缘还是云端）</td><td style="text-align:center">低</td></tr><tr><td style="text-align:center">显示修改数据</td><td style="text-align:center">Pod中增加环境变量配置</td><td style="text-align:center">无</td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<p>综合实现复杂度，非侵入等设计理念，在OpenYurt中我们选择了解决方案二。如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/zh/assets/images/InCluster3-4342c22777070b2df9e39d158a929ac3.png" width="434" height="313" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="32业务pod的边缘自治">3.2业务Pod的边缘自治<a href="#32业务pod的边缘自治" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h5>
<p>在云边网络断开状态下，业务Pod重启时，将无法从云端kube-apiserver获取到业务配置信息，因此需要在边缘本地缓存Pod的业务数据。</p>
<p><img decoding="async" loading="lazy" src="/zh/assets/images/InCluster4-4a67ce6edd8af63676837754c51f97f3.png" width="432" height="312" class="img_ev3q"></p>
<p>说明1：业务Pod通过yurthub访问kube-apiserver，也意味着[3.1 边缘Pod访问的云端endpoint优化]章节中提到的KUBERNETES_SERVICE_HOST和KUBERNETE_SERVICE_PORT环境变量被修改为yurthub https endpoint(169.254.2.1:10268)。</p>
<p>说明2：如果业务Pod的大量list/watch操作导致大量本地cache，可能会造成本地磁盘压力，因此yurthub对 业务Pod的缓存能力默认是关闭的，用户可以通过yurt-hub-cfg configmap的cache_agents字段中增加User-Agent信息来打开对应Pod的数据缓存。例如：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yurt</span><span class="token operator">-</span><span class="token plain">hub</span><span class="token operator">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kube</span><span class="token operator">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # 缓存边缘ingress</span><span class="token operator">-</span><span class="token plain">controller pod访问kube</span><span class="token operator">-</span><span class="token plain">apiserver的数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  cache_agents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ingress-controller&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4总结">4.总结<a href="#4总结" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<ul>
<li>
<p>如果存量Pod无需访问kube-apiserver或者InClusterConfig访问kube-apiserver，这些类型Pod可以零修改运行到OpenYurt集群的边缘环境上。通过其他方式访问kube-apiserver的业务Pod目前无法保证零修改运行到边缘环境。</p>
</li>
<li>
<p>边缘业务Pod是否正常访问kube-apiserver，首先可以查看业务pod的环境变量是否正常：</p>
<p>KUBERNETES_SERVICE_HOST=127.0.0.1或者169.254.2.1，KUBERNETES_SERVICE_PORT=10268。然后可以查看yurthub组件的日志是否有业务Pod相关的请求日志。当然也可以查询业务Pod的日志是否正常。最后可以确认/etc/kubernetes/cache目录是否有相关组件的缓存数据，如果没有可以再确认kube-system/yurt-hub-cfg configmap是否已经配置。</p>
</li>
<li>
<p>使用InClusterConfig的Pod零修改运行到边缘环境的能力，整体实现由yurthub组件承载，没有给OpenYurt架构增加额外的负担，同时用户在使用过程中对该能力也基本无感知，对原生业务Pod无侵入。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考链接">参考链接：<a href="#参考链接" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>1.<a href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod" target="_blank" rel="noopener noreferrer">Accessing the API from a Pod</a></p>
<p>2.<a href="https://github.com/openyurtio/openyurt/blob/master/docs/proposals/20210720-data-filtering-framework.md" target="_blank" rel="noopener noreferrer">data filtering framework on the edge</a></p>
<p>3.<a href="https://mp.weixin.qq.com/s/4BLfvMJJA623ZwRSgUE69A" target="_blank" rel="noopener noreferrer">深度解读OpenYurt：边缘自治能力设计解析</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/Play-with-OpenYurt-on-Raspberry-Pi">在树莓派上玩转 OpenYurt</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-01-05T00:00:00.000Z">2021年1月5日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zyjhtangtang" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/zyjhtangtang.png" alt="zyjhtangtang"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/zyjhtangtang" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">zyjhtangtang</span></a></div><small class="authorTitle_nd0D" title="Member of OpenYurt">Member of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/Raspberry_Pi-0d62d9c9627727b87279383f61ae8222.png" width="960" height="539" class="img_ev3q"></p>
<p>随着边缘计算的快速发展，越来越多的数据需要到网络的边缘侧进行存储、处理和分析，边缘的设备和应用呈爆发式增长。如何高效的管理边缘侧的资源和应用是业界面临的一个主要问题。当前，采用云原生的方法，将云计算的能力下沉到边缘并在云端做统一调度、管控的云边端一体化架构得到了业界的广泛认可。</p>
<p>2020 年 5 月，阿里巴巴开源首个 Kubernetes 无侵入的边缘计算云原生项目 OpenYurt，并于同年 9 月份进入 CNCF SandBox。OpenYurt 针对边缘场景中网络不稳定、云边运维困难等问题，对原生 Kubernetes 无侵入地增强，重点提供了边缘节点自治、云边运维通道、边缘单元化的能力。</p>
<p>如图下所示，
<img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/kubernetes-324e5f10b1e66083e02453040890714b.png" width="1080" height="531" class="img_ev3q"></p>
<p>本文通过在云端部署 Kubernetes 集群的控制面，并将树莓派接入集群来搭建云管边场景。基于这个环境演示 OpenYurt 的核心能力，带大家快速上手 OpenYurt。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="环境准备">环境准备<a href="#环境准备" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1基础环境介绍">1）基础环境介绍<a href="#1基础环境介绍" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>在云端，购买 ENS 节点（ENS 节点具有公网 IP，方便通过公网对外暴露服务）来部署原生 K8s 集群的管控组件。其中系统采用 ubuntu18.04、hostname 为 master-node、docker 版本为 19.03.5。</p>
<p>在边缘，将树莓派 4 与本地的路由器连接，组成边缘私网环境，路由器通过 4G 网卡访问互联网。其中树莓派 4 预装系统为 ubuntu18.04、hostname为 edge-node、docker 版本为 19.03.5。
<img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/edge_raspberry_pi-8b6984239d5bceffe23207955be08dfa.png" width="1080" height="809" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2原生k8s集群搭建">2)原生K8s集群搭建<a href="#2原生k8s集群搭建" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>本文演示环境基于社区1.16.6版本的K8s集群，并采用社区提供的kubeadm工具来搭建集群，具体操作如下：</p>
<ul>
<li>在云端节点和树莓派上分别执行如下命令安装 Kubernetes 组件。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo &quot;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot; &gt; /etc/apt/sources.list.d/kubernetes.list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt-get update</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt install -y kubelet=1.16.6-00 kubeadm=1.16.6-00 kubectl=1.16.6-00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>使用kubeadm 初始化云端节点（在云端节点上执行如下命令），部署过程中采用阿里云的镜像仓库，为了支持树莓派的接入，该仓库的镜像做了 manifest 列表，能够支持 amd64/arm64 两种不同的 CPU 架构。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># master-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubeadm init --image-repository=registry.cn-hangzhou.aliyuncs.com/edge-kubernetes --kubernetes-version=v1.16.6 --pod-network-cidr=10.244.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>依据初始化完成之后的提示，拷贝 config 文件到 $HOME/.kube 中：</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>树莓派接入云端集群依据第二步中初始化完成以后输出的节点接入信息，在树莓派上执行接入命令。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubeadm join 183.195.233.42:6443 --token XXXX \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> --discovery-token-ca-cert-hash XXXX</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>添加 cni 配置（云端管控节点和树莓派都需要配置），本文搭建的集群使用主机网络。创建 cni 配置文件 /etc/cni/net.d/0-loopback.conf，并将如下内容拷贝到该文件中。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;name&quot;: &quot;lo&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> &quot;type&quot;: &quot;loopback&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>在 master 节点上查看部署效果。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   74s    v1.16.6   192.168.0.100    &lt;none&gt;        Ubuntu 18.04.4 LTS   4.19.105-v8-28      docker://19.3.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   2m5s   v1.16.6   183.195.233.42   &lt;none&gt;        Ubuntu 18.04.2 LTS   4.15.0-52-generic   docker://19.3.5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>删除 CoreDNS（本文 Demo 中 CoreDNS 不需要使用），并将 master 节点的 taints 去掉（方便后续部署 OpenYurt 组件）。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete deployment coredns -n kube-system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl taint node master-node node-role.kubernetes.io/master-</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="原生-k8s-集群在边缘场景中的问题">原生 K8s 集群在边缘场景中的问题<a href="#原生-k8s-集群在边缘场景中的问题" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>基于上述环境，我们来测试一下原生 K8s 在云管边架构中对云边运维的支持和对云边网络断开时的反应。首先，我们从云端部署一个测试应用 nginx，在 master 节点上执行 kubectl apply -f nginx.yaml，具体的部署 yaml 如下。</p>
<p>注意：nodeSelector 选择 edge-node 节点，主机网络配置为 true，并配置 pod 的容忍时间为 5s（默认 5min, 此处配置便于演示 pod 驱逐）。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - key: &quot;node.kubernetes.io/unreachable&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> operator: &quot;Exists&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> effect: &quot;NoExecute&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerationSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - key: &quot;node.kubernetes.io/not-ready&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> operator: &quot;Exists&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> effect: &quot;NoExecute&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> tolerationSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> nodeSelector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> kubernetes.io/hostname: edge-node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - name: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> image: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> hostNetwork: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看部署结果：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 11s 192.168.0.100 edge-node &lt;none&gt; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1测试常用的集群运维指令包括-logsexecport-forward">1）测试常用的集群运维指令，包括 logs、exec、port-forward<a href="#1测试常用的集群运维指令包括-logsexecport-forward" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>在 master 节点上运维边缘节点应用，执行 logs/exec/port-forward 等指令，查看结果。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl logs nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Error from server: Get https://192.168.0.100:10250/containerLogs/default/nginx/nginx: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl exec -it nginx sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Error from server: error dialing backend: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl port-forward pod/nginx 8888:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">error: error upgrading connection: error dialing backend: dial tcp 192.168.0.100:10250: connect: connection refused</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从执行结果看，原生的k8s在云管边的场景中，无法提供从云端运维边缘应用的能力。这是因为边缘节点部署在用户的私网环境，从云端无法通过边缘节点的 IP 地址直接访问边缘节点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2测试边缘断网时对业务的影响">2）测试边缘断网时对业务的影响<a href="#2测试边缘断网时对业务的影响" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>边缘节点与云端管控通过公网连接，经常会出现网络不稳定，云端断连的情况。这里我们将做两个断网相关的测试：</p>
<ul>
<li>
<p>断网 1 分钟-&gt;恢复网络</p>
</li>
<li>
<p>断网 1 分钟-&gt;重启边缘节点-&gt;恢复网络</p>
</li>
</ul>
<p>观察两个测试过程中节点和 Pod 的状态变化。本文 Demo 中的断网方式是将路由器的公网连接断开。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1断网1分钟-恢复网络">1.断网1分钟-&gt;恢复网络<a href="#1断网1分钟-恢复网络" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<p>断开网络，大约 40s 后，节点变成 NotReady（正常节点 10s 钟上报一次心跳，当 4 次没有上报心跳时，管控组件认为节点异常）。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node NotReady &lt;none&gt;   5m13s   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready      master   6m4s    v1.16.6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>继续等待 5s 之后（正常节点变为 NotReady 之后，5m 才开始驱逐 pod，此处为了测试效果，将 pod 的容忍时间配成了 5s），应用 pod 被驱逐，状态变为 Terminating。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Terminating 0 3m45s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将网络恢复，观察节点及 pod 变化。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">No resources found in default namespace.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>网络恢复后，节点状态变成 ready，业务 pod 被清除，这是因为边缘节点的 Kubelet 获取到业务 Pod 的 Terminating 状态，对业务 Pod 做删除操作，并返回删除成功，云端也做了相应的清理。至此，业务 Pod 由于云边网络的不稳定而被驱逐，然而在断网期间，边缘节点其实是可以正常工作的。</p>
<p>重新创建应用 nginx，用于下面测试。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 4s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2断网1分钟-重启边缘节点-恢复网络">2.断网1分钟-&gt;重启边缘节点-&gt;恢复网络<a href="#2断网1分钟-重启边缘节点-恢复网络" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<p>接下来，我们测试在断网的情况下，边缘节点的重启对业务的影响。断网 1 分钟之后，Node 和 Pod 状态同上面测试结果，Node 变为 NotReady，Pod 的状态变为 Terminating。此时，切换到私有网络环境，登录到树莓派上，将树莓派重启，重启完成后等待大约 1 分钟，观察重启前后节点上的容器列表。</p>
<p>重启前边缘节点容器列表（此时云边端开，虽然在云端获取的 pod 是 Terminating 状态，但是边缘并未 Watch 到 Terminating 的操作，所以边缘的应用还正常运行）。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">9671cbf28ca6 e86f991e5d10 &quot;/docker-entrypoint.…&quot; About a minute ago Up About a minute k8s_nginx_nginx_default_efdf11c6-a41c-4b95-8ac8-45e02c9e1f4d_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">6272a46f93ef registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 2 minutes ago Up About a minute k8s_POD_nginx_default_efdf11c6-a41c-4b95-8ac8-45e02c9e1f4d_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">698bb024c3db f9ea384ddb34 &quot;/usr/local/bin/kube…&quot; 8 minutes ago Up 8 minutes k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">31952700c95b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 8 minutes ago Up 8 minutes k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重启后节点 容器列表，断网重启后，kubelet 无法从云端获取 Pod 信息，不会重建 Pod。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从重启前后的对比看，边缘节点在断网重启之后，节点上的 Pod 全部无法恢复。这就会导致在云边断网时，一旦节点重启，应用将无法工作。</p>
<p>将网络恢复，观察节点及 pod 变化，同上面测试结果，网络恢复后，节点变为 Ready，业务 Pod 被清除。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   11m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   12m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">No resources found in default namespace.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，再次部署业务 nginx，测试 OpenYurt 集群对云边运维的支持和对云边断网时的反应。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 12s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="原生-k8s-集群一键转换为-openyurt-集群">原生 K8s 集群一键转换为 OpenYurt 集群<a href="#原生-k8s-集群一键转换为-openyurt-集群" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>探究了原生 Kubernetes 在云边一体化架构中的不足之后，我们来看下 OpenYurt 集群是否能满足这种场景。现在，我们利用 OpenYurt 社区提供的集群转换工具 yurtctl，来将原生 K8s 集群转换成 OpenYurt 集群。在 master 节点上执行如下命令， 该命令指定了组件的镜像以及云端节点，并指定安装云边运维通道 yurt-tunnel。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurtctl convert --yurt-controller-manager-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-controller-manager:v0.2.1 --yurt-tunnel-agent-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-agent:v0.2.1 --yurt-tunnel-server-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-server:v0.2.1 --yurtctl-servant-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurtctl-servant:v0.2.1 --yurthub-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurthub:v0.2.1 --cloud-nodes=master-node --deploy-yurttunnel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>转换大概需要 2min，转换完成之后，观察业务 pod 的状态，可以看到转换过程中对业务 pod 无影响（也可以在转换过程中在新的终端使用 kubectl get pod -w 观察业务 pod 的状态）。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 0 2m4s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行完成之后的组件分布如下图 所示，其中橙色部分是 OpenYurt 相关的组件，蓝色部分是原生 K8s 组件。相应地，我们观察云端节点和边缘节点的 pod。</p>
<p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/OpenYurt_Cluster-cf4d0928fd91e30dec6fc5ea7f13179b.png" width="1080" height="545" class="img_ev3q"></p>
<p>云端节点 yurt 相关的 pod：yurt-controller-manager 和 yurt-tunnel-server。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods --all-namespaces -owide | grep master | grep yurt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system yurt-controller-manager-7d9db5bf85-6542h 1/1 Running 0 103s 183.195.233.42 master-node &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system   yurt-tunnel-server-65784dfdf-pl5bn         1/1     Running   0          103s    183.195.233.42   master-node   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>边缘节点新增 yurt 相关的 pod: yurt-hub（static pod）和 yurt-tunnel-agent。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods --all-namespaces -owide | grep edge | grep yurt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system yurt-hub-edge-node 1/1 Running 0 117s 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kube-system   yurt-tunnel-agent-7l8nv                    1/1     Running   0          2m      192.168.0.100    edge-node     &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试-openyurt-集群在边缘场景中的能力">测试 OpenYurt 集群在边缘场景中的能力<a href="#测试-openyurt-集群在边缘场景中的能力" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-测试-logsexecport-forward-等运维指令查看结果">1. 测试 logs/exec/port-forward 等运维指令，查看结果<a href="#1-测试-logsexecport-forward-等运维指令查看结果" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl logs nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/docker-entrypoint.sh: Configuration complete; ready for start up</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl exec -it nginx sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># ls</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bin dev docker-entrypoint.sh home media opt root sbin sys usr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">boot docker-entrypoint.d etc lib mnt proc run srv tmp var</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># exit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl port-forward pod/nginx 8888:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Forwarding from 127.0.0.1:8888 -&gt; 80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Handling connection for 8888</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>测试 port-forward 时，在 master 节点上执行 curl 127.0.0.1:8888，可以访问 nginx 服务。</p>
<p>从演示结果看，OpenYurt 能够很好地支持常用的云边运维指令。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-测试边缘断网时对业务的影响">2. 测试边缘断网时对业务的影响<a href="#2-测试边缘断网时对业务的影响" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>同样我们重复原生 K8s 中断网的两个测试，在测试之前我们先为边缘节点 edge-node 开启自治。在 OpenYurt 集群中，边缘节点的自治是通过一个 annotation 来标识的。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl annotate node edge-node node.beta.alibabacloud.com/autonomy=true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">node/edge-node annotated</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1断网-1-分钟-网络恢复">1）断网 1 分钟-&gt;网络恢复<a href="#1断网-1-分钟-网络恢复" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<p>同样，将路由器公网断开，观察 Node 和 Pod 的状态。大约过了 40s，节点的状态变成 NotReady，而大约过 1min 以后，Pod 的状态一直是 Running，并不会被驱逐。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node NotReady &lt;none&gt;   24m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready      master   25m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx   1/1     Running   0          5m7s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>恢复网络，观察 Node 和 Pod 的状态，Node 状态变为 Ready，Pod 保持 Running。可见云边网络不稳定时，对边缘节点的业务 Pod 无影响。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get nodes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME STATUS ROLES AGE VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edge-node Ready &lt;none&gt;   25m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">master-node   Ready    master   26m   v1.16.6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx   1/1     Running   0          6m30s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2断网-1-分钟-重启边缘节点-恢复网络">2）断网 1 分钟-&gt;重启边缘节点-&gt;恢复网络<a href="#2断网-1-分钟-重启边缘节点-恢复网络" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<p>接下来，我们测试在断网的情况下，边缘节点的重启对业务的影响。断网 1 分钟之后，Node 和 Pod 状态同上面测试结果，Node 变为 NotReady，Pod 保持 Running。同样，我们登录到树莓派上，将树莓派重启，观察重启前后节点上的容器列表。</p>
<p>重启前边缘节点容器列表：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">38727ec9270c 70bf6668c7eb &quot;yurthub --v=2 --ser…&quot; 7 minutes ago Up 7 minutes k8s_yurt-hub_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c403ace1d4ff registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">de0d693e9e74 473ae979be68 &quot;yurt-tunnel-agent -…&quot; 7 minutes ago Up 7 minutes k8s_yurt-tunnel-agent_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a0763f143f74 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">80c247714402 e86f991e5d10 &quot;/docker-entrypoint.…&quot; 7 minutes ago Up 7 minutes k8s_nginx_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">01f7770cb0f7 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 7 minutes ago Up 7 minutes k8s_POD_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">7e65f83090f6 f9ea384ddb34 &quot;/usr/local/bin/kube…&quot; 17 minutes ago Up 17 minutes k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c1ed142fc75b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 17 minutes ago Up 17 minutes k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重启后边缘节点容器列表：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@edge-node:~# docker ps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0c66b87066a0 473ae979be68 &quot;yurt-tunnel-agent -…&quot; 12 seconds ago Up 11 seconds k8s_yurt-tunnel-agent_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a4fb3e4e8c8f e86f991e5d10 &quot;/docker-entrypoint.…&quot; 58 seconds ago Up 56 seconds k8s_nginx_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fce730d64b32 f9ea384ddb34 &quot;/usr/local/bin/kube…&quot; 58 seconds ago Up 57 seconds k8s_kube-proxy_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">c78166ea563f registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 57 seconds k8s_POD_yurt-tunnel-agent-7l8nv_kube-system_75d28494-f577-43fa-9cac-6681a1215498_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">799ad14bcd3b registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 57 seconds k8s_POD_nginx_default_b45baaac-eebc-466b-9199-2ca5c1ede9fd_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">627673da6a85 registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; 59 seconds ago Up 58 seconds k8s_POD_kube-proxy-rjws7_kube-system_51576be4-2b6d-434d-b50b-b88e2d436fef_2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">04da705e4120 70bf6668c7eb &quot;yurthub --v=2 --ser…&quot; About a minute ago Up About a minute k8s_yurt-hub_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">260057d935ee registry.cn-hangzhou.aliyuncs.com/edge-kubernetes/pause:3.1 &quot;/pause&quot; About a minute ago Up About a minute k8s_POD_yurt-hub-edge-node_kube-system_d75d122e752b90d436a71af44c0a53be_1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从重启前后的对比看，边缘节点在断网重启之后，节点上的 pod 能正常拉起，OpenYurt 的节点自治能力可以在断网下保证业务的稳定运行。</p>
<p>恢复网络，节点 Ready，观察业务 pod 的状态，网络恢复后，业务 pod 状态保持 running，有一次重启记录，符合预期。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">root@master-node:~# kubectl get pods -owide</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx 1/1 Running 1 11m 192.168.0.100 edge-node &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，我们从yurtctl的能力将OpenYurt集群，转换为原生K8s集群。同样，可以观察转换过程中对现有业务不会有影响。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yurtctl revert --yurtctl-servant-image=registry.cn-hangzhou.aliyuncs.com/openyurt/yurtctl-servant:v0.2.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>OpenYurt 作为阿里首个边缘云原生开源项目，基于商业化产品 ACK@Edge，在集团内部经历了长时间的打磨。已经应用在 CDN、IoT、盒马、ENS、菜鸟物流等众多场景。针对边缘场景，该项目坚持保持原生 K8s 的特性，以 Addon 的形式提供了边缘节点自治、云边端一体化运维通道等能力。最近在社区同学的一起努力下又开源了边缘单元化管理能力，同时后续还会继续开源更多的边缘管理能力，欢迎大家积极参与贡献。</p>
<p><a href="https://mp.weixin.qq.com/s/Anr8UhTaNe3FCnKKfKoXNQ" target="_blank" rel="noopener noreferrer">原文链接</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh/blog/Introduce-of-OpenYurt">边缘计算云原生项目 OpenYurt</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-05-29T00:00:00.000Z">2020年5月29日</time> · <!-- -->阅读需要 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Fei-Guo" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/Fei-Guo.png" alt="Fei Guo"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/Fei-Guo" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Fei Guo</span></a></div><small class="authorTitle_nd0D" title="Maintainer of OpenYurt">Maintainer of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/huangyuqi" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/huangyuqi.png" alt="frank-huangyuqi"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/huangyuqi" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">frank-huangyuqi</span></a></div><small class="authorTitle_nd0D" title="Maintainer of OpenYurt">Maintainer of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/rambohe-ch.png" alt="rambohe"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/rambohe-ch" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">rambohe</span></a></div><small class="authorTitle_nd0D" title="Maintainer of OpenYurt">Maintainer of OpenYurt</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/OpenYurt-de0f93f0c16ddb05b6782cbe66107b22.png" width="865" height="203" class="img_ev3q"></p>
<p>导读：北京时间 5 月 29 日，在阿里云容器服务 ACK@Edge（边缘集群托管服务） 上线一周年之际，阿里巴巴正式宣布将其核心能力开源，并向社区贡献完整的边缘计算云原生项目 -- OpenYurt。</p>
<p>边缘云计算是基于云计算技术的核心和边缘计算的能力，构筑在边缘基础设施之上的新型计算平台，并正在成为行业的新焦点。OpenYurt 作为阿里巴巴首个边缘计算云原生开源项目，汇聚了阿里巴巴众多边缘计算业务团队的深厚技术积累，深度挖掘了边缘计算 + 云原生落地实施诉求。</p>
<p>两年前，OpenYurt 作为公共云服务 ACK@Edge 的核心框架，就已经应用于 CDN、音视频直播、物联网、物流、工业大脑、城市大脑等实际应用场景中，并服务于阿里云 LinkEdge、盒马、优酷、视频云（视频点播、视频直播、实时通信、视频监控、智能视觉）等多个业务或项目中。</p>
<p>阿里巴巴云原生开源负责人、云原生应用平台资深技术专家李响表示：“随着边缘计算的场景和需求不断增加，‘云边协同’、‘边缘云原生’正在逐渐成为新的技术焦点。OpenYurt 开源项目实践‘云边一体化’概念，依托原生 Kubernetes 强大的容器编排、调度能力，实现完全边缘计算云原生基础设施架构，帮助开发者轻松完成在海量边、端资源上的大规模应用的交付、运维、管控。我们希望 OpenYurt 开源能推动社区在云 原生和边缘计算交叉领域的协同发展。”</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是openyurt">什么是OpenYurt<a href="#什么是openyurt" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/OpenYurt-01-b706847ee60a69ed405be1564734ed6e.png" width="1080" height="484" class="img_ev3q"></p>
<p>使用 OpenYurt（Yurt，/jɜːrt/，蒙古包）作为本次开源项目名称，期望以其“形”来表示边缘计算侧重于创建一个集中管理但物理分布的基础设施，并支持自动/自治运行操作的含义。</p>
<p>OpenYurt 主打“云边一体化”概念，依托原生 Kubernetes 强大的容器编排、调度能力，通过众多边缘计算应用场景锤炼，实现了一整套对原生 Kubernetes“零”侵入的边缘云原生方案，提供诸如边缘自治、高效运维通道、边缘单元化管理、边缘流量拓扑管理，安全容器、边缘 Serverless/FaaS、异构资源支持等能力。OpenYurt 能帮用户解决在海量边、端资源上完成大规模应用交付、运维、管控的问题，并提供中心服务下沉通道，实现和边缘计算应用的无缝对接。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1openyurt诞生背景">1）OpenYurt诞生背景<a href="#1openyurt诞生背景" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/OpenYurt-02-f917b1d6fc1c832f325baa2a27be7ed3.png" width="1080" height="471" class="img_ev3q">
从 2017 年底开始，阿里云物联网（IoT）和 CDN (内容分发网络)服务作为典型的边缘计算业务正面临着产品规模的爆发式增长、运维复杂度急剧攀升、运维效率不高的“三难”境地，因此引入云原生理念、全面转型边缘应用的运维管理模式成为亟需解决的问题。</p>
<p>正是  在这样的背景下，OpenYurt 诞生于阿里云容器服务团队，并在接下来的两年多时间内，作为公共云服务 ACK@Edge 的核心框架被广泛应用于 CDN、音视频直播、物联网、物流、工业大脑、城市大脑等实际应用场景中，并正在服务于阿里云 LinkEdge、盒马、优酷、视频云（视频点播，视频直播，实时通信，视频监控，智能视觉）等多个业务或项目中。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2openyurt技术特点">2）OpenYurt技术特点<a href="#2openyurt技术特点" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>OpenYurt沿用了目前业界流行的“中心管控、边缘自治”的边缘应用管理架构，将“云边端一体化协同”作为目标，赋能云原生能力向边缘端拓展。在技术实现上，OpenYurt贯彻了“Extending your native Kubernetes to Edge”的核心设计理念，其技术方案有如下特点：</p>
<ul>
<li>对原生Kubernetes“零”侵入，保证对原生k8s API的完全兼容。</li>
</ul>
<p>OpenYurt通过proxy node network traffic，对 Kubernetes 节点应用生命周期管理加了一层新的封装，提供边缘计算所需要的核心管控能力；</p>
<ul>
<li>
<p>无缝转换，OpenYurt提供了工具将原生Kubernetes“一键式”转换成支持边缘计算能力的 Kubernetes 集群；</p>
</li>
<li>
<p>低Overhead，OpenYurt参考了大量边缘计算场景的实际需求，在保证功能和可靠性的基础上，本着最小化，最简化的设计理念，严格限制新增组件的资源诉求。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3openyurt核心能力">3）OpenYurt核心能力<a href="#3openyurt核心能力" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image" src="/zh/assets/images/OpenYurt_arch-a3dcd2a758bb9c978f52c8a61c6a98f6.png" width="1652" height="929" class="img_ev3q"></p>
<ul>
<li>边缘自治能力：</li>
</ul>
<p>YurtHub作为节点上的临时配置中心，在网络连接中断的情况下，持续为节点上所有设备和客户业务提供数据配置服务。YurtHub 提供了对大量原生 Kubernetes API的支持，可以在节点和边缘单元维度提供“ShadowApiserver”的能力，在边缘计算弱网络链接场景的价值尤为突出；</p>
<ul>
<li>边缘运维通道</li>
</ul>
<p>在边缘场景，由于大多数边缘节点没有暴露在公网之上，中心管控无缝和边缘节点主动建立网络链接，所有的Kubernetes原生应用运维APIs（logs/exec/metrics）会失去效力；
YurtTunnel 通过在管控与边缘节点之间建立反向通道，并和节点的生命周期完整联动，承载原生运维 APIs 的流量；</p>
<ul>
<li>集群转换能力
Yurtctl作为OpenYurt官方命令行工具，提供原生Kubernetes集群支持边缘计算infrastructure的一键式切换。</li>
</ul>
<p>其他更高级的功能比如边缘流量管理、单元化管理，部署、区域自治等将会逐步开源。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4openyurt-roadmap">4）OpenYurt Roadmap<a href="#4openyurt-roadmap" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>作为阿里云容器服务 ACK@Edge 的开源版本，OpenYurt 将采用全开源社区开发模式，每季度发布新版本更新，包含社区上游安全/关键 bug 修复和新特性、新能力，并逐步将产品完整能力开源。</p>
<p>主导这次开源的阿里巴巴云原生应用平台团队，目前已经开源 OAM、OpenKruise、Dragonfly、Apache RocketMQ、Apache Dubbo 等众多明星项目，是国内最资深的云原生开源贡献团队。OpenYurt 项目的开源，本着“Extending your native Kubernetes to Edge”的设计理念，让云原生技术在边缘计算领域的生态建设与普及前进了一大步，也为全球开发者拓展云原生边界贡  献了一份力量。</p>
<p><a href="https://mp.weixin.qq.com/s/0LwCE4CpVdttmvx4FAMArg" target="_blank" rel="noopener noreferrer">原文链接</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/openyurt">openyurt</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/installation/summary">快速开始</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/tags/">钉钉 (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright © 2024 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
</body>
</html>