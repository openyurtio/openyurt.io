"use strict";(globalThis.webpackChunkopenyurt_io=globalThis.webpackChunkopenyurt_io||[]).push([[20170],{89488(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"user-manuals/node-management/join-a-node","title":"Join a node","description":"This document outlines the procedures for joining a node into an OpenYurt cluster. There are two primary methods depending on the node\'s initial state:","source":"@site/docs/user-manuals/node-management/join-a-node.md","sourceDirName":"user-manuals/node-management","slug":"/user-manuals/node-management/join-a-node","permalink":"/docs/next/user-manuals/node-management/join-a-node","draft":false,"unlisted":false,"editUrl":"https://github.com/openyurtio/openyurt.io/edit/master/docs/user-manuals/node-management/join-a-node.md","tags":[],"version":"current","lastUpdatedBy":"Ihor Sychevskyi","lastUpdatedAt":1770588525000,"frontMatter":{"title":"Join a node"},"sidebar":"docs","previous":{"title":"Node management overview","permalink":"/docs/next/user-manuals/node-management/node-management-overview"},"next":{"title":"Remove a node","permalink":"/docs/next/user-manuals/node-management/remove-a-node"}}');var s=t(74848),r=t(28453);const i={title:"Join a node"},d=void 0,a={},l=[{value:"1. Joining a New Node from Scratch",id:"1-joining-a-new-node-from-scratch",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"1.1 Using <code>yurtadm join</code>",id:"11-using-yurtadm-join",level:3},{value:"1.2 Component and CNI Handling",id:"12-component-and-cni-handling",level:3},{value:"2. Converting an Existing Kubernetes Node",id:"2-converting-an-existing-kubernetes-node",level:2},{value:"2.1 Label and Annotate the Node",id:"21-label-and-annotate-the-node",level:3},{value:"2.2 Setup YurtHub",id:"22-setup-yurthub",level:3},{value:"2.3 Reconfigure Kubelet",id:"23-reconfigure-kubelet",level:3},{value:"2.4 Restart Pods on the Node",id:"24-restart-pods-on-the-node",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"This document outlines the procedures for joining a node into an OpenYurt cluster. There are two primary methods depending on the node's initial state:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#1-joining-a-new-node-from-scratch",children:"1. Joining a New Node from Scratch"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#prerequisites",children:"Prerequisites"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsxs)(n.a,{href:"#11-using-yurtadm-join",children:["1.1 Using ",(0,s.jsx)(n.code,{children:"yurtadm join"})]})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#12-component-and-cni-handling",children:"1.2 Component and CNI Handling"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#2-converting-an-existing-kubernetes-node",children:"2. Converting an Existing Kubernetes Node"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#21-label-and-annotate-the-node",children:"2.1 Label and Annotate the Node"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#22-setup-yurthub",children:"2.2 Setup YurtHub"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#23-reconfigure-kubelet",children:"2.3 Reconfigure Kubelet"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#24-restart-pods-on-the-node",children:"2.4 Restart Pods on the Node"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"1-joining-a-new-node-from-scratch",children:"1. Joining a New Node from Scratch"}),"\n",(0,s.jsxs)(n.p,{children:["This method is for nodes that are not yet part of any Kubernetes cluster. The ",(0,s.jsx)(n.code,{children:"yurtadm join"})," command streamlines this process by installing necessary components and connecting the node to the OpenYurt cluster."]}),"\n",(0,s.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsx)(n.p,{children:"Before joining, ensure the following conditions are met on the node:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A container runtime (like containerd or Docker) is installed and running."}),"\n",(0,s.jsx)(n.li,{children:"The swap partition is turned off."}),"\n",(0,s.jsx)(n.li,{children:"The node has network connectivity to the Kubernetes API server."}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"11-using-yurtadm-join",children:["1.1 Using ",(0,s.jsx)(n.code,{children:"yurtadm join"})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"yurtadm join"})," command handles the installation of ",(0,s.jsx)(n.code,{children:"kubeadm"}),", ",(0,s.jsx)(n.code,{children:"kubelet"}),", and ",(0,s.jsx)(n.code,{children:"kube-proxy"}),", and then joins the node to the cluster."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"To join an edge node:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/openyurtio/openyurt/releases",children:"yurtadm"})," binary can be downloaded from the OpenYurt Releases page."]}),"\n",(0,s.jsxs)(n.li,{children:["how to compile ",(0,s.jsx)(n.code,{children:"yurtadm"})," binary, please refer to the link ",(0,s.jsx)(n.a,{href:"/docs/next/installation/yurtadm-init#21-compile-yurtadm",children:"here"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"yurtadm join <apiserver-address>:6443 --token=<apiserver-token> --node-type=edge --discovery-token-unsafe-skip-ca-verification --v=5\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If the edge node uses ",(0,s.jsx)(n.code,{children:"containerd"})," as its runtime, you must specify the ",(0,s.jsx)(n.code,{children:"--cri-socket"})," parameter:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"yurtadm join <apiserver-address>:6443 --token=<token> --node-type=edge --discovery-token-unsafe-skip-ca-verification --cri-socket=/run/containerd/containerd.sock --v=5\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"To join a cloud node:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"yurtadm join <apiserver-address>:6443 --token=<token> --node-type=cloud --discovery-token-unsafe-skip-ca-verification --v=5\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Parameter Explanation:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"<apiserver-address>:6443"}),": The address of the apiserver."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--token"}),": The bootstrap token for authenticating with the cluster. Refer to the ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/",children:"Kubernetes documentation"})," on how to generate a token."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--node-type"}),": openyurt node type, which can be ",(0,s.jsx)(n.code,{children:"cloud"})," or ",(0,s.jsx)(n.code,{children:"edge"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"12-component-and-cni-handling",children:"1.2 Component and CNI Handling"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"yurtadm join"})," will automatically handle component installation."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Kubernetes Components"}),": It installs ",(0,s.jsx)(n.code,{children:"kubelet"}),", ",(0,s.jsx)(n.code,{children:"kubeadm"}),", etc. You can pre-place these binaries in your ",(0,s.jsx)(n.code,{children:"$PATH"})," to use a specific version, but ",(0,s.jsx)(n.code,{children:"yurtadm"})," will verify that their major and minor versions match the cluster's Kubernetes version."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CNI Binaries"}),": The join process pulls specially modified CNI binaries (e.g., for Flannel) to suit edge environments. If you have prepared your own CNI binaries, place them under ",(0,s.jsx)(n.code,{children:"/opt/cni/bin"})," and use the ",(0,s.jsx)(n.code,{children:"--reuse-cni-bin=true"})," flag with the ",(0,s.jsx)(n.code,{children:"yurtadm join"})," command."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"2-converting-an-existing-kubernetes-node",children:"2. Converting an Existing Kubernetes Node"}),"\n",(0,s.jsx)(n.p,{children:"This method is for nodes that are already part of a standard Kubernetes cluster and you want to convert them into OpenYurt edge or cloud nodes. This involves labeling the node and manually setting up YurtHub."}),"\n",(0,s.jsx)(n.h3,{id:"21-label-and-annotate-the-node",children:"2.1 Label and Annotate the Node"}),"\n",(0,s.jsxs)(n.p,{children:["First, identify the node as either an ",(0,s.jsx)(n.code,{children:"edge"})," or ",(0,s.jsx)(n.code,{children:"cloud"})," node using a label."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Labeling an edge node:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl label node <node-name> openyurt.io/is-edge-worker=true\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["For a cloud node, set the label value to ",(0,s.jsx)(n.code,{children:"false"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enabling node autonomy (Optional):"}),"\nTo prevent pods from being evicted when an edge node loses connection to the control plane, add the ",(0,s.jsx)(n.code,{children:"autonomy-duration"})," annotation. The node.openyurt.io/autonomy-duration annotation will map to the tolerationSeconds field in the Pod, a value of 0 indicates that Pods will never be evicted. The duration format can be found ",(0,s.jsx)(n.a,{href:"https://pkg.go.dev/maze.io/x/duration#ParseDuration",children:"here"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl annotate node <node-name> node.openyurt.io/autonomy-duration=0\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Adding the node to a NodePool (Optional):"}),"\nTo leverage OpenYurt's unitization capabilities, you can assign the node to a ",(0,s.jsx)(n.code,{children:"NodePool"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# First, create a NodePool if it doesn't exist\ncat <<EOF | kubectl apply -f -\napiVersion: apps.openyurt.io/v1beta2\nkind: NodePool\nmetadata:\n  name: worker\nspec:\n  type: Edge\nEOF\n\n# Then, label the node to associate it with the NodePool\nkubectl label node <node-name> apps.openyurt.io/desired-nodepool=worker\n"})}),"\n",(0,s.jsx)(n.h3,{id:"22-setup-yurthub",children:"2.2 Setup YurtHub"}),"\n",(0,s.jsxs)(n.p,{children:["YurtHub is a critical component that acts as a proxy between the ",(0,s.jsx)(n.code,{children:"kubelet"})," and the API server. It is typically deployed as a static pod."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Prepare the YurtHub manifest:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Get a bootstrap token and the API server's address."}),"\n",(0,s.jsxs)(n.li,{children:["Use these values to populate a YurtHub manifest template (e.g., ",(0,s.jsx)(n.a,{href:"https://github.com/openyurtio/openyurt/blob/master/config/setup/yurthub.yaml",children:(0,s.jsx)(n.code,{children:"config/setup/yurthub.yaml"})}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Replace placeholders and copy the manifest to the target node\\'s manifests directory\ncat config/setup/yurthub.yaml | \nsed 's|__kubernetes_master_address__|<apiserver_address>|;\ns|__bootstrap_token__|<token>|' > /tmp/yurthub.yaml\nscp /tmp/yurthub.yaml root@<node-ip>:/etc/kubernetes/manifests/\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"23-reconfigure-kubelet",children:"2.3 Reconfigure Kubelet"}),"\n",(0,s.jsxs)(n.p,{children:["Next, reconfigure the ",(0,s.jsx)(n.code,{children:"kubelet"})," on the node to communicate through YurtHub instead of directly with the API server."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Create a new kubeconfig for kubelet:"}),"\nThis kubeconfig points ",(0,s.jsx)(n.code,{children:"kubelet"})," to the local YurtHub instance (",(0,s.jsx)(n.code,{children:"http://127.0.0.1:10261"}),")."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Run these commands on the target node\nmkdir -p /var/lib/openyurt\ncat << EOF > /var/lib/openyurt/kubelet.conf\napiVersion: v1\nclusters:\n- cluster:\n    server: http://127.0.0.1:10261\n  name: default-cluster\ncontexts:\n- context:\n    cluster: default-cluster\n    namespace: default\n    user: default-auth\n  name: default-context\ncurrent-context: default-context\nkind: Config\npreferences: {}\nEOF\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Update the kubelet service configuration:"}),"\nModify the ",(0,s.jsx)(n.code,{children:"kubelet"}),"'s systemd drop-in file to use the new kubeconfig. The file path may vary depending on your OS (e.g., ",(0,s.jsx)(n.code,{children:"/etc/systemd/system/kubelet.service.d/10-kubeadm.conf"}),")."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'sed -i "s|KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=\\/etc\\/kubernetes\\/bootstrap-kubelet.conf\\ --kubeconfig=\\/etc\\/kubernetes\\/kubelet.conf|KUBELET_KUBECONFIG_ARGS=--kubeconfig=\\/var\\/lib\\/openyurt\\/kubelet.conf|g" \\\n/etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Restart the kubelet service:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Run on the target node\nsystemctl daemon-reload && systemctl restart kubelet\n"})}),"\n",(0,s.jsxs)(n.p,{children:["After restarting, verify the node returns to a ",(0,s.jsx)(n.code,{children:"Ready"})," state using ",(0,s.jsx)(n.code,{children:"kubectl get nodes"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"24-restart-pods-on-the-node",children:"2.4 Restart Pods on the Node"}),"\n",(0,s.jsx)(n.p,{children:"Finally, to ensure all pods on the node communicate through YurtHub, they must be recreated."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning:"})," This operation will cause a brief service interruption. Confirm the impact on your production environment before proceeding."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. List all pods running on the converted node\nkubectl get pod -A -o wide | grep <node-name>\n\n# 2. Delete all user pods and system pods (except the yurthub pod)\n#    The Kubernetes controllers will automatically recreate them.\nkubectl delete pod <pod-1> <pod-2> -n <namespace>\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453(e,n,t){t.d(n,{R:()=>i,x:()=>d});var o=t(96540);const s={},r=o.createContext(s);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);