<!doctype html>
<html class="docs-version-v0.6.0" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenYurt Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/opensearch.xml">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" color="#ffffff" href="/favicons/safari-pinned-tab.svg">
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-config" content="/favicons/browserconfig.xml"><title data-react-helmet="true">YurtTunnel | OpenYurt</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://openyurt.io/docs/v0.6.0/core-concepts/yurttunnel"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v0.6.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v0.6.0"><meta data-react-helmet="true" property="og:title" content="YurtTunnel | OpenYurt"><meta data-react-helmet="true" name="description" content="1. Background"><meta data-react-helmet="true" property="og:description" content="1. Background"><link data-react-helmet="true" rel="shortcut icon" href="/img/openyurt.ico"><link data-react-helmet="true" rel="canonical" href="https://openyurt.io/docs/v0.6.0/core-concepts/yurttunnel"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/docs/v0.6.0/core-concepts/yurttunnel" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/zh/docs/v0.6.0/core-concepts/yurttunnel" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/docs/v0.6.0/core-concepts/yurttunnel" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.8a5667f5.css">
<link rel="preload" href="/assets/js/runtime~main.4409c719.js" as="script">
<link rel="preload" href="/assets/js/main.22786535.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">‚≠êÔ∏è If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! ‚≠êÔ∏è</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">OpenYurt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="http://47.242.50.237/login" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Experience-Center<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs/v0.6.0/">v0.6.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/core-concepts/yurttunnel">Next</a></li><li><a class="dropdown__link" href="/docs/core-concepts/yurttunnel">v0.7.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v0.6.0/core-concepts/yurttunnel">v0.6.0</a></li><li><a class="dropdown__link" href="/docs/v0.5.0/core-concepts/yurttunnel">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/v0.6.0/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/docs/v0.6.0/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist" href="#">Getting Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Installation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Core Concepts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Components</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/yurthub">YurtHub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/v0.6.0/core-concepts/yurttunnel">YurtTunnel</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/yurt-app-manager">YurtAppManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/yurt-controller-manager">YurtControllerManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/node-resource-manager">NodeResourceManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/core-concepts/yurt-device-controller">YurtDeviceController</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Manuals</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist" href="#">Best Practices</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v0.6.0/best-practices/practices-1">Cloud-Edge-Device DevOps Collaboration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Developer Manuals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/v0.6.0/faq">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->OpenYurt<!-- --> <b>v0.6.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/core-concepts/yurttunnel">latest version</a></b> (<!-- -->v0.7.0<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->v0.6.0</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>YurtTunnel</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="1-background">1. Background<a aria-hidden="true" class="hash-link" href="#1-background" title="Direct link to heading">‚Äã</a></h2><p>During the deployment and operation of the application, users often get the logs of the application or log in to the application&#x27;s running environment for debugging. In Kubernetes, we usually use kubectl log, kubectl exec, etc. to implement these requirements. As shown below, on the kubectl request link, kubelet will act as a server to handle requests forwarded by kube-apiserver (KAS), which requires a network path between KAS and kubelet to allow KAS to access kubelet.  </p><p><img alt="img" src="/assets/images/kubectl-4a135b776e4058dae26cb98067a28d99.jpg"></p><p>Cloud and edge are generally located on different network planes, and edge nodes are generally located inside the firewall. Using the cloud-edge (center-edge) collaboration structure will lead to the following challenges in operation and monitoring capabilities of the native K8s system:</p><ul><li>Lack of native operation capabilities of K8s( such as kubectl logs/exec etc. can&#x27;t work )</li><li>The main monitoring and operation components of the community can&#x27;t work( such as Prometheus/metrics-server )</li></ul><p>In order to support operating edge applications through cloud nodes, we must establish a reverse operation channel between cloud and edge.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="2-reverse-channel">2. Reverse Channel<a aria-hidden="true" class="hash-link" href="#2-reverse-channel" title="Direct link to heading">‚Äã</a></h2><p>In OpenYurtÔºåwe introduce a special component‚Äî‚ÄîYurtTunnel to solve the problem of cloud-edge communication. Reverse channel is a common way to solve cross network communication, and the essence of YurtTunnel is also a reverse channel. It&#x27;s a typical C/S structure component, consisting of Yurt-Tunnel-Server deployed on cloud and Yurt-Tunnel-Agent deployed on edge. The structure of YurtTunnel is shown in the figure below, the workflow of the reverse channel includes the following steps:</p><ul><li>Deploy Yurt-Tunnel-Server on the network plane where the control components are located.</li><li>Yurt-Tunnel-Server opens an IP that can be accessed by the public network.</li><li>Deploy Yurt-Tunnel-Agent on each edge nodeÔºåand establish a long connection with the server through the public IP of the server.</li><li>The request from control components to edge nodes will be forwarded to Yurt-Tunnel-Server.</li><li>Then Yurt-Tunnel-Server sends the request to the target edge node through the long connection.</li></ul><p><img alt="img" src="/assets/images/tunnel_arch-f5523df0a26022bbc4a94960802f2c40.jpg"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="3-implementation-mode">3. Implementation Mode<a aria-hidden="true" class="hash-link" href="#3-implementation-mode" title="Direct link to heading">‚Äã</a></h2><p>To build a secure, non-invasive and scalable reverse channel solution in the k8s cloud-edge integration structure, the solution includes at least the following three capabilities.</p><ul><li>Tunnel construction</li><li>Self-management of certificates at both ends of the tunnel</li><li>Requests of cloud components are seamlessly routed to the tunnel</li></ul><p>The structure modules of YurtTunnel are as followsÔºö</p><p><img alt="img" src="/assets/images/tunnel_components-98b2297c73ddbafee663f1dacf5ec19d.jpg"></p><p>1) Tunnel construction</p><ul><li>When Yurt-Tunnel-Agent on the edge is startedÔºåit will establish a connection with Yurt-Tunnel-Server according to the access address and register. Then the agent will periodically detect the health status of the connection, rebuild the connection, and so on.</li></ul><p>The identity information registered by Yurt-Tunnel-Agent is as followsÔºö</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentID&quot;: {NodeName}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentIdentifiers&quot;: ipv4={nodeIP}&amp;host={NodeName}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>When Yurt-Tunnel-Server receives a request from the cloud component, it should forward the request to corresponding Yurt-Tunnel-Agent. In addition to forwarding the initial request, the session of the request will also have data returns or continuous data forwarding( such as kubectl exec ) later. Therefore, it should forward data in both directions. At the same time, it is necessary to support and forward requests from cloud components, which means that it should establish an independent identifier for each request life cycle. So there are generally two plans in the design.</li></ul><p>Plan 1: The initial cloud-edge connection only informs the forwarding request, Yurt-Tunnel-Agent will establish a new connection with cloud to process the request. The problem of requesting independent identification can be well solved through the new connection, and concurrency can also be well resolved. But establishing a connection for each request will consume lots of resources.</p><p>Plan 2: Only the initial cloud-edge connection is used to forward requests. In order to reuse the same connection for many requests, it is necessary to encapsulate each request and add an independent identifier to solve the demand for concurrent forwarding. At the same time, we should decouple connection management and request lifecycle management since a connection needs to be reused. That is, the state transition of request forwarding should be managed independently. This plan involves packet and unpack, request processing state machine, etc., which will be more complicated.</p><ul><li>OpenYurt chooses the ANP component, which adopts the above plan 2. This is also consistent with our original design intention. </li><li>The construction of the request forwarding link is encapsulated in Packet_DialRequest and Packet_DialResponse. Packet_DialResponse.ConnectID is used to identify request, which is equal to the requestID in tunnel. Requests and associated data are encapsulated in Packet_Data. Packet_CloseRequest and Packet_CloseResponse are used to forward link resource reclamation. Please refer to the following timing diagram for details:</li></ul><p><img alt="img" src="/assets/images/tunnel_sequence_diag-385d8a83150e7246026538e7948dd738.jpg"></p><ul><li>Function of RequestInterceptorÔºö
From the above analysis, It can be seen that the requester should initiate an Http Connect request to build a forwarding link before Yurt-Tunnel-Server forwards the request. However, it&#x27;s difficult to add corresponding processing to open source components such as Prometheus and metrics-server. Therefore, the request hijacking module‚Äî‚ÄîInterceptor is added to Yurt-Tunnel-Server to initiate Http Connect requests.</li></ul><p>2) Certificate management</p><p>In order to ensure the long-term secure communication of the cloud-edge channel and support https request forwarding, YurtTunnel needs to generate its own certificate and maintain the automatic rotation of the certificate. The specific details are as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 1. Yurt-Tunnel-Server certificate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/certmanager.go#L45-90</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Certificate store location: /var/lib/yurt-tunnel-server/pki</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;kube-apiserver-kubelet-client&quot;  // webhook validation for kubelet server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;system:masters&quot;, &quot;openyurt:yurttunnel&quot;} // webhook checksum for kubelet server and auto approve for Yurt-Tunnel-Server certificate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Subject Alternate Name values: {x-tunnel-server-svc, x-tunnel-server-internal-svc&#x27;s ips and dns names}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: &quot;any&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 2. Yurt-Tunnel-Agent certificateÔºö</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/certmanager.go#L94-112</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Certificate store location: /var/lib/yurt-tunnel-agent/pki</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;yurttunnel-agent&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;openyurt:yurttunnel&quot;} // auto approve for Yurt-Tunnel-Agent certificate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Subject Alternate Name values: {NodeName, nodeIP}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: &quot;any&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 3. yurt-tunnel certificate application (CSR) is approved by Yurt-Tunnel-Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/csrapprover.go#L115</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- monitor csr resources</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- filter non yurt-tunnel&#x27;s csr (no &quot;openyurt:yurttunnel&quot; in Organization)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- approve csrs that have not been approved</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 4. Certificate auto-rotation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/client-go/util/certificate/certificate_manager.go#L224</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>3) Seamlessly route requests of cloud components to the tunnel</p><p>Because the requests of cloud components need to be seamlessly forwarded to Yurt-Tunnel-Server, it also means that there is no need to modify the cloud components. Therefore, it is necessary to analyze the requests of cloud components. At present, the operation requests of components mainly include the following two types:</p><ul><li>Type 1: Use Ip address directly, for example: http://{nodeIP}:{port}/{path}</li><li>Type 2: Use domain name, for example: http://{NodeName}:{port}/{path}</li></ul><p>For different types of requests, it needs different plans.</p><p>Plan 1: Use iptables dnat rules to ensure that type 1 requests are seamlessly forwarded to Yurt-Tunnel-Server</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># related iptables rules maintenance code: https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/iptables/iptables.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># iptables dnat rules maintained by Yurt-Tunnel-Server are as follows:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* edge tunnel server port */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10255  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10255 /* jump to port 10255 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10250  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10250 /* jump to port 10250 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:10255 to:172.16.6.156:10264</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Plan 2: Use dns domain name resolution to solve NodeName to access address of Yurt-Tunnel-Server, so that type 2 requests can be seamlessly forwarded to yurt-tunnel. Its working principle is shown in the figure:</p><p><img alt="img" src="/assets/images/tunnel_dns-3f45c486b188e1dd9e5b254ba516e10f.jpg"></p><ul><li>Yurt-Tunnel-Server will maintain two Service addressesÔºö <ul><li>x-tunnel-server-svc: Mainly expose port 10262/10263, used to access Yurt-Tunnel-Server from the public network. Such as Yurt-Tunnel-Agent.</li><li>x-tunnel-server-internal-svc: Mainly used for cloud components access from the internal network, such as prometheus, metrics-server, etc.</li></ul></li><li>Yurt-Tunnel-Server has a built-in DNS Controller, dynamically configures Core DNS Host records, and maintains the mapping relationship between NodeName and IP(Cloud Node can reach directly according to IP, that is directly mapped to Node IP;Edge Node needs to communicate through the Tunnel agent, that is mapping to cluster ip of Yurt-Tunnel-Server Internal Service)</li><li>When the cloud component access the Edge Node by NodeName, it will solve domain names through CoreDNS by default. The request for the Edge Node will be directed to the ClusterIP of the internal service of Yurt-Tunnel-Server, and use the forwarding ability of kube-proxy to load the request Balanced into healthy Yurt-Tunnel-Server Pods.</li><li>Yurt-Tunnel-Server will check the requested Host format. When the Host format is NodeName, it will find the correct Agent backend through the node name and forward the data.</li></ul><p>4) Port extension</p><p>If users want to access other ports on the edge (other than 10250 and 10255), they need to add corresponding dnat rules in iptables or add corresponding port mapping in x-tunnel-server-internal-svc, as shown below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># access port 9051 of the edge for example.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add iptables dnat rule:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-9051  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9051 /* jump to port 9051 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:9051 to:172.16.6.156:10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add port mapping in x-tunnel-server-internal-svc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10250</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10263</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: dnat-9051 # add mapping</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above iptables dnat rules and service port mapping are automatically updated by Yurt-Tunnel-Server. Users just add port configuration in <code>yurt-tunnel-server-cfg</code> configmap that is under <code>kube-system</code> . The details are as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Yaml"><pre tabindex="0" class="prism-code language-Yaml codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># NoteÔºöSince uncontrollable factors of the certificate, the new port currently only supports forwarding from 10264 of Yurt-Tunnel-Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dnat-ports-pair: 9051=10264 # add port=10264(Only support port 10264 to forward)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: yurt-tunnel-server-cfg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: kube-system</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/openyurtio/openyurt.io/edit/master/docs/core-concepts/yurttunnel.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-01-23T07:05:14.000Z">1/23/2022</time></b> by <b>BLAKECHIANG4</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/v0.6.0/core-concepts/yurthub"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->YurtHub</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/v0.6.0/core-concepts/yurt-app-manager"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">YurtAppManager<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-background" class="table-of-contents__link toc-highlight">1. Background</a></li><li><a href="#2-reverse-channel" class="table-of-contents__link toc-highlight">2. Reverse Channel</a></li><li><a href="#3-implementation-mode" class="table-of-contents__link toc-highlight">3. Implementation Mode</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation/summary">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/v0.6.0/core-concepts/">DingTalk (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://47.242.50.237/login" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>OpenYurt Experience Center<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright ¬© 2022 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
<script src="/assets/js/runtime~main.4409c719.js"></script>
<script src="/assets/js/main.22786535.js"></script>
</body>
</html>