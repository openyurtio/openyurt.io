<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-v1.3 docs-doc-page docs-doc-id-core-concepts/yurttunnel" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">YurtTunnel | OpenYurt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openyurt.io/docs/v1.3/core-concepts/yurttunnel"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.3"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.3"><meta data-rh="true" name="docsearch:version" content="v1.3"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.3"><meta data-rh="true" property="og:title" content="YurtTunnel | OpenYurt"><meta data-rh="true" name="description" content="1. Background"><meta data-rh="true" property="og:description" content="1. Background"><link data-rh="true" rel="icon" href="/img/openyurt.ico"><link data-rh="true" rel="canonical" href="https://openyurt.io/docs/v1.3/core-concepts/yurttunnel"><link data-rh="true" rel="alternate" href="https://openyurt.io/docs/v1.3/core-concepts/yurttunnel" hreflang="en"><link data-rh="true" rel="alternate" href="https://openyurt.io/zh/docs/v1.3/core-concepts/yurttunnel" hreflang="zh"><link data-rh="true" rel="alternate" href="https://openyurt.io/docs/v1.3/core-concepts/yurttunnel" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://&lt;NEW_APP_ID&gt;-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenYurt Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/opensearch.xml">


<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
<link rel="icon" type="image/png" href="/favicons/favicon.png">
<link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" color="#ffffff" href="/favicons/safari-pinned-tab.svg">
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-config" content="/favicons/browserconfig.xml"><link rel="stylesheet" href="/assets/css/styles.b92cb5b2.css">
<script src="/assets/js/runtime~main.1fc8c968.js" defer="defer"></script>
<script src="/assets/js/main.b1bdcb7f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/openyurt.ico"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OpenYurt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/team">Team</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/v1.3/core-concepts/yurttunnel">v1.3</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/core-concepts/yurttunnel">Next</a></li><li><a class="dropdown__link" href="/docs/core-concepts/yurttunnel">v1.4</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v1.3/core-concepts/yurttunnel">v1.3</a></li><li><a class="dropdown__link" href="/docs/v1.2/core-concepts/yurttunnel">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/core-concepts/yurttunnel">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/core-concepts/yurttunnel">v1.0</a></li><li><a class="dropdown__link" href="/docs/v0.7.0/core-concepts/yurttunnel">v0.7.0</a></li><li><a class="dropdown__link" href="/docs/v0.6.0/core-concepts/yurttunnel">v0.6.0</a></li><li><a class="dropdown__link" href="/docs/v0.5.0/core-concepts/yurttunnel">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/v1.3/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh/docs/v1.3/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->OpenYurt<!-- --> <b>v1.3</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/core-concepts/yurttunnel">latest version</a></b> (<!-- -->v1.4<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: v1.3</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>YurtTunnel</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-background">1. Background<a href="#1-background" class="hash-link" aria-label="Direct link to 1. Background" title="Direct link to 1. Background">​</a></h2>
<p>During application deployment and maintenance, users often need to obtain application logs, or directly log in to the running environment of the application for debugging. In Kubernetes cluster, we usually use <code>kubectl log</code>, <code>kubectl exec</code> and other command to debug. As following picture, on <code>kubelet</code> will act as a server, responsible for processing requests forwarded by <code>kube-apiserver</code> (KAS), which requires a network path between <code>KAS</code> and <code>kubelet</code> to allow <code>KAS</code> to actively access <code>kubelet</code>.</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/kubectl-4a135b776e4058dae26cb98067a28d99.jpg" width="1570" height="464" class="img_ev3q"></p>
<p>Cloud and edge are in different network domains, and edge nodes are inside the firewall. The cloud (center) edge collaborative architecture will lead to the following challenges in the maintenance monitoring capabilities of the native K8s system:</p>
<ul>
<li>K8s native maintenance capabilities are lacking (such as <code>kubectl logs/exec</code> cannot be executed)</li>
<li>Community monitoring maintenance components cannot work (such as Prometheus/metrics-server)</li>
</ul>
<p>In order to support the maintenance of edge applications through cloud nodes, we must establish a reverse maintenance tunnel between the cloud and the edge.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-reverse-tunnel">2. Reverse Tunnel<a href="#2-reverse-tunnel" class="hash-link" aria-label="Direct link to 2. Reverse Tunnel" title="Direct link to 2. Reverse Tunnel">​</a></h2>
<p>In <code>OpenYurt</code>, we introduced a special component <code>YurtTunnel</code> to deal with the cloud-side communication. <code>Reverse tunnel</code> is a common way to solve cross-network communication, and <code>YurtTunnel</code> is also a <code>reverse tunnel</code>. It is a typical C/S structure component, consisting of <code>Yurt-Tunnel-Server</code> deployed in the cloud and <code>Yurt-Tunnel-Agent</code> deployed on edge nodes. The deployment structure of YurtTunnel is following picture. The whole workflow of the <code>reverse tunnel</code> has the following steps:</p>
<ul>
<li>Deploy <code>Yurt-Tunnel-Server</code> on the management and control network plane.</li>
<li><code>Yurt-Tunnel-Server</code> opens an IP accessible from the public network.</li>
<li>Deploy a <code>Yurt-Tunnel-Agent</code> on each edge node, and establish a long connection with the Server through the Server&#x27;s public IP.</li>
<li>Access requests from the management and control components to edge nodes will be forwarded to <code>Yurt-Tunnel-Server</code>.</li>
<li><code>Yurt-Tunnel-Server</code> sends the request to the target node through the long connection.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/tunnel_arch-f5523df0a26022bbc4a94960802f2c40.jpg" width="2128" height="1142" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-implementation">3. Implementation<a href="#3-implementation" class="hash-link" aria-label="Direct link to 3. Implementation" title="Direct link to 3. Implementation">​</a></h2>
<p>To create a secure, non-intrusive, and scalable reverse tunnel in the K8s cloud-edge architecture, it needs to include at least the following three capabilities.</p>
<ul>
<li>Tunnel</li>
<li>Self-management of certificates at both ends of the tunnel</li>
<li>Cloud component requests are forwarded to the tunnel</li>
</ul>
<p>Architecture of <code>YurtTunnel</code> is as follows:</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/tunnel_components-98b2297c73ddbafee663f1dacf5ec19d.jpg" width="2016" height="1576" class="img_ev3q"></p>
<ol>
<li>Tunnel</li>
</ol>
<p>When the <code>Yurt-Tunnel-Agent</code> on the edge starts up, it will establish a connection and register with the <code>Yurt-Tunnel-Server</code> according to the access address, and periodically check the health status of the connection and rebuild the connection.</p>
<p><code>Yurt-Tunnel-Agent</code> registered is as follows：</p>
<div class="language-Plain language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentID&quot;: {NodeName}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentIdentifiers&quot;: ipv4={nodeIP}&amp;host={NodeName}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>When <code>Yurt-Tunnel-Server</code> receives a request from a cloud component, it needs to forward the request to the <code>Yurt-Tunnel-Agent</code>. Because in addition to forwarding the request, the <code>session</code> is followed by data return or continuous data forwarding (such as <code>kubectl exec</code> ). So it is necessary to forward data in both directions. At the same time, it is necessary to support concurrent forwarding of requests from cloud components, which means that an unique ID needs to be established for each request life cycle. So there are two designs.</li>
</ul>
<p>Option 1: The initial cloud-side connection only informs the forwarding request, and <code>Yurt-Tunnel-Agent</code> will establish a new connection with the cloud to process the request. Through the new connection, the problem of requesting unique ID can be resolved, and concurrency can also be resolved. But a connection needs to be established for each request, which will consume a lot of resources.</p>
<p>Option 2: Only the initial cloud-edge connection is used to forward requests. In order to reuse the same connection for a large number of requests, it is necessary to encapsulate each request and add an unique ID to solve the concurrent forwarding. At the same time, since a connection needs to be reused, it is necessary to decouple connection management and request lifecycle management. That is to manage the transition of request forwarding. This option involves packet and unpacket, request processing state machine, etc. The option will be a little more complicated.</p>
<ul>
<li>The <code>ANP</code> component selected by OpenYurt adapts the above option 2, which also satisfies our original design intention.</li>
<li>Request forwarding is encapsulated in <code>Packet_DialRequest</code> and <code>Packet_DialResponse</code>, where <code>Packet_DialResponse.ConnectID</code> is used to identify <code>request</code>, which is like <code>requestID</code> in <code>tunnel</code>. The request and data are encapsulated in <code>Packet_Data</code>. <code>Packet_CloseRequest</code> and <code>Packet_CloseResponse</code> are used to forward and recycle resource. For details, please refer to the following sequence diagram:</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/tunnel_sequence_diag-385d8a83150e7246026538e7948dd738.jpg" width="1080" height="997" class="img_ev3q"></p>
<ul>
<li>
<p><code>RequestInterceptor</code> module</p>
<p>It can be seen from the above analysis that before <code>Yurt-Tunnel-Server</code> forwards the request, the client needs to make an <code>Http Connect</code> request to create a forwarding path. However, it is difficult to do some work for open source components such as <code>Prometheus</code> and <code>metrics-server</code>. Therefore, a request hijacking module <code>Interceptor</code> is added to <code>Yurt-Tunnel-Server</code> to make <code>Http Connect</code> requests.</p>
</li>
</ul>
<ol start="2">
<li>Certificate management</li>
</ol>
<p>In order to keep long and secure communication of cloud-edge, and also to support https request forwarding, <code>YurtTunnel</code> needs to generate its own certificate and maintain the automatic rotation of the certificate. The details are as follows:</p>
<div class="language-Plain language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 1. Yurt-Tunnel-Server server certificate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/cmd/yurt-tunnel-server/app/start.go#L120-L139</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- certificate path: /var/lib/yurt-tunnel-server/pki/yurt-tunnel-server-xxx.pem</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- SignerName: &quot;kubernetes.io/kubelet-serving&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;system:node:tunnel-server&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;system:nodes&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Subject Alternate Name values: {x-tunnel-server-svc, x-tunnel-server-internal-svc的ips和dns names}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: [&quot;key encipherment&quot;, &quot;digital signature&quot;, &quot;server auth&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 2. tunnel proxy client certificate: is used by yurt-tunnel-server in order to make connection with components on edge nodes(like kubelet) for forwarding requests.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/cmd/yurt-tunnel-server/app/start.go#L146-L152</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- certificate path: /var/lib/yurt-tunnel-server/pki/yurt-tunnel-server-proxy-client-xxx.pem</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- SignerName: &quot;kubernetes.io/kube-apiserver-client&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;tunnel-proxy-client&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;openyurt:yurttunnel&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: [&quot;key encipherment&quot;, &quot;digital signature&quot;, &quot;client auth&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 3. Yurt-Tunnel-Agent client certificate：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/cmd/yurt-tunnel-agent/app/start.go#L99-L107</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- certificate path: /var/lib/yurt-tunnel-agent/pki/yurt-tunnel-agent-xxx.pem</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- SignerName: &quot;kubernetes.io/kube-apiserver-client&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;tunnel-agent-client&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;openyurt:yurttunnel&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: [&quot;key encipherment&quot;, &quot;digital signature&quot;, &quot;client auth&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 4. Yurt-tunnel Certificate Signing Request (CSR) is approved by Yurt-Controller-Manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/controller/certificates/csrapprover.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 5. certificate automatic rotation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/client-go/util/certificate/certificate_manager.go#L224</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>transfer cloud component requests to the tunnel</li>
</ol>
<p>Because the request of the cloud component needs to be forwarded to the <code>Yurt-Tunnel-Server</code>, it also means that no modification to the cloud component is required. So it is necessary to analyze the requests of cloud components. Currently the maintenance requests of components have the following two types:</p>
<ul>
<li>type 1: access using IP address, such as: <code>http://{nodeIP}:{port}/{path}</code></li>
<li>type 2: access using domain name, such as: <code>http://{NodeName}:{port}/{path}</code></li>
</ul>
<p>Different solutions need to be adopted for different types of requests.</p>
<p>Solution 1: Use iptables dnat rules to ensure that type 1 requests are forwarded to <code>Yurt-Tunnel-Server</code></p>
<div class="language-Shell language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># iptables rules code: https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/iptables/iptables.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># The iptables dnat rules maintained by Yurt-Tunnel-Server are as follows:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* edge tunnel server port */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10255  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10255 /* jump to port 10255 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10250  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10250 /* jump to port 10250 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:10255 to:172.16.6.156:10264</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Solution 2: Use dns domain name to resolve NodeName as the access address of Yurt-Tunnel-Server, so that type 2 requests can be forwarded to yurt-tunnel. Its working principle is as follows:</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/tunnel_dns-3f45c486b188e1dd9e5b254ba516e10f.jpg" width="2582" height="1358" class="img_ev3q"></p>
<ul>
<li><code>Yurt-Tunnel-Server</code> maintains two Service addresses：<!-- -->
<ul>
<li>x-tunnel-server-svc: expose port 10262/10263 used to access from the public networkYurt-Tunnel-Server. Such as Yurt-Tunnel-Agent</li>
<li>x-tunnel-server-internal-svc: cloud components is accessed from the internal network, such as prometheus, metrics-server</li>
</ul>
</li>
<li><code>Yurt-Tunnel-Server</code> has a DNS Controller, dynamically configures Core DNS Host records, and maintains the mapping relationship between NodeName and IP (Cloud Node is directly reachable according to IP, directly mapped to Node IP; Edge Node needs to communicate through the Tunnel tunnel agent, mapping to the cluster ip of <code>Yurt-Tunnel-Server</code> Internal Service)</li>
<li>When the cloud component accesses the Edge node through NodeName, it will do domain name resolution through CoreDNS by default, and the request for the Edge Node will be directed to the ClusterIP of the internal service of <code>Yurt-Tunnel-Server</code>, and then use the forwarding ability of kube-proxy to forward the request Load balancing to healthy Yurt-Tunnel-Server Pods</li>
<li><code>Yurt-Tunnel-Server</code> will check the requested Host. When the Host is NodeName, it will find the correct Agent backend through the node name and forward the data</li>
</ul>
<ol start="4">
<li>port extension</li>
</ol>
<p>If users need to access other ports(like 9051 for http requests) on the edge (other than 10250 and 10255), they need to add dnat rules in iptables or add port mapping in x-tunnel-server-internal-svc, as shown following:</p>
<div class="language-Shell language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># For example, access port 9051 of the edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add iptables dnat rule:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-9051  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9051 /* jump to port 9051 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:9051 to:172.16.6.156:10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add port mapping in x-tunnel-server-internal-svc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10250</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10263</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: dnat-9051 # add port mapping</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above iptables dnat rules and service port mapping are automatically updated by <code>Yurt-Tunnel-Server</code>. Users only need to add port configuration in <code>yurt-tunnel-server-cfg</code> configmap in <code>kube-system</code>. details as follows:</p>
<div class="language-Yaml language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">http-proxy-ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;9051&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># ports for HTTP requests </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">https-proxy-ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># ports for HTTPs requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yurt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">tunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/openyurtio/openyurt.io/edit/master/docs/core-concepts/yurttunnel.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-04-24T21:34:16.000Z" itemprop="dateModified">Apr 24, 2025</time></b> by <b>Ihor Sychevskyi</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-background" class="table-of-contents__link toc-highlight">1. Background</a></li><li><a href="#2-reverse-tunnel" class="table-of-contents__link toc-highlight">2. Reverse Tunnel</a></li><li><a href="#3-implementation" class="table-of-contents__link toc-highlight">3. Implementation</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/installation/summary">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/v1.3/core-concepts/">DingTalk (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright © 2025 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
</body>
</html>